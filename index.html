<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MODIFIED: Version Bump to 4.01 -->
    <title>Ellis Web Bell 4.01</title>
    <!-- SVG Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24%22 fill=%22%232563EB%22><path d=%22M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2 2z%22/></svg>">
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Questrial as a web-safe fallback
                        sans: ['Century Gothic', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Updated Google Font to include Questrial as a Century Gothic fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
    <style>
        body {
            /* Apply the new font stack */
            font-family: 'Century Gothic', 'Questrial', 'sans-serif';
        }
        /* Styles for Admin Controls */
        /* Hide admin controls and shared delete/edit buttons by default */
        .admin-control, .delete-btn, .edit-btn {
            display: none;
        }
        /* When body has .admin-mode, show them */
        body.admin-mode .admin-control,
        body.admin-mode .delete-btn,
        body.admin-mode .edit-btn {
            display: inline-block; 
        }

        /* Always show custom delete/edit buttons */
        .delete-custom-btn,
        .edit-custom-btn {
            display: inline-block;
        }

        /* Sound override button is always visible for shared bells */
        .sound-btn {
            display: inline-block;
        }
        /* Hide sound override button for custom bells (they use 'Edit') */
        .sound-custom-btn {
            display: none;
        }
        
        /* NEW v4.00: Show admin buttons within period headers */
        body.admin-mode .period-admin-controls {
            display: flex;
        }

        /* Fix for modal z-index issues */
        #edit-bell-modal { z-index: 50; }
        #change-sound-modal { z-index: 50; }
        #nearby-bell-modal { z-index: 55; }
        #confirm-delete-bell-modal { z-index: 55; }
        #confirm-delete-audio-modal { z-index: 55; }
        #confirm-delete-modal { z-index: 55; } /* Shared Schedule Delete */
        
        /* NEW v4.00: Z-indexes for period modals */
        #edit-period-modal { z-index: 51; }
        #confirm-delete-period-modal { z-index: 56; }
        
        /* DELETED v4.00: Removed complex conflict modal z-indexes */

        /* v3.03 logic */
        #create-personal-schedule-modal { z-index: 50; }
        #confirm-delete-personal-modal { z-index: 55; }
        
        /* v3.05 */
        #confirm-restore-modal { z-index: 55; }
        
        /* Hide file input, style the button */
        #import-file-input, #audio-upload-input, #restore-file-input {
            display: none;
        }

        /* Hide elements that require non-anonymous auth */
        .auth-required {
            display: none;
        }
        /* When authenticated AND not anonymous, show them */
        body.authenticated.not-anonymous .auth-required {
            display: block;
        }

        /* Admin-only elements, hidden by default */
        .admin-only {
            display: none;
        }
        /* Show when in admin mode */
        body.admin-mode .admin-only {
            display: inline-flex; /* Use inline-flex to work with flex properties */
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <!-- Auth/Welcome Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-lg shadow-xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-700 mb-4">Welcome to the Ellis Web Bell!</h2>
            <p class="text-gray-600 mb-8">Please sign in to load and sync schedules.</p>
            <div class="space-y-4">
                <button id="google-start-btn" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 font-medium rounded-lg shadow-md border border-gray-200 hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48">
                        <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.28 6.42C12.92 13.9 18.06 9.5 24 9.5z"></path>
                        <path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 2.73-2.2 5.08-4.79 6.69l7.38 5.71C44.97 36.3 46.98 30.8 46.98 24.55z"></path>
                        <path fill="#FBBC05" d="M10.84 28.71C10.22 26.9 9.83 24.99 9.83 23c0-1.99.39-3.9 1.01-5.71L2.56 10.8C.9 14.28 0 18.48 0 23c0 4.52.9 8.72 2.56 12.2l8.28-6.49z"></pa
                        <path fill="#EA4335" d="M24 48c5.4 0 10.32-1.62 14.34-4.38l-7.38-5.71C28.71 40.5 26.47 42.1 24 42.1c-5.94 0-11.08-4.4-12.96-10.28L2.56 38.2C6.51 46.04 14.62 48 24 48z"></path>
                        <path fill="none" d="M0 0h48v48H0z"></path>
                    </svg>
                    Sign in with Google
                </button>
                <button id="anonymous-start-btn" class="w-full px-6 py-3 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                    Continue Anonymously
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Start Overlay -->
    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors text-center">
            Loading...
        </button>
    </div>
    
    <!-- DELETED v4.00: Add Bell to Multiple Schedules Modal -->
    <!-- This feature is incompatible with the new period-based data structure -->


    <!-- Edit Bell Modal (Admin / Custom) -->
    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="edit-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <option value="Alarm">Alarm</option>
                        <option value="ellisBell.mp3" selected>Ellis Bell</option>
                    </optgroup>
                    <optgroup label="My Sounds" id="edit-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="edit-shared-sounds-optgroup"></optgroup>
                </select>
            </div>
            
            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- **** NEW v4.00: Edit Period Modal **** -->
    <div id="edit-period-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-period-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Period</h3>
            <div>
                <label for="edit-period-name" class="block text-sm font-medium text-gray-700">Period Name</label>
                <input type="text" id="edit-period-name" placeholder="e.g. 1st Period" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-period-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- **** NEW v4.00: Confirm Delete Period Modal **** -->
    <div id="confirm-delete-period-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Period</h3>
            <p id="confirm-delete-period-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-period-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-period-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Change Bell SOUND Modal (All Users) -->
    <div id="change-sound-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="change-sound-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Change Bell Sound</h3>
            
            <!-- Bell Info (Read-only) -->
            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <p class="text-sm font-medium text-gray-700">Bell:</p>
                <p id="change-sound-bell-name" class="text-lg font-semibold text-gray-900"></p>
                <p id="change-sound-bell-time" class="text-lg font-semibold text-gray-900"></p>
            </div>

            <!-- Sound Select -->
            <div>
                <label for="change-sound-select" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="change-sound-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <option value="Alarm">Alarm</option>
                        <option value="ellisBell.mp3" selected>Ellis Bell</option>
                    </optgroup>
                    <optgroup label="My Sounds" id="change-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="change-shared-sounds-optgroup"></optgroup>
                </select>
            </div>

            <!-- Warning Message -->
            <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 rounded">
                <p class="text-sm text-yellow-800">Are you sure you want to change this bell's sound? Your sound should be a brief but obvious indication of transition.</p>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="change-sound-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="change-sound-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Sound</button>
            </div>
        </form>
    </div>

    <!-- DELETED v4.00: Confirm Linked Edit Modal -->
    <!-- This feature is incompatible with the new period-based data structure -->


    <!-- Confirm Delete Schedule Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete BELL Modal -->
    <div id="confirm-delete-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Bell</h3>
            <p id="confirm-delete-bell-text" class="text-gray-700 mb-6">Are you sure you want to delete this bell?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-bell-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete AUDIO Modal -->
    <div id="confirm-delete-audio-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Delete Audio File</h3>
            <p id="confirm-delete-audio-text" class="text-gray-700 mb-4">Are you sure you want to delete this audio file?</p>
            
            <ul id="confirm-delete-audio-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-1 bg-gray-50 mb-6">
                <!-- Linked bells will be injected here -->
            </ul>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-audio-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-audio-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Anyway</button>
            </div>
        </div>
    </div>

    <!-- Nearby Bell Warning Modal (Simplified for v4.00) -->
    <div id="nearby-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Nearby Bell Detected</h3>
            <p class="text-gray-700 mb-6">A bell named "<strong id="nearby-bell-name">...</strong>" is already scheduled for <strong id="nearby-bell-time">...</strong> within this period. This is very close to your new time.</p>
            
            <p id="nearby-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <!-- Controls (now used for both shared and custom) -->
            <div id="nearby-bell-custom-controls" class="mt-6 flex justify-end gap-3">
                <button type="button" id="nearby-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="nearby-bell-add-anyway" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell Anyway</button>
            </div>
        </div>
    </div>

    <!-- DELETED v4.00: All v3.02 complex conflict modals removed -->
    <!-- (internal-conflict-warning-modal, internal-conflict-confirm-modal, external-conflict-modal) -->


    <!-- Personal Schedule Modals -->
    <div id="create-personal-schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="create-personal-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">New Personal Schedule</h3>
            
            <p class="text-gray-700 mb-4">
                Base Schedule: <strong id="personal-base-schedule-name">...</strong>
            </p>
            
            <div>
                <label for="new-personal-schedule-name" class="block text-sm font-medium text-gray-700">New Schedule Name</label>
                <input type="text" id="new-personal-schedule-name" placeholder="e.g. My A-Day Schedule" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <p id="create-personal-schedule-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="create-personal-schedule-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Create</button>
            </div>
        </form>
    </div>

    <!-- Confirm Delete Personal Schedule Modal -->
    <div id="confirm-delete-personal-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Personal Schedule</h3>
            <p id="confirm-delete-personal-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-personal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-personal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Restore Personal Schedule Modal -->
    <div id="confirm-restore-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Overwrite Personal Schedule</h3>
            <p id="confirm-restore-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="restore-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="restore-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Overwrite</button>
            </div>
        </div>
    </div>


    <!-- Main Application -->
    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <!-- MODIFIED: Version Bump -->
            <h1 class="text-4xl font-bold text-blue-700">Ellis Web Bell 4.01</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>
            
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <p id="user-display-name" class="text-gray-700"></p>
                <button id="signout-btn" class="w-full sm:w-auto px-4 py-1 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors hidden">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Countdown Card -->
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-md mb-8">
            <div class="text-center">
                <div id="live-clock-sentence" class="text-2xl font-medium text-gray-600 tabular-nums">
                    Loading...
                </div>
                <div id="countdown-display" class="text-6xl md:text-8xl font-bold text-gray-800 tabular-nums my-2">
                    --:--
                </div>
                <div id="next-bell-sentence" class="text-2xl font-medium text-gray-600">
                    until the next bell.
                </div>
            </div>

            <div class="text-center text-gray-500 text-lg mt-6">
                Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
            </div>
        </div>

        <!-- Quick Bell Section -->
        <div id="quickBellControls" class="p-4 bg-white rounded-xl shadow-md mb-8 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center space-x-3 flex-shrink-0">
                <span class="font-semibold text-gray-700">Quick Bell:</span>
                <div class="flex flex-wrap gap-2">
                    <button data-minutes="1" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">1</button>
                    <button data-minutes="2" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">2</button>
                    <button data-minutes="3" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">3</button>
                    <button data-minutes="5" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">5</button>
                    <button data-minutes="10" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">10</button>
                    <button data-minutes="15" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">15</button>
                </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink min-w-0 w-full sm:w-auto">
                <label for="quickBellSoundSelect" class="text-sm font-medium text-gray-700">Sound:</label>
                <select id="quickBellSoundSelect" class="w-full truncate px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <option value="Alarm">Alarm</option>
                        <option value="ellisBell.mp3" selected>Ellis Bell</option>
                    </optgroup>
                    <optgroup label="My Sounds" id="quick-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="quick-shared-sounds-optgroup"></optgroup>
                </select>
            </div>
        </div>


        <!-- MODIFIED v4.00: Combined Bell Schedule List -->
        <div>
            <div class="flex justify-between items-center mb-4">
                 <h2 id="schedule-title" class="text-2xl font-semibold">Current Schedule</h2>
                 <div class="flex-shrink-0 flex gap-2">
                     <button id="mute-all-list-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Mute All</button>
                     <button id="unmute-all-list-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Unmute All</button>
                 </div>
            </div>
            <!-- This div is now a container for period "cards" -->
            <div id="combined-bell-list" class="space-y-6 mb-8">
                <!-- Periods and bells will be injected here by JavaScript -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-8 text-center text-gray-500">
                        Loading schedule...
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Selector -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-lg font-medium text-gray-700">Active Schedule</label>
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors opacity-50 cursor-not-allowed" disabled title="Sign in to see admin options">
                    Toggle Admin
                </button>
            </div>
            <select id="schedule-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">Loading schedules...</option>
            </select>
            
            <button id="create-personal-schedule-btn" class="auth-required w-full mt-4 px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Copy as Personal Schedule
            </button>
        </div>
        

        <!-- NEW v4.00: Admin Zone (Refactored) -->
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>
            
            <!-- Create New Schedule Form (Unchanged) -->
            <form id="create-schedule-form">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Shared Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <!-- NEW: Add Period to THIS Schedule Form -->
            <form id="add-period-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Period to This Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="shared-period-name" placeholder="e.g. 1st Period" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Period
                    </button>
                </div>
                <p id="add-period-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- NEW: Add Bell to Period Form -->
            <form id="add-bell-to-period-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to a Period</label>
                
                <!-- Period Selector -->
                <div class="mb-4">
                     <label for="shared-period-select" class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                     <select id="shared-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                         <option value="">Select a schedule to see periods</option>
                     </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <optgroup label="Default Sounds">
                                <option value="Bell">Bell</option>
                                <option value="Chime">Chime</option>
                                <option value="Beep">Beep</option>
                                <option value="Alarm">Alarm</option>
                                <option value="ellisBell.mp3" selected>Ellis Bell</option>
                            </optgroup>
                            <optgroup label="My Sounds" id="shared-my-sounds-optgroup"></optgroup>
                            <optgroup label="Shared Sounds" id="shared-shared-sounds-optgroup"></optgroup>
                        </select>
                    </div>
                    <button type="button" id="preview-shared-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview" disabled>
                        &#9654;
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- DELETED v4.00: Add Bell to Schedules Button -->
            <!-- This feature is incompatible with the new period-based data structure -->

            <!-- Delete Selected Schedule Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                <button type="button" id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Delete Selected Schedule
                </button>
            </div>

            <!-- Import/Export Section -->
            <div class="border-t pt-6 space-y-4">
                <h4 class="text-lg font-medium text-gray-800">Backup & Restore</h4>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Export All Schedules</label>
                    <button type="button" id="export-schedules-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Download Backup (JSON)
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Import & Overwrite Schedules</label>
                    <input type="file" id="import-file-input" accept="application/json">
                    <button type="button" id="import-schedules-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                        Upload Backup (JSON)
                    </button>
                    <p id="import-status" class="text-blue-600 text-sm mt-2 hidden"></p>
                </div>
            </div>

        </div>


        <!-- MODIFIED v4.00: Personal Bells (Refactored) -->
        <div class="auth-required mt-12">
            <h2 class="text-2xl font-semibold mb-4">My Personal Bells (Cloud Synced)</h2>

            <!-- NEW: Add Personal Period Form -->
            <form id="add-personal-period-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Period to This Personal Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="personal-period-name" placeholder="e.g. My Reminders" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Period
                    </button>
                </div>
                <p id="add-personal-period-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- NEW: Add Bell to Personal Period Form -->
            <form id="add-bell-to-personal-period-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <p id="personal-bell-status" class="text-sm text-gray-600 mb-4">Select a Personal Schedule from the dropdown above to manage its periods and bells.</p>
                
                <!-- Period Selector -->
                <div class="mb-4">
                     <label for="personal-period-select" class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                     <select id="personal-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                         <option value="">Select a personal schedule</option>
                     </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="personal-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="personal-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                    <div>
                        <label for="personal-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="personal-bell-name" placeholder="e.g. My Reminder" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="personal-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="personal-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <optgroup label="Default Sounds">
                                <option value="Bell">Bell</option>
                                <option value="Chime">Chime</option>
                                <option value="Beep">Beep</option>
                                <option value="Alarm">Alarm</option>
                                <option value="ellisBell.mp3" selected>Ellis Bell</option>
                            </optgroup>
                            <optgroup label="My Sounds" id="personal-my-sounds-optgroup"></optgroup>
                            <optgroup label="Shared Sounds" id="personal-shared-sounds-optgroup"></optgroup>
                        </select>
                    </div>
                    <button type="button" id="preview-personal-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview" disabled>
                        &#9654;
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Personal Bell
                    </button>
                </div>
            </form>
            
            <!-- Personal Schedule Manager (Unchanged) -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">My Personal Schedule Manager</h3>
                
                <div class="space-y-3">
                    <button type="button" id="rename-personal-schedule-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Rename Selected Personal Schedule
                    </button>
                    
                    <button type="button" id="backup-personal-schedule-btn" class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Back up Selected Personal Schedule
                    </button>
                    
                    <button type="button" id="restore-personal-schedule-btn" class="w-full px-4 py-2 bg-yellow-500 text-black font-medium rounded-lg shadow-md hover:bg-yellow-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Load/Overwrite Selected from Backup
                    </button>

                    <div class="border-t pt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Personal Schedule</label>
                        <button type="button" id="delete-personal-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Delete Selected Personal Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Audio Manager Panel (Unchanged) -->
        <div id="audio-manager-panel" class="auth-required mt-12">
            <h2 class="text-2xl font-semibold mb-4 cursor-pointer" title="Click to refresh file lists">My Audio Manager</h2>
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
                
                <!-- Audio Upload Form -->
                <div>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Upload New Audio File</h3>
                    <p class="text-sm text-gray-600 mb-4">Files must be under 1MB. (Supports .mp3, .wav, .m4a, .ogg)</p>
                    <input type="file" id="audio-upload-input" accept=".mp3,.wav,.m4a,.ogg">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label for="audio-upload-input" class="w-full sm:w-auto cursor-pointer px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors text-center">
                            Choose File...
                        </label>
                        <span id="audio-file-name" class="text-gray-700 sm:mt-2">No file chosen.</span>
                    </div>
                    <button type="button" id="audio-upload-btn" class="mt-3 w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50" disabled>
                        Upload Audio
                    </button>
                    <p id="audio-upload-status" class="text-blue-600 text-sm mt-3 hidden"></p>
                </div>

                <!-- My Audio Files List -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">My Audio Files</h3>
                    <div id="my-audio-files-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

                <!-- Shared Audio Files List -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Shared Audio Files</h3>
                    <div id="shared-audio-files-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer for User ID and Credit -->
        <footer class="text-center p-4 mt-8 text-gray-500 text-sm border-t border-gray-200">
            <p class="mb-2">Web app enhanced by Google Gemini</p>
            <p>
                <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code>
            </p>
        </footer>
        
        <!-- Hidden file input for restore -->
        <input type="file" id="restore-file-input" class="hidden" accept="application/json,.json">

    </div>

        <!-- Firebase and App Logic -->
        <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signOut, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, writeBatch, setLogLevel, deleteDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll, getMetadata, updateMetadata, getBytes } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- DOM Elements ---
        const welcomeOverlay = document.getElementById('welcome-overlay');
        const audioOverlay = document.getElementById('audio-overlay');
        const startAudioBtn = document.getElementById('start-audio-btn');
        
        const googleStartBtn = document.getElementById('google-start-btn');
        const anonymousStartBtn = document.getElementById('anonymous-start-btn');
        
        const countdownElement = document.getElementById('countdown-display');
        const clockElement = document.getElementById('live-clock-sentence');
        const statusElement = document.getElementById('status-message');
        const nextBellElement = document.getElementById('next-bell-sentence');
        const userIdElement = document.getElementById('userIdDisplay');
        const userDisplayNameElement = document.getElementById('user-display-name');
        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleTitle = document.getElementById('schedule-title');
        const adminToggleBtn = document.getElementById('admin-toggle');

        // Quick Bell Elements
        const quickBellControls = document.getElementById('quickBellControls');
        const quickBellSoundSelect = document.getElementById('quickBellSoundSelect');

        // MODIFIED v4.00: Personal Bell/Period Forms
        const addPersonalPeriodForm = document.getElementById('add-personal-period-form');
        const personalPeriodNameInput = document.getElementById('personal-period-name');
        const addPersonalPeriodStatus = document.getElementById('add-personal-period-status');
        
        const addBellToPersonalPeriodForm = document.getElementById('add-bell-to-personal-period-form');
        const personalPeriodSelect = document.getElementById('personal-period-select');
        const personalTimeInput = document.getElementById('personal-bell-time');
        const personalNameInput = document.getElementById('personal-bell-name'); 
        const personalSoundInput = document.getElementById('personal-bell-sound');
        const personalBellStatus = document.getElementById('personal-bell-status');
        const previewPersonalSoundBtn = document.getElementById('preview-personal-sound');
        const deletePersonalScheduleBtn = document.getElementById('delete-personal-schedule-btn');

        // Combined List
        const combinedBellListElement = document.getElementById('combined-bell-list');
        
        // MODIFIED v4.00: Admin Zone Forms
        const addPeriodForm = document.getElementById('add-period-form');
        const sharedPeriodNameInput = document.getElementById('shared-period-name');
        const addPeriodStatus = document.getElementById('add-period-status');
        
        const addBellToPeriodForm = document.getElementById('add-bell-to-period-form');
        const sharedPeriodSelect = document.getElementById('shared-period-select');
        const sharedTimeInput = document.getElementById('shared-bell-time');
        const sharedNameInput = document.getElementById('shared-bell-name');
        const sharedSoundInput = document.getElementById('shared-bell-sound');
        const previewSharedSoundBtn = document.getElementById('preview-shared-sound');
        const addSharedStatus = document.getElementById('add-shared-status');
        
        // DELETED v4.00: Multi-Add Bell Modal Elements
        
        // Edit Bell Modal
        const editBellModal = document.getElementById('edit-bell-modal');
        const editBellForm = document.getElementById('edit-bell-form');
        const editBellTimeInput = document.getElementById('edit-bell-time');
        const editBellNameInput = document.getElementById('edit-bell-name');
        const editBellSoundInput = document.getElementById('edit-bell-sound');
        const editBellCancelBtn = document.getElementById('edit-bell-cancel');
        const editBellSubmitBtn = document.getElementById('edit-bell-submit');
        const editBellStatus = document.getElementById('edit-bell-status');

        // NEW v4.00: Edit Period Modal
        const editPeriodModal = document.getElementById('edit-period-modal');
        const editPeriodForm = document.getElementById('edit-period-form');
        const editPeriodNameInput = document.getElementById('edit-period-name');
        const editPeriodCancelBtn = document.getElementById('edit-period-cancel');

        // NEW v4.00: Delete Period Modal
        const confirmDeletePeriodModal = document.getElementById('confirm-delete-period-modal');
        const confirmDeletePeriodText = document.getElementById('confirm-delete-period-text');
        const deletePeriodConfirmBtn = document.getElementById('delete-period-confirm');
        const deletePeriodCancelBtn = document.getElementById('delete-period-cancel');

        // Change Sound Modal
        const changeSoundModal = document.getElementById('change-sound-modal');
        const changeSoundForm = document.getElementById('change-sound-form');
        const changeSoundBellName = document.getElementById('change-sound-bell-name');
        const changeSoundBellTime = document.getElementById('change-sound-bell-time');
        const changeSoundSelect = document.getElementById('change-sound-select');
        const changeSoundCancelBtn = document.getElementById('change-sound-cancel');

        // DELETED v4.00: Linked Edit Modal Elements

        // Create/Delete Schedule
        const createScheduleForm = document.getElementById('create-schedule-form');
        const newScheduleNameInput = document.getElementById('new-schedule-name');
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteText = document.getElementById('confirm-delete-text');
        const deleteConfirmBtn = document.getElementById('delete-confirm');
        const deleteCancelBtn = document.getElementById('delete-cancel'); 

        // Create/Delete Personal Schedule
        const createPersonalScheduleBtn = document.getElementById('create-personal-schedule-btn');
        const createPersonalScheduleModal = document.getElementById('create-personal-schedule-modal');
        const createPersonalScheduleForm = document.getElementById('create-personal-schedule-form');
        const personalBaseScheduleName = document.getElementById('personal-base-schedule-name');
        const newPersonalScheduleNameInput = document.getElementById('new-personal-schedule-name');
        const createPersonalScheduleStatus = document.getElementById('create-personal-schedule-status');
        const createPersonalScheduleCancelBtn = document.getElementById('create-personal-schedule-cancel');
        const confirmDeletePersonalModal = document.getElementById('confirm-delete-personal-modal');
        const confirmDeletePersonalText = document.getElementById('confirm-delete-personal-text');
        const deletePersonalConfirmBtn = document.getElementById('delete-personal-confirm');
        const deletePersonalCancelBtn = document.getElementById('delete-personal-cancel');

        // Personal Schedule Manager Buttons
        const renamePersonalScheduleBtn = document.getElementById('rename-personal-schedule-btn');
        const backupPersonalScheduleBtn = document.getElementById('backup-personal-schedule-btn');
        const restorePersonalScheduleBtn = document.getElementById('restore-personal-schedule-btn');
        const restoreFileInput = document.getElementById('restore-file-input');
        
        // Restore Modal
        const confirmRestoreModal = document.getElementById('confirm-restore-modal');
        const confirmRestoreText = document.getElementById('confirm-restore-text');
        const restoreConfirmBtn = document.getElementById('restore-confirm');
        const restoreCancelBtn = document.getElementById('restore-cancel');

        // Delete Bell Modal
        const confirmDeleteBellModal = document.getElementById('confirm-delete-bell-modal');
        const confirmDeleteBellText = document.getElementById('confirm-delete-bell-text');
        const deleteBellConfirmBtn = document.getElementById('delete-bell-confirm');
        const deleteBellCancelBtn = document.getElementById('delete-bell-cancel');

        // Delete Audio Modal
        const confirmDeleteAudioModal = document.getElementById('confirm-delete-audio-modal');
        const confirmDeleteAudioText = document.getElementById('confirm-delete-audio-text');
        const confirmDeleteAudioList = document.getElementById('confirm-delete-audio-list');
        const deleteAudioConfirmBtn = document.getElementById('delete-audio-confirm');
        const deleteAudioCancelBtn = document.getElementById('delete-audio-cancel');

        // Nearby Bell Warning Modal (Simplified)
        const nearbyBellModal = document.getElementById('nearby-bell-modal');
        const nearbyBellName = document.getElementById('nearby-bell-name');
        const nearbyBellTime = document.getElementById('nearby-bell-time');
        const nearbyBellStatus = document.getElementById('nearby-bell-status');
        const nearbyBellCustomControls = document.getElementById('nearby-bell-custom-controls');
        const nearbyBellCancelBtn = document.getElementById('nearby-bell-cancel');
        const nearbyBellAddAnywayBtn = document.getElementById('nearby-bell-add-anyway');
        
        // DELETED v4.00: All v3.02 complex conflict modal elements

        // Import/Export Elements
        const exportSchedulesBtn = document.getElementById('export-schedules-btn');
        const importSchedulesBtn = document.getElementById('import-schedules-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importStatus = document.getElementById('import-status');

        // Audio Manager Elements
        const audioUploadInput = document.getElementById('audio-upload-input');
        const audioFileName = document.getElementById('audio-file-name');
        const audioUploadBtn = document.getElementById('audio-upload-btn');
        const audioUploadStatus = document.getElementById('audio-upload-status');
        const myAudioFilesList = document.getElementById('my-audio-files-list');
        const sharedAudioFilesList = document.getElementById('shared-audio-files-list');

        const signOutBtn = document.getElementById('signout-btn');

        // Admin Email List
        const ADMIN_EMAIL_LIST = [
           'jacob.v.wilson@gmail.com'
           // Add more emails here in the future
        ];

        // --- App State ---
        let db, auth, storage;
        let userId;
        let isUserAnonymous = true;
        
        // MODIFIED v4.00: State for Period-based structure
        let baseSchedule = null; // Holds { id, name, periods: [] } of the active base shared schedule
        let personalSchedule = null; // Holds { id, name, baseScheduleId, periods: [] } of the active personal schedule
        
        let scheduleRef; // Firestore ref for base schedule
        let schedulesCollectionRef; // Firestore ref for all shared schedules
        let allSchedules = []; // Array of *all* shared schedules (still needed for selector)
        let allPersonalSchedules = []; // Array of *user's* personal schedules (still needed for selector)
        let activeBaseScheduleId = null; 
        let activePersonalScheduleId = null;
        let activeScheduleListenerUnsubscribe = null; 
        let activePersonalScheduleListenerUnsubscribe = null;
        let personalSchedulesListenerUnsubscribe = null;
        
        let synths = {}; 
        let lastBellRingTime = null; 
        let lastRingTimestamp = 0;
        const RING_COOLDOWN = 5000;
        let clockIntervalId = null; 
        
        let currentEditingBell = null; // MODIFIED v4.00: Will now include { periodId, periodType }
        let currentEditingPeriod = null; // NEW v4.00: For editing a period
        let currentChangingSoundBell = null; 
        let bellToDelete = null; // MODIFIED v4.00: Will now include { periodId, periodType }
        let periodToDelete = null; // NEW v4.00: For deleting a period
        let audioToDelete = null; 

        // MODIFIED v4.00: Renamed pendingPersonalBell to pendingBell
        let pendingBell = null; // Used by nearby-bell-modal for { bell, periodId, periodType }
        
        // DELETED v4.00: All complex conflict state
        
        let pendingRestoreData = null;

        // Quick Bell State
        let quickBellEndTime = null;
        let quickBellSound = 'ellisBell.mp3'; 

        let mutedBellIds = new Set(); 
        let bellSoundOverrides = {}; 

        let appId; 
        let isAudioReady = false; 
        
        // Audio file state
        let userAudioFiles = []; // { name, url, path }
        let sharedAudioFiles = []; // { name, url, path }
        let fileToUpload = null; 
        const MAX_FILE_SIZE = 1024 * 1024; // 1MB

        // --- Mute Helper Functions ---
        function getBellId(bell) {
            if (!bell || !bell.type || !bell.time || !bell.name) return null;
            const safeName = bell.name.replace(/"/g, '&quot;');
            return `${bell.type}-${bell.time}-${safeName}`;
        }

        function loadMutedBells() {
            try {
                const stored = localStorage.getItem('mutedBellIds');
                if (stored) {
                    mutedBellIds = new Set(JSON.parse(stored));
                    console.log(`Loaded ${mutedBellIds.size} muted bell IDs.`);
                }
            } catch (e) {
                console.error("Failed to load muted bells", e);
                mutedBellIds = new Set();
            }
        }

        function saveMutedBells() {
            try {
                localStorage.setItem('mutedBellIds', JSON.stringify([...mutedBellIds]));
            } catch (e) {
                console.error("Failed to save muted bells", e);
            }
        }

        // --- Sound Override Functions ---
        function getBellOverrideKey(scheduleId, bell) {
            if (!scheduleId || !bell) return null;
            if (bell.type !== 'shared') return null;
            const bellId = getBellId(bell);
            if (!bellId) return null;
            return `${scheduleId}-${bellId}`;
        }

        function loadSoundOverrides() {
            try {
                const stored = localStorage.getItem('bellSoundOverrides');
                if (stored) {
                    bellSoundOverrides = JSON.parse(stored);
                    console.log(`Loaded ${Object.keys(bellSoundOverrides).length} sound overrides.`);
                }
            } catch (e) {
                console.error("Failed to load sound overrides", e);
                bellSoundOverrides = {};
            }
        }

        function saveSoundOverrides() {
            try {
                localStorage.setItem('bellSoundOverrides', JSON.stringify(bellSoundOverrides));
            } catch (e) {
                console.error("Failed to save sound overrides", e);
            }
        }

        // Helper to format 24h time to 12h AM/PM
        function formatTime12Hour(timeString) {
            if (!timeString) return "--:--";
            
            try {
                const parts = timeString.split(':');
                if (parts.length < 2) return timeString; 

                let [hours, minutes, seconds] = parts;
                hours = parseInt(hours, 10);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                
                if (seconds) {
                    return `${hours}:${minutes}:${seconds} ${ampm}`;
                } else {
                    return `${hours}:${minutes} ${ampm}`;
                }
            } catch (e) {
                console.error("Error formatting time:", e);
                return timeString; // Fallback to original
            }
        }

        // --- NEW v4.00: Data Migration Logic ---
        /**
         * Converts a v3 schedule (flat bells array) to a v4 schedule (period-based).
         * @param {object} scheduleData - The raw data from Firestore
         * @returns {object} A v4-compatible schedule object { name, periods }
         */
        function migrateScheduleData(scheduleData) {
            if (!scheduleData) return { name: "Not Found", periods: [] };

            // If it *already* has periods, it's v4 data. Just return it.
            if (scheduleData.periods && Array.isArray(scheduleData.periods)) {
                // Ensure all periods have an ID
                const newPeriods = scheduleData.periods.map(p => ({
                    id: p.id || crypto.randomUUID(), // Add ID if missing
                    name: p.name,
                    bells: p.bells || []
                }));
                return { ...scheduleData, periods: newPeriods };
            }

            // If it has 'bells' but not 'periods', it's v3 data. Migrate it.
            if (scheduleData.bells && Array.isArray(scheduleData.bells)) {
                console.log(`Migrating v3 schedule: ${scheduleData.name}`);
                return {
                    ...scheduleData,
                    periods: [
                        {
                            id: 'general', // A consistent ID for the default migrated period
                            name: 'General Bells',
                            bells: scheduleData.bells
                        }
                    ]
                    // We don't delete scheduleData.bells, just in case
                };
            }

            // If it's a new or empty schedule, return a valid v4 structure
            return { ...scheduleData, periods: [] };
        }


        // --- Audio Setup (Tone.js) ---
        // MODIFIED v4.01: This function now starts the clock.
        async function startAudio() {
            if (isAudioReady) return;
            try {
                await Tone.start();
                console.log("AudioContext started.");
                setupSynths();
                isAudioReady = true;
                
                // --- MODIFICATION v4.01 ---
                // This function is now ONLY called by the button click (or if audio is already ready).
                // When it succeeds, we hide the overlay and START THE CLOCK.
                audioOverlay.classList.add('hidden');

                if (auth.currentUser) {
                    console.log("Audio ready, user signed in. Starting clock.");
                    if (clockIntervalId) clearInterval(clockIntervalId);
                    updateClock(); 
                    clockIntervalId = setInterval(updateClock, 1000);
                    statusElement.textContent = "Audio ready. Monitoring bells...";
                }
                // ---------------------------

            } catch (e) {
                console.error("Audio start failed:", e);
                statusElement.textContent = "Error starting audio. Please refresh.";
                // Let the button handler deal with the UI
                throw e; // Re-throw to be caught by the button listener
            }
        }

        function setupSynths() {
            // Setup default synths
            synths['Bell'] = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();

            synths['Chime'] = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }
            }).toDestination();

            synths['Beep'] = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.05 }
            }).toDestination();

            synths['Alarm'] = new Tone.MonoSynth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.2, release: 0.1 }
            }).toDestination();
            
            synths['ellisBell.mp3'] = new Tone.Player("ellisBell.mp3").toDestination();
        }

        async function playBell(soundName) {
            if (!isAudioReady) {
                console.warn("Audio not ready. Cannot play bell.");
                // We no longer try to start audio here, it must be started by the user first.
                return;
            }

            const now = Tone.now();

            // --- Handle HTTP URLs (Firebase Storage) ---
            if (soundName.startsWith('http')) {
                try {
                    // Case 1: Player is already cached (as a promise)
                    if (synths[soundName]) {
                        // The "synth" is a Promise that resolves to a Tone.Player
                        const player = await synths[soundName];
                        if (player.loaded) {
                            console.log(`Playing cached custom sound: ${soundName}`);
                            player.start(now);
                        } else {
                            console.warn(`Cached player for ${soundName} not loaded.`);
                            // Try to reload it
                            await player.load(soundName);
                            player.start(now);
                        }
                    } 
                    // Case 2: New sound, needs to be loaded and cached
                    else {
                        console.log(`Loading new custom sound: ${soundName}`);
                        // Store the *Promise* in the cache
                        const playerPromise = new Promise((resolve, reject) => {
                            const player = new Tone.Player({
                                url: soundName,
                                autostart: true,
                                onload: () => {
                                    console.log(`Successfully loaded and cached: ${soundName}`);
                                    resolve(player);
                                },
                                onerror: (err) => {
                                    console.error(`Error loading custom sound ${soundName}:`, err);
                                    reject(err);
                                }
                            }).toDestination();
                        });
                        
                        synths[soundName] = playerPromise;
                        await playerPromise; // Wait for it to load and play
                    }
                } catch (e) {
                    console.error(`Failed to load or play custom sound ${soundName}:`, e);
                    // Fallback to default Ellis bell
                    synths['ellisBell.mp3']?.start(now);
                }
            } 
            
            // --- Handle Default Synths ---
            else {
                console.log(`Playing default sound: ${soundName}`);
                const synth = synths[soundName] || synths['ellisBell.mp3'];
                
                if (synth instanceof Tone.Player) {
                    synth.start(now);
                } else if (synth instanceof Tone.MetalSynth) {
                    synth.triggerAttack(now);
                } else if (synth instanceof Tone.Synth) {
                    synth.triggerAttackRelease('C4', '8n', now);
                } else if (synth instanceof Tone.MonoSynth) {
                    synth.triggerAttackRelease('A4', '8n', now);
                }
            }
        }

        async function testSound(soundName) {
            if (!isAudioReady) {
                console.warn("Audio not ready. Cannot test sound.");
                try {
                    // This function is a user gesture, so try to start audio
                    await startAudio(); 
                    // startAudio will now handle starting the clock and hiding the overlay
                } catch (e) {
                    console.error("Failed to start audio for testSound");
                    statusElement.textContent = "Audio failed. Please click the overlay to retry.";
                    return;
                }
            }
            // After awaiting startAudio, isAudioReady should be true
            if (isAudioReady) {
                playBell(soundName);
            }
        }


        // --- Firebase & App Initialization ---
        async function initializeAppAndAuth() {
            try {
                // Get the app ID from the global variable (provided by Canvas)
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                console.log("App ID:", appId);

                // Get Firebase config from the global variable (provided by Canvas)
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config not found. App cannot start.");
                    statusElement.textContent = "Error: Config missing.";
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                setLogLevel('debug');

                // Get auth token from the global variable (provided by Canvas)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    console.log("Signing in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("No custom token found, signing in anonymously...");
                    await signInAnonymously(auth);
                }

                // Auth state listener will handle the rest
                setupAuthStateListener();

            } catch (error) {
                console.error("Error during initialization:", error);
                statusElement.textContent = "Initialization Error.";
                userIdElement.textContent = "Error";
                if (error.code === 'auth/invalid-custom-token') {
                    console.error("Invalid custom token. Signing in anonymously as fallback.");
                    await signInAnonymously(auth);
                }
            }
        }
        
        function setupAuthStateListener() {
            // MODIFIED v4.01: This function's clock logic is the core fix.
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isUserAnonymous = user.isAnonymous;
                    console.log("User authenticated:", userId, "Anonymous:", isUserAnonymous);

                    userIdElement.textContent = `User ID: ${userId}`;
                    signOutBtn.classList.remove('hidden');

                    if (isUserAnonymous) {
                        userDisplayNameElement.textContent = "Signed in as Anonymous";
                        adminToggleBtn.disabled = true;
                        adminToggleBtn.title = "Sign in with Google to use admin features";
                        document.body.classList.remove('not-anonymous');
                        document.body.classList.remove('authenticated');
                    } else {
                        userDisplayNameElement.textContent = `Signed in as ${user.displayName || user.email}`;
                        adminToggleBtn.disabled = false;
                        adminToggleBtn.title = "Toggle Admin Controls";
                        document.body.classList.add('not-anonymous');
                        document.body.classList.add('authenticated');
                        
                        // Check for admin status
                        if (ADMIN_EMAIL_LIST.includes(user.email)) {
                            document.body.classList.add('admin-mode');
                            adminToggleBtn.textContent = "Admin Mode: ON";
                            adminToggleBtn.classList.add('bg-blue-600', 'text-white');
                        }
                    }
                    
                    welcomeOverlay.classList.add('hidden');
                    
                    // --- MODIFIED v4.01: Audio Start Flow ---
                    if (!isAudioReady) {
                        audioOverlay.classList.remove('hidden');
                        startAudioBtn.textContent = "Click to Start Audio & Clock"; // v4.01 text
                        startAudioBtn.disabled = false;
                        statusElement.textContent = "Waiting for user to start audio...";
                        // We now WAIT for the user to click the button.
                        // The clock is NO LONGER started here.
                    } else {
                        // Audio already started (e.g. refresh), just start clock
                        console.log("Audio already ready, starting clock.");
                        if (clockIntervalId) clearInterval(clockIntervalId);
                        updateClock();
                        clockIntervalId = setInterval(updateClock, 1000);
                        statusElement.textContent = "Audio ready. Monitoring bells...";
                    }
                    // --- END MODIFICATION ---

                    // --- Load Data ---
                    loadMutedBells();
                    loadSoundOverrides();
                    await loadAllSchedules(); // Load all schedules for the dropdown
                    
                    // Get last selected schedule from localStorage
                    let lastSelectedScheduleId = localStorage.getItem('lastSelectedScheduleId');
                    
                    // Check if it's a personal schedule
                    if (lastSelectedScheduleId && lastSelectedScheduleId.startsWith('personal-')) {
                        activePersonalScheduleId = lastSelectedScheduleId;
                        activeBaseScheduleId = null; // Ensure base schedule isn't active
                    } 
                    // Check if it's a shared schedule
                    else if (lastSelectedScheduleId && allSchedules.some(s => s.id === lastSelectedScheduleId)) {
                        activeBaseScheduleId = lastSelectedScheduleId;
                        activePersonalScheduleId = null;
                    } 
                    // Fallback to first shared schedule
                    else if (allSchedules.length > 0) {
                        activeBaseScheduleId = allSchedules[0].id;
                        activePersonalScheduleId = null;
                        localStorage.setItem('lastSelectedScheduleId', activeBaseScheduleId);
                    } else {
                        console.warn("No schedules found.");
                        statusElement.textContent = "No schedules. Create one in the Admin Zone.";
                        activeBaseScheduleId = null;
                        activePersonalScheduleId = null;
                    }
                    
                    // Load personal schedules and update dropdown *after* loading shared
                    if (!isUserAnonymous) {
                        loadPersonalSchedules();
                    } else {
                        populateScheduleSelector(); // Populate with just shared schedules
                    }
                    
                    // Trigger the correct listener
                    if (activePersonalScheduleId) {
                        await listenToPersonalSchedule(activePersonalScheduleId);
                    } else if (activeBaseScheduleId) {
                        await listenToSchedule(activeBaseScheduleId);
                    }

                    // Load audio files
                    loadUserAudioFiles();
                    loadSharedAudioFiles();

                } else {
                    // User is signed out
                    userId = null;
                    isUserAnonymous = true;
                    console.log("User signed out.");
                    
                    // Reset UI
                    welcomeOverlay.classList.remove('hidden');
                    audioOverlay.classList.add('hidden');
                    signOutBtn.classList.add('hidden');
                    userDisplayNameElement.textContent = "";
                    userIdElement.textContent = "Not signed in";
                    document.body.classList.remove('admin-mode', 'authenticated', 'not-anonymous');
                    adminToggleBtn.disabled = true;
                    adminToggleBtn.textContent = "Toggle Admin";
                    
                    // Stop clock and clear data
                    if (clockIntervalId) clearInterval(clockIntervalId);
                    clockIntervalId = null;
                    clockElement.textContent = "Signed out.";
                    countdownElement.textContent = "--:--";
                    nextBellElement.textContent = "until the next bell.";
                    statusElement.textContent = "Signed out. Sign in to start.";
                    combinedBellListElement.innerHTML = '<div class="p-8 text-center text-gray-500">Please sign in to load schedules.</div>';
                    scheduleSelector.innerHTML = '<option value="">Please sign in</option>';
                    
                    // Clear state
                    allSchedules = [];
                    allPersonalSchedules = [];
                    baseSchedule = null;
                    personalSchedule = null;
                    if (activeScheduleListenerUnsubscribe) activeScheduleListenerUnsubscribe();
                    if (activePersonalScheduleListenerUnsubscribe) activePersonalScheduleListenerUnsubscribe();
                    if (personalSchedulesListenerUnsubscribe) personalSchedulesListenerUnsubscribe();
                }
            });
        }
        
        // --- Auth Button Handlers ---
        googleStartBtn.addEventListener('click', async () => {
            googleStartBtn.disabled = true;
            googleStartBtn.textContent = "Signing in...";
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest
                console.log("Google sign-in successful.");
            } catch (error) {
                console.error("Google sign-in error:", error);
                googleStartBtn.disabled = false;
                googleStartBtn.textContent = "Sign in with Google";
            }
        });

        anonymousStartBtn.addEventListener('click', async () => {
            anonymousStartBtn.disabled = true;
            anonymousStartBtn.textContent = "Signing in...";
            try {
                await signInAnonymously(auth);
                // onAuthStateChanged will handle the rest
                console.log("Anonymous sign-in successful.");
            } catch (error) {
                console.error("Anonymous sign-in error:", error);
                anonymousStartBtn.disabled = false;
                anonymousStartBtn.textContent = "Continue Anonymously";
            }
        });

        startAudioBtn.addEventListener('click', async () => {
            if (isAudioReady) return; 

            startAudioBtn.textContent = "Starting...";
            startAudioBtn.disabled = true;

            try {
                await startAudio(); 
                // startAudio() will hide the overlay and start the clock
                console.log("Audio started from button click.");
            } catch (e) {
                startAudioBtn.textContent = "Audio Failed. Please Refresh.";
                // Don't hide overlay
            }
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Sign out error:", error));
        });

        adminToggleBtn.addEventListener('click', () => {
            if (isUserAnonymous || !auth.currentUser) return;
            
            // Only admins can toggle
            if (!ADMIN_EMAIL_LIST.includes(auth.currentUser.email)) {
                adminToggleBtn.textContent = "Not Admin";
                adminToggleBtn.disabled = true;
                return;
            }

            const body = document.body;
            body.classList.toggle('admin-mode');
            
            if (body.classList.contains('admin-mode')) {
                adminToggleBtn.textContent = "Admin Mode: ON";
                adminToggleBtn.classList.add('bg-blue-600', 'text-white');
            } else {
                adminToggleBtn.textContent = "Admin Mode: OFF";
                adminToggleBtn.classList.remove('bg-blue-600', 'text-white');
            }
        });


        // --- Schedule Data Functions (MODIFIED v4.00) ---
        
        /**
         * Loads *all* shared schedules (just ID and name) for the selector.
         */
        async function loadAllSchedules() {
            try {
                const collectionPath = `artifacts/${appId}/public/schedules`;
                schedulesCollectionRef = collection(db, collectionPath);
                
                const snapshot = await getDocs(schedulesCollectionRef);
                allSchedules = snapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name || 'Untitled Schedule'
                }));
                allSchedules.sort((a, b) => a.name.localeCompare(b.name));
                console.log("Loaded all shared schedules:", allSchedules);
                
                // We call populateScheduleSelector later, after personal schedules are loaded
                
            } catch (error) {
                console.error("Error loading all schedules:", error);
                statusElement.textContent = "Error loading schedules.";
                allSchedules = [];
            }
        }

        /**
         * Loads *all* personal schedules for the user (just ID and name) for the selector.
         */
        async function loadPersonalSchedules() {
            if (isUserAnonymous) {
                console.log("Anonymous user, skipping personal schedule load.");
                populateScheduleSelector();
                return;
            }
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/personalSchedules`;
                const personalSchedulesCollectionRef = collection(db, collectionPath);

                // Stop any previous listener
                if (personalSchedulesListenerUnsubscribe) personalSchedulesListenerUnsubscribe();
                
                // Listen for real-time updates
                personalSchedulesListenerUnsubscribe = onSnapshot(personalSchedulesCollectionRef, (snapshot) => {
                    allPersonalSchedules = snapshot.docs.map(doc => ({
                        id: doc.id,
                        name: doc.data().name || 'Untitled Personal'
                    }));
                    allPersonalSchedules.sort((a, b) => a.name.localeCompare(b.name));
                    console.log("Loaded/updated personal schedules:", allPersonalSchedules);
                    
                    // Now update the main dropdown
                    populateScheduleSelector();
                    
                    // Check if the *active* personal schedule was deleted
                    if (activePersonalScheduleId && !allPersonalSchedules.some(s => s.id === activePersonalScheduleId)) {
                        console.warn("Active personal schedule was deleted. Reverting to base schedule.");
                        activePersonalScheduleId = null;
                        // Re-select the last active base schedule or the first one
                        const newActiveBaseId = localStorage.getItem('lastSelectedScheduleId') || (allSchedules.length > 0 ? allSchedules[0].id : null);
                        if (newActiveBaseId && !newActiveBaseId.startsWith('personal-')) {
                            scheduleSelector.value = newActiveBaseId;
                            handleScheduleChange();
                        }
                    }
                    
                }, (error) => {
                     console.error("Error listening to personal schedules:", error);
                });

            } catch (error) {
                console.error("Error loading personal schedules:", error);
                allPersonalSchedules = [];
                populateScheduleSelector(); // Populate with what we have
            }
        }
        
        /**
         * Listens to a single SHARED schedule for real-time updates.
         * @param {string} scheduleId - The ID of the shared schedule to listen to.
         */
        async function listenToSchedule(scheduleId) {
            console.log(`Listening to SHARED schedule: ${scheduleId}`);
            // Unsubscribe from any active listeners
            if (activeScheduleListenerUnsubscribe) activeScheduleListenerUnsubscribe();
            if (activePersonalScheduleListenerUnsubscribe) activePersonalScheduleListenerUnsubscribe();

            // Clear personal schedule state
            personalSchedule = null;
            activePersonalScheduleId = null;
            
            // Set active base schedule
            activeBaseScheduleId = scheduleId;
            localStorage.setItem('lastSelectedScheduleId', scheduleId);
            
            const docPath = `artifacts/${appId}/public/schedules/${scheduleId}`;
            scheduleRef = doc(db, docPath);

            activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (doc) => {
                if (doc.exists()) {
                    const scheduleData = doc.data();
                    // Migrate data if it's v3
                    baseSchedule = migrateScheduleData(scheduleData);
                    baseSchedule.id = doc.id;
                    
                    console.log("Shared schedule updated:", baseSchedule);
                    
                    // Update UI (since no personal schedule is overlayed)
                    renderCombinedBellList();
                    updateAdminForms();
                    
                    // Enable 'Copy' button
                    createPersonalScheduleBtn.disabled = false;

                } else {
                    console.error("Selected schedule does not exist.");
                    statusElement.textContent = "Error: Selected schedule not found.";
                    baseSchedule = null;
                    renderCombinedBellList(); // Will show 'Not Found'
                    updateAdminForms();
                }
            }, (error) => {
                console.error("Error listening to schedule:", error);
                statusElement.textContent = "Error loading schedule data.";
            });
        }
        
        /**
         * Listens to a single PERSONAL schedule for real-time updates.
         * @param {string} scheduleId - The ID of the personal schedule to listen to.
         */
        async function listenToPersonalSchedule(scheduleId) {
            if (isUserAnonymous) return;
            console.log(`Listening to PERSONAL schedule: ${scheduleId}`);
            
            // Unsubscribe from any active listeners
            if (activeScheduleListenerUnsubscribe) activeScheduleListenerUnsubscribe();
            if (activePersonalScheduleListenerUnsubscribe) activePersonalScheduleListenerUnsubscribe();
            
            // Clear base schedule (it will be loaded *by* the personal schedule)
            baseSchedule = null;
            activePersonalScheduleId = scheduleId;
            localStorage.setItem('lastSelectedScheduleId', scheduleId);

            const docPath = `artifacts/${appId}/users/${userId}/personalSchedules/${scheduleId}`;
            const personalScheduleRef = doc(db, docPath);

            activePersonalScheduleListenerUnsubscribe = onSnapshot(personalScheduleRef, async (doc) => {
                if (doc.exists()) {
                    const scheduleData = doc.data();
                    // Migrate personal data if it's v3
                    personalSchedule = migrateScheduleData(scheduleData);
                    personalSchedule.id = doc.id;
                    
                    console.log("Personal schedule updated:", personalSchedule);
                    
                    // NOW, load the base schedule it's based on
                    if (personalSchedule.baseScheduleId && personalSchedule.baseScheduleId !== activeBaseScheduleId) {
                        console.log(`Personal schedule references base: ${personalSchedule.baseScheduleId}`);
                        activeBaseScheduleId = personalSchedule.baseScheduleId;
                        
                        // Unsubscribe from old base listener
                        if (activeScheduleListenerUnsubscribe) activeScheduleListenerUnsubscribe();
                        
                        // Listen to the new base schedule
                        const baseDocPath = `artifacts/${appId}/public/schedules/${activeBaseScheduleId}`;
                        scheduleRef = doc(db, baseDocPath);

                        activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (baseDoc) => {
                             if (baseDoc.exists()) {
                                 const baseData = baseDoc.data();
                                 baseSchedule = migrateScheduleData(baseData);
                                 baseSchedule.id = baseDoc.id;
                                 console.log("Base schedule loaded for personal schedule:", baseSchedule);
                             } else {
                                 console.error("Base schedule not found!");
                                 baseSchedule = { id: activeBaseScheduleId, name: "Base Not Found", periods: [] };
                             }
                             // Re-render *after* base schedule is loaded/updated
                             renderCombinedBellList();
                             updateAdminForms();
                        }, (error) => {
                            console.error("Error loading base schedule:", error);
                            baseSchedule = { id: activeBaseScheduleId, name: "Base Error", periods: [] };
                            renderCombinedBellList();
                            updateAdminForms();
                        });
                        
                    } else if (personalSchedule.baseScheduleId === activeBaseScheduleId) {
                        // Base schedule already loaded and correct, just re-render
                        renderCombinedBellList();
                        updateAdminForms();
                    } else {
                        console.error("Personal schedule has no baseScheduleId!");
                        baseSchedule = { id: 'none', name: 'No Base', periods: [] };
                        renderCombinedBellList();
                        updateAdminForms();
                    }
                    
                    // Disable 'Copy' button (already a copy)
                    createPersonalScheduleBtn.disabled = true;

                } else {
                    console.error("Selected personal schedule does not exist.");
                    statusElement.textContent = "Error: Selected personal schedule not found.";
                    personalSchedule = null;
                    
                    // If the personal schedule is gone, fall back to base
                    const newActiveBaseId = localStorage.getItem('lastSelectedScheduleId') || (allSchedules.length > 0 ? allSchedules[0].id : null);
                    if (newActiveBaseId && !newActiveBaseId.startsWith('personal-')) {
                        scheduleSelector.value = newActiveBaseId;
                        handleScheduleChange();
                    } else if (allSchedules.length > 0) {
                        scheduleSelector.value = allSchedules[0].id;
                        handleScheduleChange();
                    }
                }
            }, (error) => {
                console.error("Error listening to personal schedule:", error);
                statusElement.textContent = "Error loading personal schedule data.";
            });
        }


        // --- UI Rendering (MODIFIED v4.00) ---
        
        /**
         * Fills the <select> dropdown with shared and personal schedules.
         */
        function populateScheduleSelector() {
            let currentSelection = scheduleSelector.value;
            
            // If nothing is selected, try to use the active IDs
            if (!currentSelection) {
                currentSelection = activePersonalScheduleId || activeBaseScheduleId;
            }
            
            scheduleSelector.innerHTML = ''; // Clear existing
            
            // Add Shared Schedules
            const sharedOptgroup = document.createElement('optgroup');
            sharedOptgroup.label = "Shared Schedules";
            if (allSchedules.length > 0) {
                allSchedules.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    sharedOptgroup.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = "No shared schedules found";
                option.disabled = true;
                sharedOptgroup.appendChild(option);
            }
            scheduleSelector.appendChild(sharedOptgroup);

            // Add Personal Schedules (if not anonymous)
            if (!isUserAnonymous && allPersonalSchedules.length > 0) {
                const personalOptgroup = document.createElement('optgroup');
                personalOptgroup.label = "My Personal Schedules";
                allPersonalSchedules.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id; // We'll use the ID, which we know is unique
                    option.textContent = s.name;
                    personalOptgroup.appendChild(option);
                });
                scheduleSelector.appendChild(personalOptgroup);
            }
            
            // Restore selection
            if (currentSelection) {
                scheduleSelector.value = currentSelection;
            }
        }
        
        /**
         * Renders the complete, combined list of periods and bells.
         */
        function renderCombinedBellList() {
            combinedBellListElement.innerHTML = ''; // Clear list

            if (!baseSchedule && !personalSchedule) {
                scheduleTitle.textContent = "No Schedule Loaded";
                combinedBellListElement.innerHTML = '<div class="bg-white rounded-xl shadow-md overflow-hidden"><div class="p-8 text-center text-gray-500">Select a schedule from the dropdown.</div></div>';
                return;
            }
            
            // Determine the "source" periods
            // We prioritize the personal schedule's periods if it exists
            const basePeriods = baseSchedule?.periods || [];
            const personalPeriods = personalSchedule?.periods || [];
            
            // If personal, use its name. If not, use base name.
            const activeScheduleName = personalSchedule?.name || baseSchedule?.name || "Untitled";
            scheduleTitle.textContent = activeScheduleName;
            
            // --- 1. Combine Shared Periods ---
            // Start with a copy of the base schedule's periods
            const combinedPeriods = basePeriods.map(p => ({
                ...p,
                periodType: 'shared', // Mark its origin
                bells: p.bells.map(b => ({
                    ...b,
                    type: 'shared', // Mark bell origin
                    periodId: p.id,
                    periodType: 'shared'
                }))
            }));
            
            // --- 2. Add Personal Periods ---
            // Add all periods from the personal schedule
            personalPeriods.forEach(p => {
                combinedPeriods.push({
                    ...p,
                    periodType: 'custom', // Mark its origin
                    bells: p.bells.map(b => ({
                        ...b,
                        type: 'custom', // Mark bell origin
                        periodId: p.id,
                        periodType: 'custom'
                    }))
                });
            });

            if (combinedPeriods.length === 0) {
                 combinedBellListElement.innerHTML = '<div class="bg-white rounded-xl shadow-md overflow-hidden"><div class="p-8 text-center text-gray-500">This schedule has no periods. Add one below!</div></div>';
                 return;
            }

            // --- 3. Sort and Render ---
            // Sort all bells *within* each period
            combinedPeriods.forEach(period => {
                period.bells.sort((a, b) => a.time.localeCompare(b.time));
            });
            
            // Render each period "card"
            combinedPeriods.forEach(period => {
                const periodCard = createPeriodCard(period, activeScheduleName);
                combinedBellListElement.appendChild(periodCard);
            });
        }
        
        /**
         * Creates the HTML for a single Period "card".
         * @param {object} period - The period object { id, name, periodType, bells }
         * @param {string} scheduleName - The name of the active schedule (for mute key)
         * @returns {HTMLElement} The populated <div> element for the period card.
         */
        function createPeriodCard(period, scheduleName) {
            const periodId = period.id;
            const periodType = period.periodType; // 'shared' or 'custom'
            
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow-md overflow-hidden";
            card.dataset.periodId = periodId;
            card.dataset.periodType = periodType;
            
            // --- Period Header ---
            const header = document.createElement('div');
            header.className = `flex justify-between items-center p-5 ${periodType === 'custom' ? 'bg-blue-50' : 'bg-gray-50'}`;
            
            const periodNameEl = document.createElement('h3');
            periodNameEl.className = "text-xl font-semibold text-gray-800";
            periodNameEl.textContent = period.name;
            
            // Admin controls for the period
            const periodAdminControls = document.createElement('div');
            periodAdminControls.className = "period-admin-controls flex-shrink-0 gap-2 hidden"; // Hidden by default
            
            const editPeriodBtn = document.createElement('button');
            editPeriodBtn.innerHTML = '&#9998;'; // Pencil
            editPeriodBtn.className = "px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200";
            editPeriodBtn.title = "Edit period name";
            editPeriodBtn.addEventListener('click', () => openEditPeriodModal(period));
            
            const deletePeriodBtn = document.createElement('button');
            deletePeriodBtn.innerHTML = '&#128465;'; // Trash
            deletePeriodBtn.className = "px-2 py-1 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200";
            deletePeriodBtn.title = "Delete period (and all its bells)";
            deletePeriodBtn.addEventListener('click', () => openDeletePeriodModal(period));
            
            // Only add admin buttons if it's the *correct* type
            // Admins edit shared periods, users edit custom periods
            if (periodType === 'shared') {
                periodAdminControls.appendChild(editPeriodBtn);
                periodAdminControls.appendChild(deletePeriodBtn);
            } else if (periodType === 'custom' && !isUserAnonymous) {
                // Anyone can edit/delete their *own* custom periods
                editPeriodBtn.classList.add('admin-control'); // Use same class to show/hide
                deletePeriodBtn.classList.add('admin-control');
                periodAdminControls.appendChild(editPeriodBtn);
                periodAdminControls.appendChild(deletePeriodBtn);
            }
            
            header.appendChild(periodNameEl);
            header.appendChild(periodAdminControls);
            card.appendChild(header);

            // --- Bells List ---
            const list = document.createElement('ul');
            list.className = "divide-y divide-gray-200";
            
            if (period.bells.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.className = "px-5 py-4 text-center text-gray-500";
                emptyLi.textContent = "No bells in this period.";
                list.appendChild(emptyLi);
            } else {
                period.bells.forEach(bell => {
                    const li = createBellListItem(bell, scheduleName);
                    list.appendChild(li);
                });
            }
            
            card.appendChild(list);
            return card;
        }

        /**
         * Creates the HTML for a single <li> bell item.
         * @param {object} bell - The bell object { time, name, sound, type, periodId, periodType }
         * @param {string} scheduleName - The name of the active schedule (for overrides)
         * @returns {HTMLElement} The populated <li> element.
         */
        function createBellListItem(bell, scheduleName) {
            const li = document.createElement('li');
            li.className = "px-5 py-4 flex items-center justify-between";
            
            const bellId = getBellId(bell);
            const isMuted = mutedBellIds.has(bellId);

            // Check for sound override (only for shared bells)
            let effectiveSound = bell.sound;
            if (bell.type === 'shared') {
                const overrideKey = getBellOverrideKey(activeBaseScheduleId, bell);
                if (bellSoundOverrides[overrideKey]) {
                    effectiveSound = bellSoundOverrides[overrideKey];
                }
            }

            // Bell Info (Time, Name, Sound)
            const infoDiv = document.createElement('div');
            infoDiv.className = "truncate";
            
            const timeEl = document.createElement('div');
            timeEl.className = `text-lg font-semibold ${isMuted ? 'text-gray-400 line-through' : 'text-gray-900'}`;
            timeEl.textContent = formatTime12Hour(bell.time);
            
            const nameEl = document.createElement('div');
            nameEl.className = `text-sm truncate ${isMuted ? 'text-gray-400 line-through' : 'text-gray-600'}`;
            nameEl.textContent = bell.name;

            const soundEl = document.createElement('div');
            soundEl.className = `text-xs mt-1 ${isMuted ? 'text-gray-400' : 'text-gray-500'}`;
            soundEl.textContent = `Sound: ${effectiveSound}`;
            
            infoDiv.appendChild(timeEl);
            infoDiv.appendChild(nameEl);
            infoDiv.appendChild(soundEl);
            
            // Bell Controls (Mute, Edit, Delete)
            const controlsDiv = document.createElement('div');
            controlsDiv.className = "flex-shrink-0 flex items-center gap-2 ml-4";
            
            // Mute Button (Always visible)
            const muteBtn = document.createElement('button');
            muteBtn.className = `text-2xl ${isMuted ? 'opacity-40' : 'opacity-80'} hover:opacity-100`;
            muteBtn.title = isMuted ? "Unmute this bell" : "Mute this bell";
            muteBtn.innerHTML = isMuted ? '&#128263;' : '&#128266;'; // Muted / Unmuted bell
            muteBtn.addEventListener('click', () => {
                if (isMuted) {
                    mutedBellIds.delete(bellId);
                } else {
                    mutedBellIds.add(bellId);
                }
                saveMutedBells();
                renderCombinedBellList(); // Re-render the whole list to update UI
            });
            controlsDiv.appendChild(muteBtn);

            // Test Sound Button (Always visible)
            const testBtn = document.createElement('button');
            testBtn.className = "text-xl opacity-60 hover:opacity-100 text-blue-600";
            testBtn.title = "Test sound";
            testBtn.innerHTML = '&#9654;'; // Play icon
            testBtn.addEventListener('click', () => testSound(effectiveSound));
            controlsDiv.appendChild(testBtn);

            // --- Type-Specific Buttons ---
            
            if (bell.type === 'shared') {
                // --- SHARED BELL ---
                
                // Sound Override Button (non-admin)
                const soundBtn = document.createElement('button');
                soundBtn.innerHTML = '&#127925;'; // Music note
                soundBtn.className = "sound-btn px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200";
                soundBtn.title = "Change sound (for you)";
                soundBtn.addEventListener('click', () => openChangeSoundModal(bell));
                controlsDiv.appendChild(soundBtn);
                
                // Edit Button (admin-only)
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '&#9998;'; // Pencil
                editBtn.className = "edit-btn px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200";
                editBtn.title = "Edit shared bell (Admin)";
                editBtn.addEventListener('click', () => openEditBellModal(bell));
                controlsDiv.appendChild(editBtn);

                // Delete Button (admin-only)
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&#128465;'; // Trash
                deleteBtn.className = "delete-btn px-2 py-1 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200";
                deleteBtn.title = "Delete shared bell (Admin)";
                deleteBtn.addEventListener('click', () => openDeleteBellModal(bell));
                controlsDiv.appendChild(deleteBtn);
                
            } else {
                // --- CUSTOM BELL --- (Personal Schedule)
                
                // Edit Button (always visible, but hidden/shown by admin-mode toggle)
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '&#9998;'; // Pencil
                editBtn.className = "edit-custom-btn admin-control px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200";
                editBtn.title = "Edit my personal bell";
                editBtn.addEventListener('click', () => openEditBellModal(bell));
                controlsDiv.appendChild(editBtn);

                // Delete Button (always visible, but hidden/shown by admin-mode toggle)
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&#128465;'; // Trash
                deleteBtn.className = "delete-custom-btn admin-control px-2 py-1 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200";
                deleteBtn.title = "Delete my personal bell";
                deleteBtn.addEventListener('click', () => openDeleteBellModal(bell));
                controlsDiv.appendChild(deleteBtn);
            }

            li.appendChild(infoDiv);
            li.appendChild(controlsDiv);
            return li;
        }

        /**
         * Updates the admin forms (and personal forms) based on the active schedule.
         */
        function updateAdminForms() {
            // --- Shared Period/Bell Forms (Admin Zone) ---
            if (baseSchedule) {
                // Enable "Add Period"
                const addPeriodSubmit = addPeriodForm.querySelector('button[type="submit"]');
                addPeriodSubmit.disabled = false;
                
                // Enable "Add Bell" form fields
                sharedPeriodSelect.disabled = false;
                sharedTimeInput.disabled = false;
                sharedNameInput.disabled = false;
                sharedSoundInput.disabled = false;
                previewSharedSoundBtn.disabled = false;
                addBellToPeriodForm.querySelector('button[type="submit"]').disabled = false;

                // Populate "Add Bell" period dropdown
                sharedPeriodSelect.innerHTML = '';
                if (baseSchedule.periods.length > 0) {
                    baseSchedule.periods.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        sharedPeriodSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No periods. Add one first.";
                    option.disabled = true;
                    sharedPeriodSelect.appendChild(option);
                    // Disable bell form if no periods
                    addBellToPeriodForm.querySelector('button[type="submit"]').disabled = true;
                }
                
            } else {
                // Disable all shared forms
                addPeriodForm.querySelector('button[type="submit"]').disabled = true;
                sharedPeriodSelect.disabled = true;
                sharedTimeInput.disabled = true;
                sharedNameInput.disabled = true;
                sharedSoundInput.disabled = true;
                previewSharedSoundBtn.disabled = true;
                addBellToPeriodForm.querySelector('button[type="submit"]').disabled = true;
                sharedPeriodSelect.innerHTML = '<option value="">Select a shared schedule</option>';
            }
            
            // --- Personal Period/Bell Forms ---
            if (personalSchedule) {
                // Enable "Add Personal Period"
                const addPersonalPeriodSubmit = addPersonalPeriodForm.querySelector('button[type="submit"]');
                addPersonalPeriodSubmit.disabled = false;
                
                // Enable "Add Personal Bell" form fields
                personalPeriodSelect.disabled = false;
                personalTimeInput.disabled = false;
                personalNameInput.disabled = false;
                personalSoundInput.disabled = false;
                previewPersonalSoundBtn.disabled = false;
                addBellToPersonalPeriodForm.querySelector('button[type="submit"]').disabled = false;
                personalBellStatus.textContent = "Select a period and add your personal bell.";


                // Populate "Add Personal Bell" period dropdown
                personalPeriodSelect.innerHTML = '';
                if (personalSchedule.periods.length > 0) {
                    personalSchedule.periods.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        personalPeriodSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No periods. Add one first.";
                    option.disabled = true;
                    personalPeriodSelect.appendChild(option);
                    // Disable bell form if no periods
                    addBellToPersonalPeriodForm.querySelector('button[type="submit"]').disabled = true;
                }
                
                // Enable personal schedule manager buttons
                renamePersonalScheduleBtn.disabled = false;
                backupPersonalScheduleBtn.disabled = false;
                restorePersonalScheduleBtn.disabled = false;
                deletePersonalScheduleBtn.disabled = false;

            } else {
                // Disable all personal forms
                addPersonalPeriodForm.querySelector('button[type="submit"]').disabled = true;
                personalPeriodSelect.disabled = true;
                personalTimeInput.disabled = true;
                personalNameInput.disabled = true;
                personalSoundInput.disabled = true;
                previewPersonalSoundBtn.disabled = true;
                addBellToPersonalPeriodForm.querySelector('button[type="submit"]').disabled = true;
                personalPeriodSelect.innerHTML = '<option value="">Select a personal schedule</option>';
                personalBellStatus.textContent = "Select a Personal Schedule from the dropdown above to manage its periods and bells.";
                
                // Disable personal schedule manager buttons
                renamePersonalScheduleBtn.disabled = true;
                backupPersonalScheduleBtn.disabled = true;
                restorePersonalScheduleBtn.disabled = true;
                deletePersonalScheduleBtn.disabled = true;
            }
        }
        
        // --- Schedule Dropdown Change Handler ---
        function handleScheduleChange() {
            const selectedId = scheduleSelector.value;
            if (!selectedId) return;

            console.log(`Schedule changed to: ${selectedId}`);
            
            if (allPersonalSchedules.some(s => s.id === selectedId)) {
                // It's a personal schedule
                listenToPersonalSchedule(selectedId);
            } else if (allSchedules.some(s => s.id === selectedId)) {
                // It's a shared schedule
                listenToSchedule(selectedId);
            } else {
                console.error("Selected schedule ID not found in any list:", selectedId);
            }
        }
        scheduleSelector.addEventListener('change', handleScheduleChange);


        // --- Clock and Countdown Logic ---
        function updateClock() {
            // Get current time from client
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US');
            const dateString = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            clockElement.textContent = `The time is ${timeString} on ${dateString}`;
            
            // --- Combine all bells ---
            let allBells = [];
            
            // 1. Add shared bells
            if (baseSchedule && baseSchedule.periods) {
                baseSchedule.periods.forEach(p => {
                    allBells.push(...p.bells.map(b => ({ ...b, type: 'shared' })));
                });
            }
            
            // 2. Add personal bells
            if (personalSchedule && personalSchedule.periods) {
                 personalSchedule.periods.forEach(p => {
                    allBells.push(...p.bells.map(b => ({ ...b, type: 'custom' })));
                });
            }

            // 3. Add Quick Bell (if active)
            if (quickBellEndTime && now.getTime() < quickBellEndTime) {
                allBells.push({
                    name: 'Quick Bell',
                    time: new Date(quickBellEndTime).toLocaleTimeString('en-US', { hour12: false }),
                    sound: quickBellSound,
                    type: 'quick'
                });
            } else if (quickBellEndTime && now.getTime() >= quickBellEndTime) {
                quickBellEndTime = null; // Clear expired quick bell
            }

            // --- Find Next Bell ---
            let nextBell = null;
            let minDiff = Infinity;
            
            const nowInSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            for (const bell of allBells) {
                const parts = bell.time.split(':');
                const bellTimeInSeconds = parseInt(parts[0], 10) * 3600 + parseInt(parts[1], 10) * 60 + (parseInt(parts[2], 10) || 0);

                let diff = bellTimeInSeconds - nowInSeconds;

                // If diff is negative, bell is for tomorrow
                if (diff <= 0) {
                    diff += 24 * 3600; // Add 24 hours in seconds
                }

                if (diff < minDiff) {
                    minDiff = diff;
                    nextBell = bell;
                }
            }

            // --- Update Countdown UI ---
            if (nextBell) {
                const hours = Math.floor(minDiff / 3600);
                const minutes = Math.floor((minDiff % 3600) / 60);
                const seconds = minDiff % 60;
                
                // Format for countdown display
                let countdownString = "";
                if (hours > 0) {
                    countdownString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    countdownString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                
                countdownElement.textContent = countdownString;
                nextBellElement.textContent = `until ${nextBell.name} (${formatTime12Hour(nextBell.time)})`;

                // --- Check for Bell Ring ---
                const bellId = getBellId(nextBell);
                const isMuted = mutedBellIds.has(bellId);
                const timeSinceLastRing = Date.now() - lastRingTimestamp;

                // Check if it's time to ring (minDiff is 0) and not muted
                if (minDiff === 0 && !isMuted && timeSinceLastRing > RING_COOLDOWN) {
                    
                    let soundToPlay = nextBell.sound;
                    
                    // Check for override if it's a shared bell
                    if (nextBell.type === 'shared') {
                        const overrideKey = getBellOverrideKey(activeBaseScheduleId, nextBell);
                        if (bellSoundOverrides[overrideKey]) {
                            soundToPlay = bellSoundOverrides[overrideKey];
                        }
                    }
                    
                    console.log(`Ringing bell: ${nextBell.name} with sound: ${soundToPlay}`);
                    playBell(soundToPlay);
                    
                    lastBellRingTime = nextBell.time; // Store the 24h time string
                    lastRingTimestamp = Date.now();
                    
                    // Flash countdown display
                    countdownElement.classList.add('text-green-500');
                    setTimeout(() => {
                        countdownElement.classList.remove('text-green-500');
                    }, 2000);
                }

            } else {
                countdownElement.textContent = "--:--";
                nextBellElement.textContent = "No bells scheduled.";
            }
        }
        
        
        // --- MODAL: Add/Edit/Delete Periods (NEW v4.00) ---
        
        // --- Add Shared Period ---
        addPeriodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!baseSchedule) return;
            
            const newPeriodName = sharedPeriodNameInput.value.trim();
            if (!newPeriodName) return;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            addPeriodStatus.textContent = "Adding...";
            addPeriodStatus.classList.remove('hidden');
            
            const newPeriod = {
                id: crypto.randomUUID(),
                name: newPeriodName,
                bells: []
            };
            
            try {
                const newPeriods = [...baseSchedule.periods, newPeriod];
                await updateDoc(scheduleRef, { periods: newPeriods });
                
                console.log("Shared period added:", newPeriod);
                sharedPeriodNameInput.value = '';
                addPeriodStatus.textContent = "Period added!";
                setTimeout(() => { addPeriodStatus.classList.add('hidden'); }, 2000);
                
            } catch (error) {
                console.error("Error adding shared period:", error);
                addPeriodStatus.textContent = "Error adding period.";
            } finally {
                btn.disabled = false;
            }
        });
        
        // --- Add Personal Period ---
        addPersonalPeriodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!personalSchedule) return;
            
            const newPeriodName = personalPeriodNameInput.value.trim();
            if (!newPeriodName) return;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            addPersonalPeriodStatus.textContent = "Adding...";
            addPersonalPeriodStatus.classList.remove('hidden');
            
            const newPeriod = {
                id: crypto.randomUUID(),
                name: newPeriodName,
                bells: []
            };
            
            try {
                const newPeriods = [...personalSchedule.periods, newPeriod];
                const personalScheduleRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`);
                await updateDoc(personalScheduleRef, { periods: newPeriods });
                
                console.log("Personal period added:", newPeriod);
                personalPeriodNameInput.value = '';
                addPersonalPeriodStatus.textContent = "Period added!";
                setTimeout(() => { addPersonalPeriodStatus.classList.add('hidden'); }, 2000);
                
            } catch (error) {
                console.error("Error adding personal period:", error);
                addPersonalPeriodStatus.textContent = "Error adding period.";
            } finally {
                btn.disabled = false;
            }
        });

        // --- Open Edit Period Modal ---
        function openEditPeriodModal(period) {
            currentEditingPeriod = period; // { id, name, periodType, bells }
            console.log("Editing period:", currentEditingPeriod);
            
            editPeriodNameInput.value = period.name;
            editPeriodModal.classList.remove('hidden');
        }
        
        editPeriodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentEditingPeriod) return;
            
            const newName = editPeriodNameInput.value.trim();
            if (!newName) return;
            
            const periodToUpdate = { ...currentEditingPeriod }; // copy
            periodToUpdate.name = newName;
            
            if (periodToUpdate.periodType === 'shared') {
                // --- Update SHARED period ---
                if (!baseSchedule) return;
                
                try {
                    const newPeriods = baseSchedule.periods.map(p => 
                        p.id === periodToUpdate.id ? periodToUpdate : p
                    );
                    await updateDoc(scheduleRef, { periods: newPeriods });
                    console.log("Shared period updated.");
                    
                } catch (error) {
                    console.error("Error updating shared period:", error);
                }
                
            } else if (periodToUpdate.periodType === 'custom') {
                // --- Update CUSTOM period ---
                if (!personalSchedule) return;
                
                try {
                    const newPeriods = personalSchedule.periods.map(p => 
                        p.id === periodToUpdate.id ? periodToUpdate : p
                    );
                    const personalScheduleRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`);
                    await updateDoc(personalScheduleRef, { periods: newPeriods });
                    console.log("Personal period updated.");
                    
                } catch (error) {
                    console.error("Error updating personal period:", error);
                }
            }
            
            closeEditPeriodModal();
        });
        
        function closeEditPeriodModal() {
            currentEditingPeriod = null;
            editPeriodModal.classList.add('hidden');
        }
        editPeriodCancelBtn.addEventListener('click', closeEditPeriodModal);

        // --- Open Delete Period Modal ---
        function openDeletePeriodModal(period) {
            periodToDelete = period; // { id, name, periodType, bells }
            console.log("Deleting period:", periodToDelete);
            
            confirmDeletePeriodText.textContent = `Are you sure you want to delete the period "${period.name}"? This will also delete all ${period.bells.length} bells inside it. This cannot be undone.`;
            confirmDeletePeriodModal.classList.remove('hidden');
        }
        
        deletePeriodConfirmBtn.addEventListener('click', async () => {
            if (!periodToDelete) return;
            
            const periodToDrop = { ...periodToDelete }; // copy
            periodToDelete = null; // Clear state
            
            if (periodToDrop.periodType === 'shared') {
                // --- Delete SHARED period ---
                if (!baseSchedule) return;
                try {
                    const newPeriods = baseSchedule.periods.filter(p => p.id !== periodToDrop.id);
                    await updateDoc(scheduleRef, { periods: newPeriods });
                    console.log("Shared period deleted.");
                } catch (error) {
                    console.error("Error deleting shared period:", error);
                }
                
            } else if (periodToDrop.periodType === 'custom') {
                // --- Delete CUSTOM period ---
                if (!personalSchedule) return;
                try {
                    const newPeriods = personalSchedule.periods.filter(p => p.id !== periodToDrop.id);
                    const personalScheduleRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`);
                    await updateDoc(personalScheduleRef, { periods: newPeriods });
                    console.log("Personal period deleted.");
                } catch (error) {
                    console.error("Error deleting personal period:", error);
                }
            }
            
            closeDeletePeriodModal();
        });

        function closeDeletePeriodModal() {
            periodToDelete = null;
            confirmDeletePeriodModal.classList.add('hidden');
        }
        deletePeriodCancelBtn.addEventListener('click', closeDeletePeriodModal);


        // --- MODAL: Add/Edit/Delete Bells (MODIFIED v4.00) ---
        
        // --- Add Shared Bell ---
        addBellToPeriodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!baseSchedule) return;
            
            const selectedPeriodId = sharedPeriodSelect.value;
            if (!selectedPeriodId) {
                showModalText(addSharedStatus, "Please select a period.");
                return;
            }
            
            const newBell = {
                name: sharedNameInput.value.trim(),
                time: sharedTimeInput.value,
                sound: sharedSoundInput.value
            };
            
            if (!newBell.name || !newBell.time) {
                showModalText(addSharedStatus, "Please fill in all fields.");
                return;
            }
            
            // Find the period this bell belongs to
            const targetPeriod = baseSchedule.periods.find(p => p.id === selectedPeriodId);
            if (!targetPeriod) {
                showModalText(addSharedStatus, "Error: Selected period not found.");
                return;
            }

            // Check for nearby bells *within this period*
            const nearby = findNearbyBell(newBell.time, targetPeriod.bells);
            if (nearby) {
                pendingBell = { bell: newBell, periodId: selectedPeriodId, periodType: 'shared' };
                openNearbyBellModal(nearby);
                return; // Stop here, wait for modal
            }
            
            // No conflict, proceed to add
            await addBellToPeriod(newBell, selectedPeriodId, 'shared');
        });
        
        previewSharedSoundBtn.addEventListener('click', () => {
            testSound(sharedSoundInput.value);
        });

        // --- Add Personal Bell ---
        addBellToPersonalPeriodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!personalSchedule) return;
            
            const selectedPeriodId = personalPeriodSelect.value;
            if (!selectedPeriodId) {
                showModalText(personalBellStatus, "Please select a period.");
                return;
            }
            
            const newBell = {
                name: personalNameInput.value.trim(),
                time: personalTimeInput.value,
                sound: personalSoundInput.value
            };
            
            if (!newBell.name || !newBell.time) {
                showModalText(personalBellStatus, "Please fill in all fields.");
                return;
            }
            
            // Find the period this bell belongs to
            const targetPeriod = personalSchedule.periods.find(p => p.id === selectedPeriodId);
            if (!targetPeriod) {
                showModalText(personalBellStatus, "Error: Selected period not found.");
                return;
            }
            
            // Check for nearby bells *within this period*
            const nearby = findNearbyBell(newBell.time, targetPeriod.bells);
            if (nearby) {
                pendingBell = { bell: newBell, periodId: selectedPeriodId, periodType: 'custom' };
                openNearbyBellModal(nearby);
                return; // Stop here, wait for modal
            }

            // No conflict, proceed to add
            await addBellToPeriod(newBell, selectedPeriodId, 'custom');
        });
        
        previewPersonalSoundBtn.addEventListener('click', () => {
            testSound(personalSoundInput.value);
        });
        
        
        /**
         * Generic function to add a bell to a period (shared or custom).
         * @param {object} bell - The new bell object { name, time, sound }
         * @param {string} periodId - The ID of the period to add to
         * @param {string} periodType - 'shared' or 'custom'
         */
        async function addBellToPeriod(bell, periodId, periodType) {
            
            let statusEl, formEl;
            
            if (periodType === 'shared') {
                if (!baseSchedule) return;
                statusEl = addSharedStatus;
                formEl = addBellToPeriodForm;

                try {
                    // Create a new periods array
                    const newPeriods = baseSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            const newBells = [...p.bells, bell];
                            return { ...p, bells: newBells };
                        }
                        return p;
                    });
                    
                    await updateDoc(scheduleRef, { periods: newPeriods });
                    console.log("Shared bell added.");
                    showModalText(statusEl, "Bell added!", true);
                    formEl.reset();
                    // Re-populate sound dropdowns
                    populateAllSoundDropdowns();
                    
                } catch (error) {
                    console.error("Error adding shared bell:", error);
                    showModalText(statusEl, "Error adding bell.");
                }
                
            } else if (periodType === 'custom') {
                if (!personalSchedule) return;
                statusEl = personalBellStatus;
                formEl = addBellToPersonalPeriodForm;
                
                try {
                    // Create a new periods array
                    const newPeriods = personalSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            const newBells = [...p.bells, bell];
                            return { ...p, bells: newBells };
                        }
                        return p;
                    });
                    
                    const personalScheduleRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`);
                    await updateDoc(personalScheduleRef, { periods: newPeriods });
                    
                    console.log("Personal bell added.");
                    showModalText(statusEl, "Bell added!", true);
                    formEl.reset();
                    // Re-populate sound dropdowns
                    populateAllSoundDropdowns();

                } catch (error) {
                    console.error("Error adding personal bell:", error);
                    showModalText(statusEl, "Error adding bell.");
                }
            }
        }
        
        
        // --- Nearby Bell Modal (Simplified) ---
        function findNearbyBell(newTime, bells) {
            const newTimeInSeconds = timeToSeconds(newTime);
            const NEARBY_THRESHOLD = 60; // 1 minute

            for (const bell of bells) {
                const bellTimeInSeconds = timeToSeconds(bell.time);
                const diff = Math.abs(newTimeInSeconds - bellTimeInSeconds);
                if (diff < NEARBY_THRESHOLD) {
                    return bell; // Found a nearby bell
                }
            }
            return null; // No nearby bells
        }
        
        function timeToSeconds(timeStr) {
            const [h, m, s] = timeStr.split(':').map(Number);
            return h * 3600 + m * 60 + (s || 0);
        }

        function openNearbyBellModal(nearbyBell) {
            nearbyBellName.textContent = nearbyBell.name;
            nearbyBellTime.textContent = formatTime12Hour(nearbyBell.time);
            nearbyBellStatus.classList.add('hidden');
            nearbyBellModal.classList.remove('hidden');
        }

        nearbyBellAddAnywayBtn.addEventListener('click', async () => {
            if (!pendingBell) return;
            
            showModalText(nearbyBellStatus, "Adding bell...");
            
            // Add the bell
            await addBellToPeriod(pendingBell.bell, pendingBell.periodId, pendingBell.periodType);
            
            // Clear state and close modal
            pendingBell = null;
            closeNearbyBellModal();
        });

        function closeNearbyBellModal() {
            pendingBell = null;
            nearbyBellModal.classList.add('hidden');
        }
        nearbyBellCancelBtn.addEventListener('click', closeNearbyBellModal);


        // --- Edit Bell Modal ---
        function openEditBellModal(bell) {
            // bell object now contains { time, name, sound, type, periodId, periodType }
            currentEditingBell = bell;
            console.log("Editing bell:", currentEditingBell);
            
            editBellTimeInput.value = bell.time;
            editBellNameInput.value = bell.name;
            editBellSoundInput.value = bell.sound;
            editBellStatus.classList.add('hidden');
            editBellSubmitBtn.disabled = false;
            
            editBellModal.classList.remove('hidden');
        }
        
        editBellForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentEditingBell) return;

            editBellSubmitBtn.disabled = true;
            showModalText(editBellStatus, "Saving...");
            
            const updatedBell = {
                name: editBellNameInput.value.trim(),
                time: editBellTimeInput.value,
                sound: editBellSoundInput.value
            };
            
            // This is the original bell's unique identifier
            const originalBellTime = currentEditingBell.time;
            const originalBellName = currentEditingBell.name;
            const periodId = currentEditingBell.periodId;
            const periodType = currentEditingBell.periodType;

            try {
                if (periodType === 'shared') {
                    // --- Update SHARED bell ---
                    if (!baseSchedule) throw new Error("Base schedule not loaded.");
                    
                    const newPeriods = baseSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            // Find and update the bell in this period
                            const newBells = p.bells.map(b => {
                                if (b.time === originalBellTime && b.name === originalBellName) {
                                    return updatedBell; // This is the updated one
                                }
                                return b; // This is an unchanged bell
                            });
                            return { ...p, bells: newBells };
                        }
                        return p; // This is an unchanged period
                    });
                    
                    await updateDoc(scheduleRef, { periods: newPeriods });
                    console.log("Shared bell updated.");
                    
                } else if (periodType === 'custom') {
                    // --- Update CUSTOM bell ---
                    if (!personalSchedule) throw new Error("Personal schedule not loaded.");
                    
                    const personalScheduleRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`);
                    
                    const newPeriods = personalSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            // Find and update the bell in this period
                            const newBells = p.bells.map(b => {
                                if (b.time === originalBellTime && b.name === originalBellName) {
                                    return updatedBell; // This is the updated one
                                }
                                return b; // This is an unchanged bell
                            });
                            return { ...p, bells: newBells };
                        }
                        return p; // This is an unchanged period
                    });
                    
                    await updateDoc(personalScheduleRef, { periods: newPeriods });
                    console.log("Personal bell updated.");
                }
                
                closeEditBellModal();
                
            } catch (error) {
                console.error("Error updating bell:", error);
                showModalText(editBellStatus, `Error: ${error.message}`);
                editBellSubmitBtn.disabled = false;
            }
        });

        function closeEditBellModal() {
            currentEditingBell = null;
            editBellModal.classList.add('hidden');
        }
        editBellCancelBtn.addEventListener('click', closeEditBellModal);


        // --- Change Sound Modal ---
        function openChangeSoundModal(bell) {
            // This is ONLY for shared bells
            if (bell.type !== 'shared') return;
            
            currentChangingSoundBell = bell;
            console.log("Changing sound for:", bell);
            
            changeSoundBellName.textContent = bell.name;
            changeSoundBellTime.textContent = formatTime12Hour(bell.time);
            
            // Get current override
            const overrideKey = getBellOverrideKey(activeBaseScheduleId, bell);
            const currentSound = bellSoundOverrides[overrideKey] || bell.sound;
            changeSoundSelect.value = currentSound;
            
            changeSoundModal.classList.remove('hidden');
        }
        
        changeSoundForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentChangingSoundBell || !activeBaseScheduleId) return;
            
            const newSound = changeSoundSelect.value;
            const overrideKey = getBellOverrideKey(activeBaseScheduleId, currentChangingSoundBell);
            
            if (overrideKey) {
                // If new sound is the default, *remove* the override
                if (newSound === currentChangingSoundBell.sound) {
                    delete bellSoundOverrides[overrideKey];
                    console.log("Sound override removed:", overrideKey);
                } else {
                    // Otherwise, set/update the override
                    bellSoundOverrides[overrideKey] = newSound;
                    console.log("Sound override set:", overrideKey, "to", newSound);
                }
                saveSoundOverrides();
                renderCombinedBellList(); // Re-render to show new sound
            }
            
            closeChangeSoundModal();
        });

        function closeChangeSoundModal() {
            currentChangingSoundBell = null;
            changeSoundModal.classList.add('hidden');
        }
        changeSoundCancelBtn.addEventListener('click', closeChangeSoundModal);

        
        // --- Delete Bell Modal ---
        function openDeleteBellModal(bell) {
            bellToDelete = bell; // { time, name, sound, type, periodId, periodType }
            console.log("Deleting bell:", bell);
            
            confirmDeleteBellText.textContent = `Are you sure you want to delete the bell "${bell.name}" at ${formatTime12Hour(bell.time)}?`;
            confirmDeleteBellModal.classList.remove('hidden');
        }

        deleteBellConfirmBtn.addEventListener('click', async () => {
            if (!bellToDelete) return;

            const bellToDrop = { ...bellToDelete }; // copy
            bellToDelete = null; // Clear state
            
            // This is the bell's unique identifier
            const originalBellTime = bellToDrop.time;
            const originalBellName = bellToDrop.name;
            const periodId = bellToDrop.periodId;
            const periodType = bellToDrop.periodType;

            try {
                if (periodType === 'shared') {
                    // --- Delete SHARED bell ---
                    if (!baseSchedule) throw new Error("Base schedule not loaded.");
                    
                    const newPeriods = baseSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            // Find and remove the bell in this period
                            const newBells = p.bells.filter(b => 
                                !(b.time === originalBellTime && b.name === originalBellName)
                            );
                            return { ...p, bells: newBells };
                        }
                        return p; // This is an unchanged period
                    });
                    
                    await updateDoc(scheduleRef, { periods: newPeriods });
                    console.log("Shared bell deleted.");
                    
                } else if (periodType === 'custom') {
                    // --- Delete CUSTOM bell ---
                    if (!personalSchedule) throw new Error("Personal schedule not loaded.");
                    
                    const personalScheduleRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`);
                    
                    const newPeriods = personalSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            // Find and remove the bell
                            const newBells = p.bells.filter(b => 
                                !(b.time === originalBellTime && b.name === originalBellName)
                            );
                            return { ...p, bells: newBells };
                        }
                        return p; // This is an unchanged period
                    });
                    
                    await updateDoc(personalScheduleRef, { periods: newPeriods });
                    console.log("Personal bell deleted.");
                }
                
                closeDeleteBellModal();
                
            } catch (error) {
                console.error("Error deleting bell:", error);
                closeDeleteBellModal();
            }
        });

        function closeDeleteBellModal() {
            bellToDelete = null;
            confirmDeleteBellModal.classList.add('hidden');
        }
        deleteBellCancelBtn.addEventListener('click', closeDeleteBellModal);

        
        // --- MODAL: Create/Delete Schedules ---
        
        // --- Create Shared Schedule (Admin) ---
        createScheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = newScheduleNameInput.value.trim();
            if (!name) return;

            try {
                const newScheduleData = {
                    name: name,
                    periods: [] // NEW v4.00: Always start with periods array
                };
                
                // Add to the public schedules collection
                const docRef = await addDoc(schedulesCollectionRef, newScheduleData);
                console.log("New shared schedule created:", docRef.id);
                
                newScheduleNameInput.value = '';
                
                // Reload all schedules to update dropdown
                await loadAllSchedules();
                // Repopulate dropdown (including personal ones)
                if (!isUserAnonymous) {
                    loadPersonalSchedules();
                } else {
                    populateScheduleSelector();
                }
                
                // Automatically select the new schedule
                scheduleSelector.value = docRef.id;
                handleScheduleChange();
                
            } catch (error) {
                console.error("Error creating new schedule:", error);
            }
        });

        // --- Delete Shared Schedule (Admin) ---
        deleteScheduleBtn.addEventListener('click', () => {
            if (!baseSchedule) {
                alert("No schedule selected to delete.");
                return;
            }
            
            // Refuse to delete personal schedules from this button
            if (personalSchedule) {
                 alert("This is a personal schedule. Use the 'My Personal Bells' section to delete it.");
                 return;
            }
            
            confirmDeleteText.textContent = `Are you sure you want to delete the SHARED schedule "${baseSchedule.name}"? This will affect all users. This action cannot be undone.`;
            confirmDeleteModal.classList.remove('hidden');
        });

        deleteConfirmBtn.addEventListener('click', async () => {
            if (!baseSchedule || !scheduleRef) return;
            
            console.log("Deleting shared schedule:", baseSchedule.id);
            
            try {
                await deleteDoc(scheduleRef);
                console.log("Shared schedule deleted.");
                
                // Clear state
                baseSchedule = null;
                scheduleRef = null;
                
                // Reload schedule list and pick a new one
                await loadAllSchedules();
                if (!isUserAnonymous) {
                    loadPersonalSchedules(); // will call populateScheduleSelector
                } else {
                    populateScheduleSelector();
                }
                
                // Select the first available schedule
                if (allSchedules.length > 0) {
                    scheduleSelector.value = allSchedules[0].id;
                } else if (allPersonalSchedules.length > 0) {
                    scheduleSelector.value = allPersonalSchedules[0].id;
                }
                handleScheduleChange();
                
            } catch (error) {
                console.error("Error deleting shared schedule:", error);
            } finally {
                closeDeleteModal();
            }
        });
        
        function closeDeleteModal() {
            confirmDeleteModal.classList.add('hidden');
        }
        deleteCancelBtn.addEventListener('click', closeDeleteModal);


        // --- MODAL: Create/Delete Personal Schedules (v3.03) ---
        
        // --- Create Personal Schedule ---
        createPersonalScheduleBtn.addEventListener('click', () => {
            if (!baseSchedule) {
                alert("Please select a shared schedule to copy from first.");
                return;
            }
            
            personalBaseScheduleName.textContent = baseSchedule.name;
            newPersonalScheduleNameInput.value = `${baseSchedule.name} (My Copy)`;
            createPersonalScheduleStatus.classList.add('hidden');
            createPersonalScheduleModal.classList.remove('hidden');
        });

        createPersonalScheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!baseSchedule || isUserAnonymous) return;
            
            const newName = newPersonalScheduleNameInput.value.trim();
            if (!newName) return;
            
            showModalText(createPersonalScheduleStatus, "Creating...");
            
            // We copy the *current* state of the base schedule's periods,
            // but we add *no* personal periods.
            const newPersonalSchedule = {
                name: newName,
                baseScheduleId: baseSchedule.id,
                periods: [] // Start with no personal periods
            };
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/personalSchedules`;
                const personalSchedulesCollectionRef = collection(db, collectionPath);
                
                const docRef = await addDoc(personalSchedulesCollectionRef, newPersonalSchedule);
                console.log("New personal schedule created:", docRef.id);
                
                showModalText(createPersonalScheduleStatus, "Success! Loading new schedule...", true);
                
                // Close modal and auto-select the new schedule
                setTimeout(() => {
                    closeCreatePersonalModal();
                    // loadPersonalSchedules() will be triggered by the listener,
                    // which will call populateScheduleSelector().
                    // We just need to select the new one when it appears.
                    scheduleSelector.value = docRef.id;
                    handleScheduleChange();
                }, 1500);
                
            } catch (error) {
                console.error("Error creating personal schedule:", error);
                showModalText(createPersonalScheduleStatus, `Error: ${error.message}`);
            }
        });
        
        function closeCreatePersonalModal() {
            createPersonalScheduleModal.classList.add('hidden');
        }
        createPersonalScheduleCancelBtn.addEventListener('click', closeCreatePersonalModal);

        // --- Delete Personal Schedule ---
        deletePersonalScheduleBtn.addEventListener('click', () => {
            if (!personalSchedule) {
                 alert("No personal schedule is selected.");
                 return;
            }
            
            confirmDeletePersonalText.textContent = `Are you sure you want to delete your personal schedule "${personalSchedule.name}"? This cannot be undone.`;
            confirmDeletePersonalModal.classList.remove('hidden');
        });
        
        deletePersonalConfirmBtn.addEventListener('click', async () => {
            if (!personalSchedule || isUserAnonymous) return;
            
            console.log("Deleting personal schedule:", personalSchedule.id);
            
            try {
                const docPath = `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`;
                const personalScheduleRef = doc(db, docPath);
                
                await deleteDoc(personalScheduleRef);
                console.log("Personal schedule deleted.");
                
                // Clear state
                personalSchedule = null;
                activePersonalScheduleId = null;
                
                // The listener on the collection will update the dropdown.
                // We just need to select a new schedule.
                
                // Fallback to its base schedule
                if (baseSchedule) {
                    scheduleSelector.value = baseSchedule.id;
                } else if (allSchedules.length > 0) {
                    scheduleSelector.value = allSchedules[0].id;
                }
                handleScheduleChange();
                
            } catch (error) {
                console.error("Error deleting personal schedule:", error);
            } finally {
                closeDeletePersonalModal();
            }
        });

        function closeDeletePersonalModal() {
            confirmDeletePersonalModal.classList.add('hidden');
        }
        deletePersonalCancelBtn.addEventListener('click', closeDeletePersonalModal);
        
        
        // --- Personal Schedule Manager: Rename, Backup, Restore (v3.05) ---
        
        // --- Rename Personal Schedule ---
        renamePersonalScheduleBtn.addEventListener('click', async () => {
            if (!personalSchedule) return;
            
            const newName = prompt("Enter a new name for your schedule:", personalSchedule.name);
            if (!newName || newName.trim() === "" || newName === personalSchedule.name) {
                return;
            }
            
            try {
                const docPath = `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`;
                const personalScheduleRef = doc(db, docPath);
                await updateDoc(personalScheduleRef, { name: newName.trim() });
                console.log("Personal schedule renamed.");
                // Listener will pick up the change and re-render
            } catch (error) {
                console.error("Error renaming personal schedule:", error);
                alert(`Error renaming: ${error.message}`);
            }
        });
        
        // --- Backup Personal Schedule ---
        backupPersonalScheduleBtn.addEventListener('click', () => {
            if (!personalSchedule) return;
            
            try {
                // We only back up the *personal* data (name, baseId, and custom periods)
                // The base schedule data is backed up separately.
                const backupData = {
                    version: 4.00,
                    type: "PersonalScheduleBackup",
                    schedule: personalSchedule // The 'personalSchedule' object is already in v4 format
                };
                
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `personal_schedule_backup_${personalSchedule.name}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error("Error creating personal backup:", error);
                alert(`Error: ${error.message}`);
            }
        });

        // --- Restore Personal Schedule ---
        restorePersonalScheduleBtn.addEventListener('click', () => {
            if (!personalSchedule) {
                alert("Select the personal schedule you want to *overwrite* first.");
                return;
            }
            restoreFileInput.click(); // Open file picker
        });
        
        restoreFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!data || data.type !== "PersonalScheduleBackup" || !data.schedule) {
                        throw new Error("Invalid backup file. Must be a Personal Schedule Backup.");
                    }
                    
                    // The data.schedule object is the full personal schedule
                    pendingRestoreData = data.schedule; 
                    
                    // Show confirmation modal
                    confirmRestoreText.textContent = `Overwrite "${personalSchedule.name}" with data from "${pendingRestoreData.name}"? This cannot be undone.`;
                    confirmRestoreModal.classList.remove('hidden');
                    
                } catch (error) {
                    console.error("Error reading restore file:", error);
                    alert(`Error: ${error.message}`);
                } finally {
                    // Clear the file input
                    restoreFileInput.value = null;
                }
            };
            reader.readAsText(file);
        });
        
        restoreConfirmBtn.addEventListener('click', async () => {
            if (!pendingRestoreData || !personalSchedule) return;
            
            try {
                // Get the ID of the *current* schedule to overwrite it
                const docPath = `artifacts/${appId}/users/${userId}/personalSchedules/${personalSchedule.id}`;
                const personalScheduleRef = doc(db, docPath);
                
                // We write *all* data from the backup, overwriting the existing doc
                // This includes its name, baseScheduleId, and periods.
                await setDoc(personalScheduleRef, pendingRestoreData);
                
                console.log("Personal schedule restored.");
                // The listener will pick up the change and re-render everything.
                
            } catch (error) {
                console.error("Error restoring personal schedule:", error);
                alert(`Error: ${error.message}`);
            } finally {
                closeRestoreModal();
            }
        });

        function closeRestoreModal() {
            pendingRestoreData = null;
            confirmRestoreModal.classList.add('hidden');
        }
        restoreCancelBtn.addEventListener('click', closeRestoreModal);


        // --- Import/Export (Admin) ---
        exportSchedulesBtn.addEventListener('click', async () => {
            try {
                // This function exports ALL shared schedules
                const snapshot = await getDocs(schedulesCollectionRef);
                const schedules = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // NEW v4.00: We must also export ALL shared audio files
                const audioListRef = ref(storage, `artifacts/${appId}/public/audio`);
                const audioList = await listAll(audioListRef);
                
                const audioFiles = [];
                for (const itemRef of audioList.items) {
                    try {
                        const url = await getDownloadURL(itemRef);
                        const metadata = await getMetadata(itemRef);
                        const name = metadata.customMetadata?.originalName || itemRef.name;
                        
                        // Download the actual file data as base64
                        const bytes = await getBytes(itemRef);
                        const base64Data = btoa(String.fromCharCode.apply(null, new Uint8Array(bytes)));
                        
                        audioFiles.push({
                            name: itemRef.name, // e.g. "sound.mp3"
                            originalName: name, // e.g. "My Cool Sound"
                            contentType: metadata.contentType,
                            base64Data: base64Data
                        });
                    } catch (e) {
                        console.error(`Failed to export audio file ${itemRef.name}:`, e);
                    }
                }
                
                const backupData = {
                    version: 4.00,
                    type: "EllisWebBell_AllSchedules",
                    schedules: schedules,
                    sharedAudio: audioFiles
                };

                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `ellis_web_bell_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error("Error exporting schedules:", error);
                alert("Error exporting data: " + error.message);
            }
        });

        importSchedulesBtn.addEventListener('click', () => {
            const warning = "WARNING!\n\nThis will ERASE all current shared schedules and audio files and replace them with the data from your backup.\n\nThis action cannot be undone. Are you sure?";
            if (confirm(warning)) {
                importFileInput.click();
            }
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showModalText(importStatus, "Reading file...");

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const backupData = JSON.parse(event.target.result);
                    
                    if (!backupData || backupData.type !== "EllisWebBell_AllSchedules" || !backupData.schedules) {
                        throw new Error("Invalid backup file. Must be 'EllisWebBell_AllSchedules'.");
                    }
                    
                    showModalText(importStatus, "Importing... Deleting old data...");
                    
                    // --- 1. Delete all existing shared schedules ---
                    const oldSnapshot = await getDocs(schedulesCollectionRef);
                    const deleteBatch = writeBatch(db);
                    oldSnapshot.docs.forEach(doc => {
                        deleteBatch.delete(doc.ref);
                    });
                    await deleteBatch.commit();
                    console.log("Deleted old shared schedules.");
                    showModalText(importStatus, "Importing... Old schedules deleted.");

                    // --- 2. Delete all existing shared audio ---
                    const audioListRef = ref(storage, `artifacts/${appId}/public/audio`);
                    const oldAudioList = await listAll(audioListRef);
                    for (const itemRef of oldAudioList.items) {
                        await deleteObject(itemRef);
                    }
                    console.log("Deleted old shared audio.");
                    showModalText(importStatus, "Importing... Old audio deleted.");


                    // --- 3. Import new schedules ---
                    const importBatch = writeBatch(db);
                    backupData.schedules.forEach(schedule => {
                        const { id, ...data } = schedule;
                        const newDocRef = doc(db, `artifacts/${appId}/public/schedules/${id}`);
                        
                        // --- v4.00 Migration Check ---
                        // If backup is old (v3), migrate it on import
                        const v4Data = migrateScheduleData(data);
                        
                        importBatch.set(newDocRef, v4Data);
                    });
                    await importBatch.commit();
                    console.log("Imported new shared schedules.");
                    showModalText(importStatus, "Importing... New schedules added.");
                    
                    // --- 4. Import new shared audio (if exists) ---
                    if (backupData.sharedAudio && backupData.sharedAudio.length > 0) {
                        showModalText(importStatus, `Importing ${backupData.sharedAudio.length} audio files...`);
                        for (const audioFile of backupData.sharedAudio) {
                            try {
                                const fileRef = ref(storage, `artifacts/${appId}/public/audio/${audioFile.name}`);
                                
                                // Convert base64 back to bytes
                                const byteString = atob(audioFile.base64Data);
                                const bytes = new Uint8Array(byteString.length);
                                for (let i = 0; i < byteString.length; i++) {
                                    bytes[i] = byteString.charCodeAt(i);
                                }
                                
                                const metadata = {
                                    contentType: audioFile.contentType,
                                    customMetadata: {
                                        originalName: audioFile.originalName
                                    }
                                };
                                await uploadBytes(fileRef, bytes, metadata);
                                
                            } catch (e) {
                                console.error(`Failed to import audio ${audioFile.name}:`, e);
                            }
                        }
                        console.log("Imported new shared audio.");
                    }

                    showModalText(importStatus, "Import complete! Reloading...", true);
                    
                    // Reload the app to see changes
                    setTimeout(() => {
                        location.reload();
                    }, 2000);

                } catch (error) {
                    console.error("Error importing file:", error);
                    showModalText(importStatus, `Error: ${error.message}`);
                } finally {
                    importFileInput.value = null; // Clear file input
                }
            };
            reader.readAsText(file);
        });


        // --- Audio Manager Functions ---
        
        /**
         * Populates all <select> dropdowns with sound options.
         */
        function populateAllSoundDropdowns() {
            const dropdowns = [
                { el: quickBellSoundSelect, my: 'quick-my-sounds-optgroup', shared: 'quick-shared-sounds-optgroup' },
                { el: sharedSoundInput, my: 'shared-my-sounds-optgroup', shared: 'shared-shared-sounds-optgroup' },
                { el: personalSoundInput, my: 'personal-my-sounds-optgroup', shared: 'personal-shared-sounds-optgroup' },
                { el: editBellSoundInput, my: 'edit-my-sounds-optgroup', shared: 'edit-shared-sounds-optgroup' },
                { el: changeSoundSelect, my: 'change-my-sounds-optgroup', shared: 'change-shared-sounds-optgroup' }
            ];
            
            dropdowns.forEach(dd => {
                const myOptgroup = dd.el.querySelector(`#${dd.my}`);
                const sharedOptgroup = dd.el.querySelector(`#${dd.shared}`);
                
                myOptgroup.innerHTML = '';
                sharedOptgroup.innerHTML = '';
                
                userAudioFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.url;
                    option.textContent = file.name;
                    myOptgroup.appendChild(option);
                });
                
                sharedAudioFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.url;
                    option.textContent = file.name;
                    sharedOptgroup.appendChild(option);
                });
            });
        }
        
        /**
         * Loads the user's private audio files.
         */
        async function loadUserAudioFiles() {
            if (isUserAnonymous) {
                userAudioFiles = [];
                populateAllSoundDropdowns();
                myAudioFilesList.innerHTML = '<p class="text-gray-500">Sign in with Google to upload your own audio.</p>';
                return;
            }
            
            try {
                myAudioFilesList.innerHTML = '<p class="text-gray-500">Loading...</p>';
                const listRef = ref(storage, `artifacts/${appId}/users/${userId}/audio`);
                const list = await listAll(listRef);
                
                const files = [];
                for (const itemRef of list.items) {
                    try {
                        const url = await getDownloadURL(itemRef);
                        const metadata = await getMetadata(itemRef);
                        const name = metadata.customMetadata?.originalName || itemRef.name;
                        files.push({ name: name, url: url, path: itemRef.fullPath, rawName: itemRef.name });
                    } catch (e) {
                        console.error(`Failed to get metadata for ${itemRef.name}:`, e);
                    }
                }
                
                userAudioFiles = files.sort((a, b) => a.name.localeCompare(b.name));
                console.log("Loaded user audio files:", userAudioFiles);
                populateAllSoundDropdowns();
                renderAudioManagerList(myAudioFilesList, userAudioFiles, 'user');
                
            } catch (error) {
                console.error("Error loading user audio files:", error);
                myAudioFilesList.innerHTML = '<p class="text-red-500">Error loading audio files.</p>';
            }
        }
        
        /**
         * Loads the public shared audio files.
         */
        async function loadSharedAudioFiles() {
             try {
                sharedAudioFilesList.innerHTML = '<p class="text-gray-500">Loading...</p>';
                const listRef = ref(storage, `artifacts/${appId}/public/audio`);
                const list = await listAll(listRef);
                
                const files = [];
                for (const itemRef of list.items) {
                     try {
                        const url = await getDownloadURL(itemRef);
                        const metadata = await getMetadata(itemRef);
                        const name = metadata.customMetadata?.originalName || itemRef.name;
                        files.push({ name: name, url: url, path: itemRef.fullPath, rawName: itemRef.name });
                    } catch (e) {
                        console.error(`Failed to get metadata for ${itemRef.name}:`, e);
                    }
                }
                
                sharedAudioFiles = files.sort((a, b) => a.name.localeCompare(b.name));
                console.log("Loaded shared audio files:", sharedAudioFiles);
                populateAllSoundDropdowns();
                renderAudioManagerList(sharedAudioFilesList, sharedAudioFiles, 'shared');
                
            } catch (error) {
                console.error("Error loading shared audio files:", error);
                sharedAudioFilesList.innerHTML = '<p class="text-red-500">Error loading audio files.</p>';
            }
        }
        
        /**
         * Renders the list of audio files in the manager panel.
         */
        function renderAudioManagerList(listElement, files, type) {
            listElement.innerHTML = '';
            if (files.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500">No files found.</p>';
                return;
            }
            
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg";
                
                const infoDiv = document.createElement('div');
                infoDiv.className = "truncate";
                
                const nameEl = document.createElement('p');
                nameEl.className = "text-sm font-medium text-gray-900 truncate";
                nameEl.textContent = file.name;
                
                const rawNameEl = document.createElement('p');
                rawNameEl.className = "text-xs text-gray-500 truncate";
                rawNameEl.textContent = file.rawName;
                
                infoDiv.appendChild(nameEl);
                infoDiv.appendChild(rawNameEl);
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = "flex-shrink-0 flex items-center gap-2 ml-4";
                
                const testBtn = document.createElement('button');
                testBtn.className = "text-xl opacity-60 hover:opacity-100 text-blue-600";
                testBtn.title = "Test sound";
                testBtn.innerHTML = '&#9654;'; // Play icon
                testBtn.addEventListener('click', () => testSound(file.url));
                controlsDiv.appendChild(testBtn);
                
                // Rename button
                const renameBtn = document.createElement('button');
                renameBtn.innerHTML = '&#9998;'; // Pencil
                renameBtn.className = "px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200";
                renameBtn.title = "Rename file";
                renameBtn.addEventListener('click', () => renameAudioFile(file));
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&#128465;'; // Trash
                deleteBtn.className = "px-2 py-1 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200";
                deleteBtn.title = "Delete file";
                deleteBtn.addEventListener('click', () => openDeleteAudioModal(file, type));

                // Add buttons based on permissions
                if (type === 'user') {
                    controlsDiv.appendChild(renameBtn);
                    controlsDiv.appendChild(deleteBtn);
                } else if (type === 'shared') {
                    // Only admins can rename/delete shared files
                    renameBtn.classList.add('admin-control');
                    deleteBtn.classList.add('admin-control');
                    controlsDiv.appendChild(renameBtn);
                    controlsDiv.appendChild(deleteBtn);
                }
                
                div.appendChild(infoDiv);
                div.appendChild(controlsDiv);
                listElement.appendChild(div);
            });
        }
        
        // --- Audio File Upload ---
        audioUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                fileToUpload = null;
                audioFileName.textContent = "No file chosen.";
                audioUploadBtn.disabled = true;
                return;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                showModalText(audioUploadStatus, `Error: File is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max is 1MB.`);
                fileToUpload = null;
                audioUploadInput.value = null;
                audioFileName.textContent = "File too large.";
                audioUploadBtn.disabled = true;
                return;
            }
            
            fileToUpload = file;
            audioFileName.textContent = file.name;
            audioUploadBtn.disabled = false;
            audioUploadStatus.classList.add('hidden');
        });
        
        audioUploadBtn.addEventListener('click', async () => {
            if (!fileToUpload || isUserAnonymous) return;
            
            audioUploadBtn.disabled = true;
            showModalText(audioUploadStatus, "Uploading...");
            
            try {
                // Sanitize file name
                const safeName = fileToUpload.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                const newFileName = `${Date.now()}_${safeName}`;
                
                const storagePath = `artifacts/${appId}/users/${userId}/audio/${newFileName}`;
                const fileRef = ref(storage, storagePath);
                
                const metadata = {
                    contentType: fileToUpload.type,
                    customMetadata: {
                        'originalName': fileToUpload.name // Store the original name
                    }
                };

                const snapshot = await uploadBytes(fileRef, fileToUpload, metadata);
                console.log("Uploaded file:", snapshot);
                
                showModalText(audioUploadStatus, "Upload complete!", true);
                
                // Reset form
                fileToUpload = null;
                audioUploadInput.value = null;
                audioFileName.textContent = "No file chosen.";
                audioUploadBtn.disabled = true;
                
                // Refresh user audio list
                await loadUserAudioFiles();
                
            } catch (error) {
                console.error("Error uploading file:", error);
                showModalText(audioUploadStatus, `Error: ${error.message}`);
                audioUploadBtn.disabled = false;
            }
        });
        
        // --- Rename Audio File ---
        async function renameAudioFile(file) {
            const newName = prompt("Enter new display name:", file.name);
            if (!newName || newName.trim() === "" || newName === file.name) {
                return;
            }
            
            try {
                const fileRef = ref(storage, file.path);
                const newMetadata = {
                    customMetadata: {
                        'originalName': newName.trim()
                    }
                };
                await updateMetadata(fileRef, newMetadata);
                console.log("Audio file renamed.");
                
                // Refresh list
                if (file.path.includes('/public/')) {
                    loadSharedAudioFiles();
                } else {
                    loadUserAudioFiles();
                }
                
            } catch (error) {
                console.error("Error renaming file:", error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // --- Delete Audio File ---
        async function openDeleteAudioModal(file, type) {
            audioToDelete = { file, type };
            confirmDeleteAudioText.textContent = `Are you sure you want to delete "${file.name}"?`;
            confirmDeleteAudioList.innerHTML = '<li>Checking for links...</li>';
            confirmDeleteAudioModal.classList.remove('hidden');
            
            // Check all schedules for links to this sound
            const links = [];
            const soundUrl = file.url;
            
            // Check all shared schedules
            for (const s of allSchedules) {
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/schedules/${s.id}`);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const schedule = migrateScheduleData(docSnap.data());
                        schedule.periods.forEach(p => {
                            p.bells.forEach(b => {
                                if (b.sound === soundUrl) {
                                    links.push(`<li>Shared Schedule: <strong>${schedule.name}</strong> / ${p.name} / ${b.name}</li>`);
                                }
                            });
                        });
                    }
                } catch(e) { console.warn("Error checking schedule", s.id, e); }
            }
            
            // Check personal schedules (if not anon)
            if (!isUserAnonymous) {
                 for (const s of allPersonalSchedules) {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/personalSchedules/${s.id}`);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const schedule = migrateScheduleData(docSnap.data());
                            schedule.periods.forEach(p => {
                                p.bells.forEach(b => {
                                    if (b.sound === soundUrl) {
                                        links.push(`<li>Personal Schedule: <strong>${schedule.name}</strong> / ${p.name} / ${b.name}</li>`);
                                    }
                                });
                            });
                        }
                    } catch(e) { console.warn("Error checking personal schedule", s.id, e); }
                 }
            }
            
            // Check overrides
            const overrideLinks = Object.keys(bellSoundOverrides).filter(k => bellSoundOverrides[k] === soundUrl);
            if (overrideLinks.length > 0) {
                 links.push(`<li>...and <strong>${overrideLinks.length}</strong> personal sound override(s).</li>`);
            }
            
            if (links.length > 0) {
                confirmDeleteAudioText.textContent = `WARNING: This audio file is used in ${links.length} bells. Deleting it will cause them to use a fallback sound. Are you sure?`;
                confirmDeleteAudioList.innerHTML = links.join('');
            } else {
                confirmDeleteAudioList.innerHTML = '<li>No linked bells found.</li>';
            }
        }
        
        deleteAudioConfirmBtn.addEventListener('click', async () => {
            if (!audioToDelete) return;
            
            try {
                const fileRef = ref(storage, audioToDelete.file.path);
                await deleteObject(fileRef);
                
                console.log("Audio file deleted:", audioToDelete.file.path);
                
                // Clear from cache
                if (synths[audioToDelete.file.url]) {
                    delete synths[audioToDelete.file.url];
                }
                
                // Refresh list
                if (audioToDelete.type === 'shared') {
                    loadSharedAudioFiles();
                } else {
                    loadUserAudioFiles();
                }
                
            } catch (error) {
                console.error("Error deleting file:", error);
                alert(`Error: ${error.message}`);
            } finally {
                closeDeleteAudioModal();
            }
        });
        
        function closeDeleteAudioModal() {
            audioToDelete = null;
            confirmDeleteAudioModal.classList.add('hidden');
        }
        deleteAudioCancelBtn.addEventListener('click', closeDeleteAudioModal);


        // --- Quick Bell Handlers ---
        quickBellControls.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-bell-btn')) {
                const minutes = parseInt(e.target.dataset.minutes, 10);
                const now = new Date();
                quickBellEndTime = now.getTime() + minutes * 60 * 1000;
                
                quickBellSound = quickBellSoundSelect.value;

                console.log(`Quick bell set for ${minutes} minutes. Sound: ${quickBellSound}`);
                
                // Play a confirmation sound
                testSound(quickBellSound); 
                
                // Update clock immediately to show new bell
                updateClock(); 
            }
        });
        
        // Update sound selection
        quickBellSoundSelect.addEventListener('change', () => {
            quickBellSound = quickBellSoundSelect.value;
        });
        
        // --- Mute/Unmute All ---
        document.getElementById('mute-all-list-btn').addEventListener('click', () => {
            if (!confirm("Are you sure you want to mute all bells in this view?")) return;
            
            let allBells = [];
            if (baseSchedule && baseSchedule.periods) {
                baseSchedule.periods.forEach(p => allBells.push(...p.bells.map(b => ({ ...b, type: 'shared' }))));
            }
            if (personalSchedule && personalSchedule.periods) {
                 personalSchedule.periods.forEach(p => allBells.push(...p.bells.map(b => ({ ...b, type: 'custom' }))));
            }
            
            allBells.forEach(bell => {
                const bellId = getBellId(bell);
                if (bellId) mutedBellIds.add(bellId);
            });
            
            saveMutedBells();
            renderCombinedBellList();
        });

        document.getElementById('unmute-all-list-btn').addEventListener('click', () => {
            mutedBellIds.clear();
            saveMutedBells();
            renderCombinedBellList();
        });


        // --- Utility Functions ---
        function showModalText(element, message, isSuccess = false) {
            element.textContent = message;
            element.classList.remove('hidden');
            if (isSuccess) {
                element.classList.remove('text-blue-600');
                element.classList.add('text-green-600');
            } else {
                element.classList.add('text-blue-600');
                element.classList.remove('text-green-600');
            }
            
            if (isSuccess) {
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 2000);
            }
        }
        
        // --- Global Error Handler ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global error caught:", { message, source, lineno, colno, error });
            statusElement.textContent = `Error: ${message}`;
            statusElement.classList.add('text-red-500');
        };

        // --- Start the App ---
        initializeAppAndAuth();
        
        // MODIFIED: Version Bump
        console.log("Ellis Web Bell v4.01");

    </script>
</body>
</html>
<!-- Ellis Web Bell v4.01 -->
