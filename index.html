<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MODIFIED: Version Bump to 4.01 -->
    <title>Ellis Web Bell 4.01</title>
    <!-- SVG Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24%22 fill=%22%232563EB%22><path d=%22M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z%22/></svg>">
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using Tone.js for web audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Use Century Gothic, with Questrial as a web-safe fallback
                        sans: ['Century Gothic', 'Questrial', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <!-- Updated Google Font to include Questrial as a Century Gothic fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
    <style>
        body {
            /* Apply the new font stack */
            font-family: 'Century Gothic', 'Questrial', 'sans-serif';
        }
        /* Styles for Admin Controls */
        /* Hide admin controls and shared delete/edit buttons by default */
        .admin-control, .delete-btn, .edit-btn {
            display: none;
        }
        /* When body has .admin-mode, show them */
        body.admin-mode .admin-control,
        body.admin-mode .delete-btn,
        body.admin-mode .edit-btn {
            display: inline-block; 
        }

        /* Always show custom delete/edit buttons */
        .delete-custom-btn,
        .edit-custom-btn {
            display: inline-block;
        }

        /* Sound override button is always visible for shared bells */
        .sound-btn {
            display: inline-block;
        }
        /* Hide sound override button for custom bells (they use 'Edit') */
        .sound-custom-btn {
            display: none;
        }
        
        /* NEW v4.00: Show admin buttons within period headers */
        body.admin-mode .period-admin-controls {
            display: flex;
        }

        /* Fix for modal z-index issues */
        #edit-bell-modal { z-index: 50; }
        #change-sound-modal { z-index: 50; }
        #nearby-bell-modal { z-index: 55; }
        #confirm-delete-bell-modal { z-index: 55; }
        #confirm-delete-audio-modal { z-index: 55; }
        #confirm-delete-modal { z-index: 55; } /* Shared Schedule Delete */
        
        /* NEW v4.00: Z-indexes for period modals */
        #edit-period-modal { z-index: 51; }
        #confirm-delete-period-modal { z-index: 56; }
        
        /* DELETED v4.00: Removed complex conflict modal z-indexes */

        /* v3.03 logic */
        #create-personal-schedule-modal { z-index: 50; }
        #confirm-delete-personal-modal { z-index: 55; }
        
        /* v3.05 */
        #confirm-restore-modal { z-index: 55; }
        
        /* Hide file input, style the button */
        #import-file-input, #audio-upload-input, #restore-file-input {
            display: none;
        }

        /* Hide elements that require non-anonymous auth */
        .auth-required {
            display: none;
        }
        /* When authenticated AND not anonymous, show them */
        body.authenticated.not-anonymous .auth-required {
            display: block;
        }

        /* Admin-only elements, hidden by default */
        .admin-only {
            display: none;
        }
        /* Show when in admin mode */
        body.admin-mode .admin-only {
            display: inline-flex; /* Use inline-flex to work with flex properties */
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

    <!-- Auth/Welcome Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-lg shadow-xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-700 mb-4">Welcome to the Ellis Web Bell!</h2>
            <p class="text-gray-600 mb-8">Please sign in to load and sync schedules.</p>
            <div class="space-y-4">
                <button id="google-start-btn" class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 font-medium rounded-lg shadow-md border border-gray-200 hover:bg-gray-50 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48">
                        <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.28 6.42C12.92 13.9 18.06 9.5 24 9.5z"></path>
                        <path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 2.73-2.2 5.08-4.79 6.69l7.38 5.71C44.97 36.3 46.98 30.8 46.98 24.55z"></path>
                        <path fill="#FBBC05" d="M10.84 28.71C10.22 26.9 9.83 24.99 9.83 23c0-1.99.39-3.9 1.01-5.71L2.56 10.8C.9 14.28 0 18.48 0 23c0 4.52.9 8.72 2.56 12.2l8.28-6.49z"></path>
                        <path fill="#EA4335" d="M24 48c5.4 0 10.32-1.62 14.34-4.38l-7.38-5.71C28.71 40.5 26.47 42.1 24 42.1c-5.94 0-11.08-4.4-12.96-10.28L2.56 38.2C6.51 46.04 14.62 48 24 48z"></path>
                        <path fill="none" d="M0 0h48v48H0z"></path>
                    </svg>
                    Sign in with Google
                </button>
                <button id="anonymous-start-btn" class="w-full px-6 py-3 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                    Continue Anonymously
                </button>
            </div>
        </div>
    </div>

    <!-- Audio Start Overlay -->
    <div id="audio-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden">
        <button id="start-audio-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-2xl rounded-lg shadow-lg hover:bg-blue-700 transition-colors text-center disabled:opacity-75" disabled>
            Loading...
        </button>
    </div>
    
    <!-- DELETED v4.00: Add Bell to Multiple Schedules Modal -->
    <!-- This feature is incompatible with the new period-based data structure -->


    <!-- Edit Bell Modal (Admin / Custom) -->
    <div id="edit-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-bell-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Bell</h3>
            
            <!-- Bell Details -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-bell-time" class="block text-sm font-medium text-gray-700">Time (HH:MM:SS)</label>
                    <input type="time" id="edit-bell-time" step="1" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="edit-bell-name" class="block text-sm font-medium text-gray-700">Bell Name</label>
                    <input type="text" id="edit-bell-name" placeholder="e.g. 1st Period End" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label for="edit-bell-sound" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="edit-bell-sound" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <option value="Alarm">Alarm</option>
                        <option value="ellisBell.mp3" selected>Ellis Bell</option>
                    </optgroup>
                    <optgroup label="My Sounds" id="edit-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="edit-shared-sounds-optgroup"></optgroup>
                </select>
            </div>
            
            <p id="edit-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-bell-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- **** NEW v4.00: Edit Period Modal **** -->
    <div id="edit-period-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="edit-period-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Edit Period</h3>
            <div>
                <label for="edit-period-name" class="block text-sm font-medium text-gray-700">Period Name</label>
                <input type="text" id="edit-period-name" placeholder="e.g. 1st Period" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="edit-period-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="edit-period-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- **** NEW v4.00: Confirm Delete Period Modal **** -->
    <div id="confirm-delete-period-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Period</h3>
            <p id="confirm-delete-period-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-period-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-period-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Change Bell SOUND Modal (All Users) -->
    <div id="change-sound-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="change-sound-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">Change Bell Sound</h3>
            
            <!-- Bell Info (Read-only) -->
            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <p class="text-sm font-medium text-gray-700">Bell:</p>
                <p id="change-sound-bell-name" class="text-lg font-semibold text-gray-900"></p>
                <p id="change-sound-bell-time" class="text-lg font-semibold text-gray-900"></p>
            </div>

            <!-- Sound Select -->
            <div>
                <label for="change-sound-select" class="block text-sm font-medium text-gray-700">Sound</label>
                <select id="change-sound-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <option value="Alarm">Alarm</option>
                        <option value="ellisBell.mp3" selected>Ellis Bell</option>
                    </optgroup>
                    <optgroup label="My Sounds" id="change-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="change-shared-sounds-optgroup"></optgroup>
                </select>
            </div>

            <!-- Warning Message -->
            <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 rounded">
                <p class="text-sm text-yellow-800">Are you sure you want to change this bell's sound? Your sound should be a brief but obvious indication of transition.</p>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="change-sound-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" id="change-sound-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Sound</button>
            </div>
        </form>
    </div>

    <!-- DELETED v4.00: Confirm Linked Edit Modal -->
    <!-- This feature is incompatible with the new period-based data structure -->


    <!-- Confirm Delete Schedule Modal -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Schedule</h3>
            <p id="confirm-delete-text" class="text-gray-700 mb-6">Are you sure you want to delete this schedule? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete BELL Modal -->
    <div id="confirm-delete-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Bell</h3>
            <p id="confirm-delete-bell-text" class="text-gray-700 mb-6">Are you sure you want to delete this bell?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-bell-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete AUDIO Modal -->
    <div id="confirm-delete-audio-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Delete Audio File</h3>
            <p id="confirm-delete-audio-text" class="text-gray-700 mb-4">Are you sure you want to delete this audio file?</p>
            
            <ul id="confirm-delete-audio-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-1 bg-gray-50 mb-6">
                <!-- Linked bells will be injected here -->
            </ul>
            
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-audio-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-audio-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Anyway</button>
            </div>
        </div>
    </div>

    <!-- Nearby Bell Warning Modal (Simplified for v4.00) -->
    <div id="nearby-bell-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-medium mb-4">Nearby Bell Detected</h3>
            <p class="text-gray-700 mb-6">A bell named "<strong id="nearby-bell-name">...</strong>" is already scheduled for <strong id="nearby-bell-time">...</strong> within this period. This is very close to your new time.</p>
            
            <p id="nearby-bell-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <!-- Controls (now used for both shared and custom) -->
            <div id="nearby-bell-custom-controls" class="mt-6 flex justify-end gap-3">
                <button type="button" id="nearby-bell-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="nearby-bell-add-anyway" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Bell Anyway</button>
            </div>
        </div>
    </div>

    <!-- DELETED v4.00: All v3.02 complex conflict modals removed -->
    <!-- (internal-conflict-warning-modal, internal-conflict-confirm-modal, external-conflict-modal) -->


    <!-- Personal Schedule Modals -->
    <div id="create-personal-schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <form id="create-personal-schedule-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-2xl font-medium mb-6">New Personal Schedule</h3>
            
            <p class="text-gray-700 mb-4">
                Base Schedule: <strong id="personal-base-schedule-name">...</strong>
            </p>
            
            <div>
                <label for="new-personal-schedule-name" class="block text-sm font-medium text-gray-700">New Schedule Name</label>
                <input type="text" id="new-personal-schedule-name" placeholder="e.g. My A-Day Schedule" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <p id="create-personal-schedule-status" class="text-blue-600 text-sm mt-4 hidden"></p>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="create-personal-schedule-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Create</button>
            </div>
        </form>
    </div>

    <!-- Confirm Delete Personal Schedule Modal -->
    <div id="confirm-delete-personal-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Delete Personal Schedule</h3>
            <p id="confirm-delete-personal-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="delete-personal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="delete-personal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Restore Personal Schedule Modal -->
    <div id="confirm-restore-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-medium mb-4">Overwrite Personal Schedule</h3>
            <p id="confirm-restore-text" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="restore-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="restore-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Overwrite</button>
            </div>
        </div>
    </div>


    <!-- Main Application -->
    <div class="container mx-auto max-w-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <!-- MODIFIED: Version Bump -->
            <h1 class="text-4xl font-bold text-blue-700">Ellis Web Bell 4.01</h1>
            <p class="text-lg text-gray-600">A real-time, synchronized bell schedule</p>
            
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <p id="user-display-name" class="text-gray-700"></p>
                <button id="signout-btn" class="w-full sm:w-auto px-4 py-1 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors hidden">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Countdown Card -->
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-md mb-8">
            <div class="text-center">
                <div id="live-clock-sentence" class="text-2xl font-medium text-gray-600 tabular-nums">
                    Loading...
                </div>
                <div id="countdown-display" class="text-6xl md:text-8xl font-bold text-gray-800 tabular-nums my-2">
                    --:--
                </div>
                <div id="next-bell-sentence" class="text-2xl font-medium text-gray-600">
                    until the next bell.
                </div>
            </div>

            <div class="text-center text-gray-500 text-lg mt-6">
                Status: <span id="status-message" class="font-medium text-gray-700">Initializing...</span>
            </div>
        </div>

        <!-- Quick Bell Section -->
        <div id="quickBellControls" class="p-4 bg-white rounded-xl shadow-md mb-8 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center space-x-3 flex-shrink-0">
                <span class="font-semibold text-gray-700">Quick Bell:</span>
                <div class="flex flex-wrap gap-2">
                    <button data-minutes="1" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">1</button>
                    <button data-minutes="2" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">2</button>
                    <button data-minutes="3" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">3</button>
                    <button data-minutes="5" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">5</button>
                    <button data-minutes="10" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">10</button>
                    <button data-minutes="15" class="quick-bell-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-all duration-150 shadow-md hover:shadow-lg transform active:scale-95">15</button>
                </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink min-w-0 w-full sm:w-auto">
                <label for="quickBellSoundSelect" class="text-sm font-medium text-gray-700">Sound:</label>
                <select id="quickBellSoundSelect" class="w-full truncate px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <optgroup label="Default Sounds">
                        <option value="Bell">Bell</option>
                        <option value="Chime">Chime</option>
                        <option value="Beep">Beep</option>
                        <option value="Alarm">Alarm</option>
                        <option value="ellisBell.mp3" selected>Ellis Bell</option>
                    </optgroup>
                    <optgroup label="My Sounds" id="quick-my-sounds-optgroup"></optgroup>
                    <optgroup label="Shared Sounds" id="quick-shared-sounds-optgroup"></optgroup>
                </select>
            </div>
        </div>


        <!-- MODIFIED v4.00: Combined Bell Schedule List -->
        <div>
            <div class="flex justify-between items-center mb-4">
                 <h2 id="schedule-title" class="text-2xl font-semibold">Current Schedule</h2>
                 <div class="flex-shrink-0 flex gap-2">
                     <button id="mute-all-list-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Mute All</button>
                     <button id="unmute-all-list-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Unmute All</button>
                 </div>
            </div>
            <!-- This div is now a container for period "cards" -->
            <div id="combined-bell-list" class="space-y-6 mb-8">
                <!-- Periods and bells will be injected here by JavaScript -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-8 text-center text-gray-500">
                        Loading schedule...
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Selector -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex justify-between items-center mb-2">
                <label for="schedule-selector" class="block text-lg font-medium text-gray-700">Active Schedule</label>
                <button id="admin-toggle" class="px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors opacity-50 cursor-not-allowed" disabled title="Sign in to see admin options">
                    Toggle Admin
                </button>
            </div>
            <select id="schedule-selector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                <option value="">Loading schedules...</option>
            </select>
            
            <button id="create-personal-schedule-btn" class="auth-required w-full mt-4 px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Copy as Personal Schedule
            </button>
        </div>
        

        <!-- NEW v4.00: Admin Zone (Refactored) -->
        <div class="admin-control bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Admin Zone</h3>
            
            <!-- Create New Schedule Form (Unchanged) -->
            <form id="create-schedule-form">
                <label for="new-schedule-name" class="block text-sm font-medium text-gray-700 mb-1">Create New Shared Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="new-schedule-name" placeholder="New Schedule Name" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700">
                        Create
                    </button>
                </div>
            </form>

            <!-- NEW: Add Period to THIS Schedule Form -->
            <form id="add-period-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Period to This Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="shared-period-name" placeholder="e.g. 1st Period" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Period
                    </button>
                </div>
                <p id="add-period-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- NEW: Add Bell to Period Form -->
            <form id="add-bell-to-period-form" class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Bell to a Period</label>
                
                <!-- Period Selector -->
                <div class="mb-4">
                     <label for="shared-period-select" class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                     <select id="shared-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                         <option value="">Select a schedule to see periods</option>
                     </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="shared-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="shared-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                    <div>
                        <label for="shared-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="shared-bell-name" placeholder="e.g. 1st Period Start" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="shared-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="shared-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <optgroup label="Default Sounds">
                                <option value="Bell">Bell</option>
                                <option value="Chime">Chime</option>
                                <option value="Beep">Beep</option>
                                <option value="Alarm">Alarm</option>
                                <option value="ellisBell.mp3" selected>Ellis Bell</option>
                            </optgroup>
                            <optgroup label="My Sounds" id="shared-my-sounds-optgroup"></optgroup>
                            <optgroup label="Shared Sounds" id="shared-shared-sounds-optgroup"></optgroup>
                        </select>
                    </div>
                    <button type="button" id="preview-shared-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview" disabled>
                        &#9654;
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Shared Bell
                    </button>
                </div>
                <p id="add-shared-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- DELETED v4.00: Add Bell to Schedules Button -->
            <!-- This feature is incompatible with the new period-based data structure -->

            <!-- Delete Selected Schedule Button -->
            <div class="border-t pt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Schedule</label>
                <button type="button" id="delete-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors">
                    Delete Selected Schedule
                </button>
            </div>

            <!-- Import/Export Section -->
            <div class="border-t pt-6 space-y-4">
                <h4 class="text-lg font-medium text-gray-800">Backup & Restore</h4>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Export All Schedules</label>
                    <button type="button" id="export-schedules-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        Download Backup (JSON)
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Import & Overwrite Schedules</label>
                    <input type="file" id="import-file-input" accept="application/json">
                    <button type="button" id="import-schedules-btn" class="w-full px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                        Upload Backup (JSON)
                    </button>
                    <p id="import-status" class="text-blue-600 text-sm mt-2 hidden"></p>
                </div>
            </div>

        </div>


        <!-- MODIFIED v4.00: Personal Bells (Refactored) -->
        <div class="auth-required mt-12">
            <h2 class="text-2xl font-semibold mb-4">My Personal Bells (Cloud Synced)</h2>

            <!-- NEW: Add Personal Period Form -->
            <form id="add-personal-period-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add Period to This Personal Schedule</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="personal-period-name" placeholder="e.g. My Reminders" required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Period
                    </button>
                </div>
                <p id="add-personal-period-status" class="text-blue-600 text-sm mt-3 hidden"></p>
            </form>

            <!-- NEW: Add Bell to Personal Period Form -->
            <form id="add-bell-to-personal-period-form" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <p id="personal-bell-status" class="text-sm text-gray-600 mb-4">Select a Personal Schedule from the dropdown above to manage its periods and bells.</p>
                
                <!-- Period Selector -->
                <div class="mb-4">
                     <label for="personal-period-select" class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                     <select id="personal-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                         <option value="">Select a personal schedule</option>
                     </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="personal-bell-time" class="block text-sm font-medium text-gray-700 mb-1">Time (HH:MM:SS)</label>
                        <input type="time" id="personal-bell-time" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                    <div>
                        <label for="personal-bell-name" class="block text-sm font-medium text-gray-700 mb-1">Bell Name</label>
                        <input type="text" id="personal-bell-name" placeholder="e.g. My Reminder" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div class="flex-grow" style="min-width: 120px;">
                        <label for="personal-bell-sound" class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                        <select id="personal-bell-sound" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <optgroup label="Default Sounds">
                                <option value="Bell">Bell</option>
                                <option value="Chime">Chime</option>
                                <option value="Beep">Beep</option>
                                <option value="Alarm">Alarm</option>
                                <option value="ellisBell.mp3" selected>Ellis Bell</option>
                            </optgroup>
                            <optgroup label="My Sounds" id="personal-my-sounds-optgroup"></optgroup>
                            <optgroup label="Shared Sounds" id="personal-shared-sounds-optgroup"></optgroup>
                        </select>
                    </div>
                    <button type="button" id="preview-personal-sound" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-lg bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" aria-label="Preview" disabled>
                        &#9654;
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" disabled>
                        Add Personal Bell
                    </button>
                </div>
            </form>
            
            <!-- Personal Schedule Manager (Unchanged) -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">My Personal Schedule Manager</h3>
                
                <div class="space-y-3">
                    <button type="button" id="rename-personal-schedule-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Rename Selected Personal Schedule
                    </button>
                    
                    <button type="button" id="backup-personal-schedule-btn" class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Back up Selected Personal Schedule
                    </button>
                    
                    <button type="button" id="restore-personal-schedule-btn" class="w-full px-4 py-2 bg-yellow-500 text-black font-medium rounded-lg shadow-md hover:bg-yellow-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Load/Overwrite Selected from Backup
                    </button>

                    <div class="border-t pt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delete Current Personal Schedule</label>
                        <button type="button" id="delete-personal-schedule-btn" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Delete Selected Personal Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Audio Manager Panel (Unchanged) -->
        <div id="audio-manager-panel" class="auth-required mt-12">
            <h2 class="text-2xl font-semibold mb-4 cursor-pointer" title="Click to refresh file lists">My Audio Manager</h2>
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 space-y-6">
                
                <!-- Audio Upload Form -->
                <div>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Upload New Audio File</h3>
                    <p class="text-sm text-gray-600 mb-4">Files must be under 1MB. (Supports .mp3, .wav, .m4a, .ogg)</p>
                    <input type="file" id="audio-upload-input" accept=".mp3,.wav,.m4a,.ogg">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label for="audio-upload-input" class="w-full sm:w-auto cursor-pointer px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors text-center">
                            Choose File...
                        </label>
                        <span id="audio-file-name" class="text-gray-700 sm:mt-2">No file chosen.</span>
                    </div>
                    <button type="button" id="audio-upload-btn" class="mt-3 w-full sm:w-auto px-6 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50" disabled>
                        Upload Audio
                    </button>
                    <p id="audio-upload-status" class="text-blue-600 text-sm mt-3 hidden"></p>
                </div>

                <!-- My Audio Files List -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">My Audio Files</h3>
                    <div id="my-audio-files-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

                <!-- Shared Audio Files List -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Shared Audio Files</h3>
                    <div id="shared-audio-files-list" class="space-y-2">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer for User ID and Credit -->
        <footer class="text-center p-4 mt-8 text-gray-500 text-sm border-t border-gray-200">
            <p class="mb-2">Web app enhanced by Google Gemini</p>
            <p>
                <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded">...</code>
            </p>
        </footer>
        
        <!-- Hidden file input for restore -->
        <input type="file" id="restore-file-input" class="hidden" accept="application/json,.json">

    </div>

        <!-- Firebase and App Logic -->
        <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signOut, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, writeBatch, setLogLevel, deleteDoc, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll, getMetadata, updateMetadata, getBytes } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- DOM Elements ---
        const welcomeOverlay = document.getElementById('welcome-overlay');
        const audioOverlay = document.getElementById('audio-overlay');
        const startAudioBtn = document.getElementById('start-audio-btn');
        
        const googleStartBtn = document.getElementById('google-start-btn');
        const anonymousStartBtn = document.getElementById('anonymous-start-btn');
        
        const countdownElement = document.getElementById('countdown-display');
        const clockElement = document.getElementById('live-clock-sentence');
        const statusElement = document.getElementById('status-message');
        const nextBellElement = document.getElementById('next-bell-sentence');
        const userIdElement = document.getElementById('userIdDisplay');
        const userDisplayNameElement = document.getElementById('user-display-name');
        const scheduleSelector = document.getElementById('schedule-selector');
        const scheduleTitle = document.getElementById('schedule-title');
        const adminToggleBtn = document.getElementById('admin-toggle');

        // Quick Bell Elements
        const quickBellControls = document.getElementById('quickBellControls');
        const quickBellSoundSelect = document.getElementById('quickBellSoundSelect');

        // MODIFIED v4.00: Personal Bell/Period Forms
        const addPersonalPeriodForm = document.getElementById('add-personal-period-form');
        const personalPeriodNameInput = document.getElementById('personal-period-name');
        const addPersonalPeriodStatus = document.getElementById('add-personal-period-status');
        
        const addBellToPersonalPeriodForm = document.getElementById('add-bell-to-personal-period-form');
        const personalPeriodSelect = document.getElementById('personal-period-select');
        const personalTimeInput = document.getElementById('personal-bell-time');
        const personalNameInput = document.getElementById('personal-bell-name'); 
        const personalSoundInput = document.getElementById('personal-bell-sound');
        const personalBellStatus = document.getElementById('personal-bell-status');
        const previewPersonalSoundBtn = document.getElementById('preview-personal-sound');
        const deletePersonalScheduleBtn = document.getElementById('delete-personal-schedule-btn');

        // Combined List
        const combinedBellListElement = document.getElementById('combined-bell-list');
        
        // MODIFIED v4.00: Admin Zone Forms
        const addPeriodForm = document.getElementById('add-period-form');
        const sharedPeriodNameInput = document.getElementById('shared-period-name');
        const addPeriodStatus = document.getElementById('add-period-status');
        
        const addBellToPeriodForm = document.getElementById('add-bell-to-period-form');
        const sharedPeriodSelect = document.getElementById('shared-period-select');
        const sharedTimeInput = document.getElementById('shared-bell-time');
        const sharedNameInput = document.getElementById('shared-bell-name');
        const sharedSoundInput = document.getElementById('shared-bell-sound');
        const previewSharedSoundBtn = document.getElementById('preview-shared-sound');
        const addSharedStatus = document.getElementById('add-shared-status');
        
        // DELETED v4.00: Multi-Add Bell Modal Elements
        
        // Edit Bell Modal
        const editBellModal = document.getElementById('edit-bell-modal');
        const editBellForm = document.getElementById('edit-bell-form');
        const editBellTimeInput = document.getElementById('edit-bell-time');
        const editBellNameInput = document.getElementById('edit-bell-name');
        const editBellSoundInput = document.getElementById('edit-bell-sound');
        const editBellCancelBtn = document.getElementById('edit-bell-cancel');
        const editBellSubmitBtn = document.getElementById('edit-bell-submit');
        const editBellStatus = document.getElementById('edit-bell-status');

        // NEW v4.00: Edit Period Modal
        const editPeriodModal = document.getElementById('edit-period-modal');
        const editPeriodForm = document.getElementById('edit-period-form');
        const editPeriodNameInput = document.getElementById('edit-period-name');
        const editPeriodCancelBtn = document.getElementById('edit-period-cancel');

        // NEW v4.00: Delete Period Modal
        const confirmDeletePeriodModal = document.getElementById('confirm-delete-period-modal');
        const confirmDeletePeriodText = document.getElementById('confirm-delete-period-text');
        const deletePeriodConfirmBtn = document.getElementById('delete-period-confirm');
        const deletePeriodCancelBtn = document.getElementById('delete-period-cancel');

        // Change Sound Modal
        const changeSoundModal = document.getElementById('change-sound-modal');
        const changeSoundForm = document.getElementById('change-sound-form');
        const changeSoundBellName = document.getElementById('change-sound-bell-name');
        const changeSoundBellTime = document.getElementById('change-sound-bell-time');
        const changeSoundSelect = document.getElementById('change-sound-select');
        const changeSoundCancelBtn = document.getElementById('change-sound-cancel');

        // DELETED v4.00: Linked Edit Modal Elements

        // Create/Delete Schedule
        const createScheduleForm = document.getElementById('create-schedule-form');
        const newScheduleNameInput = document.getElementById('new-schedule-name');
        const deleteScheduleBtn = document.getElementById('delete-schedule-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmDeleteText = document.getElementById('confirm-delete-text');
        const deleteConfirmBtn = document.getElementById('delete-confirm');
        const deleteCancelBtn = document.getElementById('delete-cancel'); 

        // Create/Delete Personal Schedule
        const createPersonalScheduleBtn = document.getElementById('create-personal-schedule-btn');
        const createPersonalScheduleModal = document.getElementById('create-personal-schedule-modal');
        const createPersonalScheduleForm = document.getElementById('create-personal-schedule-form');
        const personalBaseScheduleName = document.getElementById('personal-base-schedule-name');
        const newPersonalScheduleNameInput = document.getElementById('new-personal-schedule-name');
        const createPersonalScheduleStatus = document.getElementById('create-personal-schedule-status');
        const createPersonalScheduleCancelBtn = document.getElementById('create-personal-schedule-cancel');
        const confirmDeletePersonalModal = document.getElementById('confirm-delete-personal-modal');
        const confirmDeletePersonalText = document.getElementById('confirm-delete-personal-text');
        const deletePersonalConfirmBtn = document.getElementById('delete-personal-confirm');
        const deletePersonalCancelBtn = document.getElementById('delete-personal-cancel');

        // Personal Schedule Manager Buttons
        const renamePersonalScheduleBtn = document.getElementById('rename-personal-schedule-btn');
        const backupPersonalScheduleBtn = document.getElementById('backup-personal-schedule-btn');
        const restorePersonalScheduleBtn = document.getElementById('restore-personal-schedule-btn');
        const restoreFileInput = document.getElementById('restore-file-input');
        
        // Restore Modal
        const confirmRestoreModal = document.getElementById('confirm-restore-modal');
        const confirmRestoreText = document.getElementById('confirm-restore-text');
        const restoreConfirmBtn = document.getElementById('restore-confirm');
        const restoreCancelBtn = document.getElementById('restore-cancel');

        // Delete Bell Modal
        const confirmDeleteBellModal = document.getElementById('confirm-delete-bell-modal');
        const confirmDeleteBellText = document.getElementById('confirm-delete-bell-text');
        const deleteBellConfirmBtn = document.getElementById('delete-bell-confirm');
        const deleteBellCancelBtn = document.getElementById('delete-bell-cancel');

        // Delete Audio Modal
        const confirmDeleteAudioModal = document.getElementById('confirm-delete-audio-modal');
        const confirmDeleteAudioText = document.getElementById('confirm-delete-audio-text');
        const confirmDeleteAudioList = document.getElementById('confirm-delete-audio-list');
        const deleteAudioConfirmBtn = document.getElementById('delete-audio-confirm');
        const deleteAudioCancelBtn = document.getElementById('delete-audio-cancel');

        // Nearby Bell Warning Modal (Simplified)
        const nearbyBellModal = document.getElementById('nearby-bell-modal');
        const nearbyBellName = document.getElementById('nearby-bell-name');
        const nearbyBellTime = document.getElementById('nearby-bell-time');
        const nearbyBellStatus = document.getElementById('nearby-bell-status');
        const nearbyBellCustomControls = document.getElementById('nearby-bell-custom-controls');
        const nearbyBellCancelBtn = document.getElementById('nearby-bell-cancel');
        const nearbyBellAddAnywayBtn = document.getElementById('nearby-bell-add-anyway');
        
        // DELETED v4.00: All v3.02 complex conflict modal elements

        // Import/Export Elements
        const exportSchedulesBtn = document.getElementById('export-schedules-btn');
        const importSchedulesBtn = document.getElementById('import-schedules-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importStatus = document.getElementById('import-status');

        // Audio Manager Elements
        const audioUploadInput = document.getElementById('audio-upload-input');
        const audioFileName = document.getElementById('audio-file-name');
        const audioUploadBtn = document.getElementById('audio-upload-btn');
        const audioUploadStatus = document.getElementById('audio-upload-status');
        const myAudioFilesList = document.getElementById('my-audio-files-list');
        const sharedAudioFilesList = document.getElementById('shared-audio-files-list');

        const signOutBtn = document.getElementById('signout-btn');

        // Admin Email List
        const ADMIN_EMAIL_LIST = [
           'jacob.v.wilson@gmail.com'
           // Add more emails here in the future
        ];

        // --- App State ---
        let db, auth, storage;
        let userId;
        let isUserAnonymous = true;
        
        // MODIFIED v4.00: State for Period-based structure
        let baseSchedule = null; // Holds { id, name, periods: [] } of the active base shared schedule
        let personalSchedule = null; // Holds { id, name, baseScheduleId, periods: [] } of the active personal schedule
        
        let scheduleRef; // Firestore ref for base schedule
        let schedulesCollectionRef; // Firestore ref for all shared schedules
        let allSchedules = []; // Array of *all* shared schedules (still needed for selector)
        let allPersonalSchedules = []; // Array of *user's* personal schedules (still needed for selector)
        let activeBaseScheduleId = null; 
        let activePersonalScheduleId = null;
        let activeScheduleListenerUnsubscribe = null; 
        let activePersonalScheduleListenerUnsubscribe = null;
        let personalSchedulesListenerUnsubscribe = null;
        
        let synths = {}; 
        let lastBellRingTime = null; 
        let lastRingTimestamp = 0;
        const RING_COOLDOWN = 5000;
        let clockIntervalId = null; 
        
        let currentEditingBell = null; // MODIFIED v4.00: Will now include { periodId, periodType }
        let currentEditingPeriod = null; // NEW v4.00: For editing a period
        let currentChangingSoundBell = null; 
        let bellToDelete = null; // MODIFIED v4.00: Will now include { periodId, periodType }
        let periodToDelete = null; // NEW v4.00: For deleting a period
        let audioToDelete = null; 

        // MODIFIED v4.00: Renamed pendingPersonalBell to pendingBell
        let pendingBell = null; // Used by nearby-bell-modal for { bell, periodId, periodType }
        
        // DELETED v4.00: All complex conflict state
        
        let pendingRestoreData = null;

        // Quick Bell State
        let quickBellEndTime = null;
        let quickBellSound = 'ellisBell.mp3'; 

        let mutedBellIds = new Set(); 
        let bellSoundOverrides = {}; 

        let appId; 
        let isAudioReady = false; 
        
        // Audio file state
        let userAudioFiles = []; // { name, url, path }
        let sharedAudioFiles = []; // { name, url, path }
        let fileToUpload = null; 
        const MAX_FILE_SIZE = 1024 * 1024; // 1MB

        // --- Mute Helper Functions ---
        function getBellId(bell) {
            if (!bell || !bell.type || !bell.time || !bell.name) return null;
            const safeName = bell.name.replace(/"/g, '&quot;');
            return `${bell.type}-${bell.time}-${safeName}`;
        }

        function loadMutedBells() {
            try {
                const stored = localStorage.getItem('mutedBellIds');
                if (stored) {
                    mutedBellIds = new Set(JSON.parse(stored));
                    console.log(`Loaded ${mutedBellIds.size} muted bell IDs.`);
                }
            } catch (e) {
                console.error("Failed to load muted bells", e);
                mutedBellIds = new Set();
            }
        }

        function saveMutedBells() {
            try {
                localStorage.setItem('mutedBellIds', JSON.stringify([...mutedBellIds]));
            } catch (e) {
                console.error("Failed to save muted bells", e);
            }
        }

        // --- Sound Override Functions ---
        function getBellOverrideKey(scheduleId, bell) {
            if (!scheduleId || !bell) return null;
            if (bell.type !== 'shared') return null;
            const bellId = getBellId(bell);
            if (!bellId) return null;
            return `${scheduleId}-${bellId}`;
        }

        function loadSoundOverrides() {
            try {
                const stored = localStorage.getItem('bellSoundOverrides');
                if (stored) {
                    bellSoundOverrides = JSON.parse(stored);
                    console.log(`Loaded ${Object.keys(bellSoundOverrides).length} sound overrides.`);
                }
            } catch (e) {
                console.error("Failed to load sound overrides", e);
                bellSoundOverrides = {};
            }
        }

        function saveSoundOverrides() {
            try {
                localStorage.setItem('bellSoundOverrides', JSON.stringify(bellSoundOverrides));
            } catch (e) {
                console.error("Failed to save sound overrides", e);
            }
        }

        // Helper to format 24h time to 12h AM/PM
        function formatTime12Hour(timeString) {
            if (!timeString) return "--:--";
            
            try {
                const parts = timeString.split(':');
                if (parts.length < 2) return timeString; 

                let [hours, minutes, seconds] = parts;
                hours = parseInt(hours, 10);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                
                if (seconds) {
                    return `${hours}:${minutes}:${seconds} ${ampm}`;
                } else {
                    return `${hours}:${minutes} ${ampm}`;
                }
            } catch (e) {
                console.error("Error formatting time:", e);
                return timeString; // Fallback to original
            }
        }

        // --- NEW v4.00: Data Migration Logic ---
        /**
         * Converts a v3 schedule (flat bells array) to a v4 schedule (period-based).
         * @param {object} scheduleData - The raw data from Firestore
         * @returns {object} A v4-compatible schedule object { name, periods }
         */
        function migrateScheduleData(scheduleData) {
            if (!scheduleData) return { name: "Not Found", periods: [] };

            // If it *already* has periods, it's v4 data. Just return it.
            if (scheduleData.periods && Array.isArray(scheduleData.periods)) {
                // Ensure all periods have an ID
                const newPeriods = scheduleData.periods.map(p => ({
                    id: p.id || crypto.randomUUID(), // Add ID if missing
                    name: p.name,
                    bells: p.bells || []
                }));
                return { ...scheduleData, periods: newPeriods };
            }

            // If it has 'bells' but not 'periods', it's v3 data. Migrate it.
            if (scheduleData.bells && Array.isArray(scheduleData.bells)) {
                console.log(`Migrating v3 schedule: ${scheduleData.name}`);
                return {
                    ...scheduleData,
                    periods: [
                        {
                            id: 'general', // A consistent ID for the default migrated period
                            name: 'General Bells',
                            bells: scheduleData.bells
                        }
                    ]
                    // We don't delete scheduleData.bells, just in case
                };
            }

            // If it's a new or empty schedule, return a valid v4 structure
            return { ...scheduleData, periods: [] };
        }


        // --- Audio Setup (Tone.js) ---
        async function startAudio() {
            if (isAudioReady) return;
            try {
                await Tone.start();
                console.log("AudioContext started.");
                setupSynths();
                isAudioReady = true;
                statusElement.textContent = "Audio ready. Monitoring bells...";

                // MODIFIED v4.01: This function now hides the overlay
                audioOverlay.classList.add('hidden');
                startAudioBtn.disabled = true; // Prevent re-click

                if (auth.currentUser) {
                    console.log("Audio ready, user signed in. Starting clock.");
                    if (clockIntervalId) clearInterval(clockIntervalId);
                    updateClock(); 
                    clockIntervalId = setInterval(updateClock, 1000);
                }

            } catch (e) {
                console.error("Audio start failed:", e);
                statusElement.textContent = "Error starting audio. Please refresh.";
                throw e; // Re-throw to be caught by the button listener
            }
        }

        function setupSynths() {
            // Setup default synths
            synths['Bell'] = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.4, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();

            synths['Chime'] = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 }
            }).toDestination();

            synths['Beep'] = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.05 }
            }).toDestination();

            synths['Alarm'] = new Tone.MonoSynth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.2, release: 0.1 }
            }).toDestination();
            
            synths['ellisBell.mp3'] = new Tone.Player("ellisBell.mp3").toDestination();
        }

        async function playBell(soundName) {
            // MODIFIED v4.01: Removed the faulty try/catch startAudio()
            if (!isAudioReady) {
                console.warn("Audio not ready. Cannot play bell. User must click 'Start Audio' button.");
                return;
            }

            const now = Tone.now();

            // --- Handle HTTP URLs (Firebase Storage) ---
            if (soundName.startsWith('http')) {
                try {
                    // Case 1: Player is already cached (as a promise)
                    if (synths[soundName]) {
                        const player = await synths[soundName]; // Wait for the promise
                        if (player && player.loaded) {
                            player.start(now);
                        } else if (player) {
                            console.warn(`Cached player for ${soundName} was not loaded.`);
                        }
                        return;
                    }

                    // Case 2: Player is not in cache. Create, load, and cache it.
                    console.log(`Fetching and caching new sound: ${soundName}`);
                    
                    const loadPromise = (async () => {
                        try {
                            // MODIFICATION: We can't use getBytes with just the URL.
                            // We need a path. But we don't have the path here.
                            // We *must* use Tone.Player's built-in URL loading.
                            const player = await new Tone.Player(soundName).toDestination().load(soundName);
                            console.log(`Successfully loaded: ${soundName}`);
                            return player; // Promise resolves to a loaded player
                        } catch (err) {
                            console.error(`Failed to load custom audio: ${soundName}`, err);
                            delete synths[soundName]; 
                            return null;
                        }
                    })();
                    
                    synths[soundName] = loadPromise;
                    const newPlayer = await loadPromise;
                    
                    if (newPlayer) {
                        newPlayer.start(now); // Play it
                    }

                } catch (e) {
                    console.error(`Error playing custom sound ${soundName}:`, e);
                    delete synths[soundName]; // Clear cache on error
                }
                return; // Handled http, now exit
            }


            // --- Handle built-in synths (existing code) ---
            if (!synths[soundName]) {
                console.warn(`Sound '${soundName}' not found.`);
                return;
            }

            const synth = synths[soundName];

            try {
                if (synth instanceof Tone.Player) {
                    // This is for 'ellisBell.mp3'
                    if (synth.loaded) {
                        synth.start(now);
                    } else {
                        console.warn(`Sound ${soundName} not loaded yet. Attempting to load and play.`);
                        // Ensure it's loading the correct local path
                        const localPath = (soundName === 'ellisBell.mp3') ? soundName : soundName; // Just in case
                        synth.load(localPath).then(() => {
                            synth.start(now);
                        }).catch(err => {
                            console.error(`Failed to load and play default audio: ${soundName}`, err);
                        });
                    }
                } else {
                     // Handle built-in synths
                    if (soundName === 'Bell') {
                        synth.triggerAttackRelease('C4', '0.5', now);
                        synth.triggerAttackRelease('G4', '0.5', now + 0.3);
                    } else if (soundName === 'Chime') {
                        synth.triggerAttackRelease('G5', '0.8', now);
                        synth.triggerAttackRelease('E6', '0.8', now + 0.5);
                    } else if (soundName === 'Beep') {
                        synth.triggerAttackRelease('A5', '0.1', now);
                    } else if (soundName === 'Alarm') {
                        synth.triggerAttackRelease("C5", "0.1", now);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.15);
                        synth.triggerAttackRelease("C5", "0.1", now + 0.3);
                    }
                }
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }

        // --- Clock and Bell Logic ---

        // MODIFIED v4.00: Rewritten to get bells from period-based state
        function findNextBell(currentTimeHHMMSS) {
            
            const basePeriods = baseSchedule?.periods || [];
            const personalPeriods = personalSchedule?.periods || [];
            
            const allBells = [];

            // Get base bells and apply overrides
            basePeriods.forEach(p => allBells.push(...(p.bells || []).map(bell => {
                const overrideKey = getBellOverrideKey(baseSchedule.id, { ...bell, type: 'shared' });
                const overrideSound = bellSoundOverrides[overrideKey];
                return { 
                    ...bell, 
                    type: 'shared',
                    sound: overrideSound || bell.sound,
                    originalSound: bell.sound,
                    periodName: p.name, // For context
                    periodId: p.id,
                    periodType: 'shared'
                };
            })));
            
            // Get personal bells
            personalPeriods.forEach(p => allBells.push(...(p.bells || []).map(bell => ({
                ...bell,
                type: 'custom',
                originalSound: bell.sound, // Custom bells don't have overrides
                periodName: p.name,
                periodId: p.id,
                periodType: 'custom'
            }))));

            if (allBells.length === 0) return null;
            
            let upcomingBells = allBells.filter(bell => bell.time > currentTimeHHMMSS);
            
            let nextBell;
            if (upcomingBells.length > 0) {
                upcomingBells.sort((a, b) => a.time.localeCompare(b.time));
                nextBell = upcomingBells[0];
            } else {
                allBells.sort((a, b) => a.time.localeCompare(b.time));
                nextBell = allBells[0];
            }
            return nextBell;
        }

        function updateClock() {
            const now = new Date();
            const nowTimestamp = now.getTime();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentTimeHHMMSS = `${hours}:${minutes}:${seconds}`;

            clockElement.textContent = `The time is ${currentTimeHHMMSS}. There are`;
            
            const nextBell = findNextBell(currentTimeHHMMSS);
            
            // Quick Bell + Schedule Bell Countdown Logic
            let millisToScheduleBell = Infinity;
            if (nextBell) {
                const [h, m, s] = nextBell.time.split(':').map(Number);
                const nextBellDate = new Date();
                nextBellDate.setHours(h, m, s, 0);
                millisToScheduleBell = nextBellDate.getTime() - nowTimestamp;
                if (millisToScheduleBell < 0) {
                    nextBellDate.setDate(nextBellDate.getDate() + 1);
                    millisToScheduleBell = nextBellDate.getTime() - nowTimestamp;
                }
            }

            const millisToQuickBell = quickBellEndTime ? quickBellEndTime.getTime() - nowTimestamp : Infinity;
            
            let activeTimerLabel = null;
            let activeTimerMillis = Infinity;
            let isMuting = false;

            if (millisToScheduleBell < millisToQuickBell && nextBell) {
                activeTimerLabel = nextBell.name;
                activeTimerMillis = millisToScheduleBell;
                const nextBellId = getBellId(nextBell);
                isMuting = mutedBellIds.has(nextBellId);
            } else if (millisToQuickBell < millisToScheduleBell) {
                activeTimerLabel = "Quick Bell";
                activeTimerMillis = millisToQuickBell;
                isMuting = false;
            }

            if (activeTimerLabel) {
                let totalSeconds = Math.max(0, Math.floor(activeTimerMillis / 1000));
                let cdHours = Math.floor(totalSeconds / 3600);
                totalSeconds %= 3600;
                let cdMinutes = Math.floor(totalSeconds / 60);
                let cdSeconds = totalSeconds % 60;
                let countdownString;
                
                if (cdHours > 0) {
                    countdownString = `${cdHours}:${String(cdMinutes).padStart(2, '0')}:${String(cdSeconds).padStart(2, '0')}`;
                } else if (cdMinutes > 0 || cdHours > 0) {
                    countdownString = `${cdMinutes}:${String(cdSeconds).padStart(2, '0')}`;
                } else {
                    countdownString = `${cdSeconds}`;
                }
                countdownElement.textContent = countdownString;
                
                if (isMuting) {
                    nextBellElement.textContent = `until ${activeTimerLabel} (MUTED)`;
                } else {
                    nextBellElement.textContent = `until ${activeTimerLabel}`;
                }
            } else {
                countdownElement.textContent = "--:--";
                nextBellElement.textContent = "until the next bell.";
            }

            // --- Ring Logic (Scheduled Bells) ---
            // We call findNextBell again, but this is fine.
            // A more efficient way would be to get *all* bells,
            // but findNextBell is fast enough.
            // RE-THINK: findNextBell *only* finds the *next* one.
            // We need to find the one for *right now*.
            
            // MODIFIED v4.00: This logic must be rebuilt
            const basePeriods = baseSchedule?.periods || [];
            const personalPeriods = personalSchedule?.periods || [];
            const allCurrentBells = [];
            basePeriods.forEach(p => allCurrentBells.push(...(p.bells || []).map(b => ({...b, type: 'shared'}))));
            personalPeriods.forEach(p => allCurrentBells.push(...(p.bells || []).map(b => ({...b, type: 'custom'}))));
            
            const bellToRing = allCurrentBells.find(bell => bell.time === currentTimeHHMMSS);
            
            if (bellToRing && lastBellRingTime !== currentTimeHHMMSS && (nowTimestamp - lastRingTimestamp > RING_COOLDOWN)) {
                // Re-apply override logic *here* for ringing
                let finalBellToRing = { ...bellToRing };
                if (finalBellToRing.type === 'shared') {
                    const overrideKey = getBellOverrideKey(baseSchedule.id, finalBellToRing);
                    const overrideSound = bellSoundOverrides[overrideKey];
                    finalBellToRing.sound = overrideSound || finalBellToRing.sound;
                }
                
                const bellId = getBellId(finalBellToRing);
                if (mutedBellIds.has(bellId)) {
                    console.log(`Skipping bell (Muted): ${finalBellToRing.name}`);
                    statusElement.textContent = `Skipped (Muted): ${finalBellToRing.name}`;
                } else {
                    ringBell(finalBellToRing);
                }
                lastBellRingTime = currentTimeHHMMSS;
                lastRingTimestamp = nowTimestamp;
            }
            
            // --- Ring Logic (Quick Bell) ---
            if (quickBellEndTime && nowTimestamp >= quickBellEndTime.getTime() && (nowTimestamp - lastRingTimestamp > RING_COOLDOWN)) {
                console.log("Ringing Quick Bell");
                ringBell({ name: "Quick Bell", sound: quickBellSound });
                lastRingTimestamp = nowTimestamp;
                quickBellEndTime = null; 
                lastBellRingTime = null;
            }

            // Reset status text logic
            if (lastBellRingTime && lastBellRingTime !== currentTimeHHMMSS && (nowTimestamp - lastRingTimestamp > RING_COOLDOWN)) {
                lastBellRingTime = null;
                if (isAudioReady) statusElement.textContent = "Monitoring...";
            }
        }

        // Quick Bell Function
        function startQuickBell(minutes) {
            const now = new Date();
            quickBellEndTime = new Date(now.getTime() + minutes * 60000);
            console.log(`Quick bell set for ${minutes} minutes from now.`);
            updateClock(); // Update display immediately
        }
        
        async function ringBell(bell) {
            console.log("Ringing bell:", bell.name);
            await playBell(bell.sound); 
            statusElement.textContent = `Ringing: ${bell.name}`;
            const safeName = bell.name.replace(/"/g, '&quot;');
            
            // MODIFIED v4.00: Ring animation
            const bellElement = document.querySelector(`[data-time="${bell.time}"][data-name="${safeName}"]`);
            if (bellElement) {
                bellElement.classList.add('bg-blue-100');
                setTimeout(() => {
                    bellElement.classList.remove('bg-blue-100');
                }, 3000); 
            }
        }
        
        // --- NEW v4.00: Helper to get all periods
        function getAllPeriods() {
            const basePeriods = (baseSchedule?.periods || []).map(p => ({...p, periodType: 'shared', scheduleName: baseSchedule.name }));
            const personalPeriods = (personalSchedule?.periods || []).map(p => ({...p, periodType: 'custom', scheduleName: personalSchedule.name }));
            
            let allPeriods = [...basePeriods, ...personalPeriods];
            
            // Sort periods by their *first* bell
            allPeriods.sort((a, b) => {
                const firstBellA = (a.bells || []).sort((b1, b2) => b1.time.localeCompare(b2.time))[0];
                const firstBellB = (b.bells || []).sort((b1, b2) => b1.time.localeCompare(b2.time))[0];
                
                const timeA = firstBellA ? firstBellA.time : '23:59:59';
                const timeB = firstBellB ? firstBellB.time : '23:59:59';
                
                return timeA.localeCompare(timeB);
            });
            
            return allPeriods;
        }


        // --- Render Functions ---
        // MODIFIED v4.00: Complete rewrite to render periods
        function renderCombinedList() {
            const allPeriods = getAllPeriods();

            if (allPeriods.length === 0) {
                combinedBellListElement.innerHTML = `
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-8 text-center text-gray-500">No periods or bells scheduled.</div>
                </div>`;
                return;
            }

            combinedBellListElement.innerHTML = allPeriods.map(period => {
                const sortedBells = [...(period.bells || [])].sort((a, b) => a.time.localeCompare(b.time));
                const isCustomPeriod = period.periodType === 'custom';

                return `
                <div class="mb-6">
                    <!-- Period Header -->
                    <div class="bg-white rounded-t-xl shadow-md flex items-center justify-between p-4 border-b border-gray-200">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">${period.name}</h3>
                            ${isCustomPeriod ? 
                                `<span class="text-xs font-semibold bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full">PERSONAL PERIOD</span>` :
                                (personalSchedule ? `<span class="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">SHARED</span>` : '')
                            }
                        </div>
                        <!-- NEW v4.00: Period-level admin controls -->
                        <div class="period-admin-controls hidden items-center space-x-2">
                            <button class="edit-period-btn px-2 py-1 text-xs bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                    data-period-id="${period.id}"
                                    data-period-name="${period.name.replace(/"/g, '&quot;')}"
                                    data-period-type="${period.periodType}"
                                    title="Edit period name">Edit</button>
                            <button class="delete-period-btn px-2 py-1 text-xs bg-red-500 text-white rounded-lg hover:bg-red-600"
                                    data-period-id="${period.id}"
                                    data-period-name="${period.name.replace(/"/g, '&quot;')}"
                                    data-period-type="${period.periodType}"
                                    title="Delete period">Delete</button>
                        </div>
                    </div>
                    
                    <!-- Bells for this period -->
                    <div class="bg-white rounded-b-xl shadow-md overflow-hidden">
                        ${sortedBells.length > 0 ? sortedBells.map((bell, index) => {
                            const isCustomBell = period.periodType === 'custom'; // All bells in a custom period are custom
                            const isFirst = index === 0;
                            const safeName = bell.name.replace(/"/g, '&quot;');
                            
                            // Apply overrides for shared bells
                            let displaySound = bell.sound;
                            let originalSound = bell.sound;
                            let isOverridden = false;
                            
                            if (!isCustomBell) {
                                originalSound = bell.sound;
                                const overrideKey = getBellOverrideKey(baseSchedule.id, {...bell, type: 'shared'});
                                const override = bellSoundOverrides[overrideKey];
                                if (override) {
                                    displaySound = override;
                                    isOverridden = true;
                                }
                            }
                            
                            const bellId = getBellId({ ...bell, type: isCustomBell ? 'custom' : 'shared' });
                            const isMuted = mutedBellIds.has(bellId);

                            // Truncate long sound URLs for display
                            let soundDisplay = displaySound;
                            if (soundDisplay && soundDisplay.startsWith('http')) {
                                try {
                                    const url = new URL(soundDisplay);
                                    let path = decodeURIComponent(url.pathname.split('/').pop());
                                    soundDisplay = path.split('/').pop();
                                } catch (e) {
                                    soundDisplay = "Custom Sound";
                                }
                            } else if (soundDisplay === 'ellisBell.mp3') {
                                soundDisplay = "Ellis Bell";
                            } else if (!soundDisplay) {
                                soundDisplay = "No Sound";
                            }
                            
                            if (isOverridden) {
                                soundDisplay = `Custom: ${soundDisplay}`;
                            }


                            return `
                                <div class="bell-item flex items-center justify-between p-4 ${!isFirst ? 'border-t border-gray-200' : ''} hover:bg-gray-50 transition-colors"
                                     data-time="${bell.time}" data-name="${safeName}" 
                                     data-sound="${displaySound}" data-type="${isCustomBell ? 'custom' : 'shared'}"
                                     data-original-sound="${originalSound}"
                                     data-period-id="${period.id}"
                                     data-period-type="${period.periodType}">
                                    
                                    <div class="flex items-center space-x-4 min-w-0 flex-grow">
                                        <span class="text-xl font-medium text-blue-600 tabular-nums">${formatTime12Hour(bell.time)}</span>
                                        <div class="min-w-0">
                                            <span class="font-medium text-gray-800 truncate block" title="${safeName}">${safeName}</span>
                                            <span class="text-sm ${isOverridden ? 'text-blue-600' : 'text-gray-500'} truncate block" title="${displaySound}">(${soundDisplay})</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex-shrink-0 flex items-center space-x-4">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <span class="text-sm font-medium text-gray-700">Mute</span>
                                            <input type="checkbox" class="bell-mute-toggle h-5 w-5 text-blue-600 rounded focus:ring-blue-500" 
                                                   data-bell-id="${bellId}" ${isMuted ? 'checked' : ''} 
                                                   aria-label="Mute this bell">
                                        </label>

                                        <div class="flex-shrink-0 space-x-2">
                                            <button class="sound-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                                                    style="${isCustomBell ? 'display: none;' : ''}"
                                                    aria-label="Change sound for ${safeName}"
                                                    title="Change sound">Sound</button>
                                            
                                            <button class="edit-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                                    style="${isCustomBell ? 'display: none;' : ''}"
                                                    aria-label="Edit shared bell ${safeName}"
                                                    title="Edit shared bell">Edit</button>
                                            
                                            <button class="delete-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"
                                                    style="${isCustomBell ? 'display: none;' : ''}"
                                                    aria-label="Delete shared bell ${safeName}"
                                                    title="Delete shared bell">Delete</button>
                                            
                                            <button class="edit-custom-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
                                                    style="${!isCustomBell ? 'display: none;' : ''}"
                                                    aria-label="Edit custom bell ${safeName}"
                                                    title="Edit custom bell">Edit</button>
                                            
                                            <button class="delete-custom-btn px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"
                                                    style="${!isCustomBell ? 'display: none;' : ''}"
                                                    aria-label="Delete custom bell ${safeName}"
                                                    title="Delete custom bell">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<div class="p-4 text-sm text-center text-gray-500">No bells in this period.</div>'}
                    </div>
                </div>
                `;
            }).join('');
        }

        // MODIFIED v4.00: Re-renders and populates period dropdowns
        function renderScheduleSelector() {
            const lastSelectedId = localStorage.getItem('activeScheduleId') || (allSchedules.length > 0 ? `shared-${allSchedules[0].id}` : '');
            
            if (allSchedules.length === 0 && allPersonalSchedules.length === 0) {
                 scheduleSelector.innerHTML = '<option value="">No schedules found. Create one!</option>';
                 setActiveSchedule(""); 
                 return;
            }
            
            let personalOptions = allPersonalSchedules.map(schedule => 
                `<option value="personal-${schedule.id}" ${`personal-${schedule.id}` === lastSelectedId ? 'selected' : ''}>
                    ${schedule.name} (Personal)
                </option>`
            ).join('');

            let sharedOptions = allSchedules.map(schedule => 
                `<option value="shared-${schedule.id}" ${`shared-${schedule.id}` === lastSelectedId ? 'selected' : ''}>
                    ${schedule.name}
                </option>`
            ).join('');

            scheduleSelector.innerHTML = `
                <optgroup label="My Personal Schedules" id="personal-schedules-optgroup">
                    ${personalOptions || '<option value="" disabled>No personal schedules created.</option>'}
                </optgroup>
                <optgroup label="Shared Schedules" id="shared-schedules-optgroup">
                    ${sharedOptions}
                </optgroup>
            `;
            
            // If the lastSelectedId isn't in the list, default to the first shared schedule
            if (scheduleSelector.value) {
                const currentActive = activePersonalScheduleId ? `personal-${activePersonalScheduleId}` : `shared-${activeBaseScheduleId}`;
                if (scheduleSelector.value !== currentActive) {
                    setActiveSchedule(scheduleSelector.value);
                }
            } else if (allSchedules.length > 0) {
                setActiveSchedule(`shared-${allSchedules[0].id}`);
            } else {
                setActiveSchedule(``); // No schedules at all
            }
            
            // NEW v4.00: Update period dropdowns
            updatePeriodDropdowns();
        }
        
        // --- NEW v4.00: Helper to populate period dropdowns
        function updatePeriodDropdowns() {
            // 1. Shared Period Dropdown (Admin Zone)
            const basePeriods = baseSchedule?.periods || [];
            if (basePeriods.length > 0) {
                sharedPeriodSelect.innerHTML = basePeriods.map(p => 
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
                sharedPeriodSelect.disabled = false;
                // Enable form
                addBellToPeriodForm.querySelector('button[type="submit"]').disabled = false;
                sharedTimeInput.disabled = false;
                sharedNameInput.disabled = false;
                sharedSoundInput.disabled = false;
                previewSharedSoundBtn.disabled = false;
            } else {
                sharedPeriodSelect.innerHTML = `<option value="">No periods in this schedule</option>`;
                sharedPeriodSelect.disabled = true;
                // Disable form
                addBellToPeriodForm.querySelector('button[type="submit"]').disabled = true;
                sharedTimeInput.disabled = true;
                sharedNameInput.disabled = true;
                sharedSoundInput.disabled = true;
                previewSharedSoundBtn.disabled = true;
            }

            // 2. Personal Period Dropdown
            const personalPeriods = personalSchedule?.periods || [];
            if (personalPeriods.length > 0) {
                personalPeriodSelect.innerHTML = personalPeriods.map(p => 
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
                personalPeriodSelect.disabled = false;
                // Enable form
                addBellToPersonalPeriodForm.querySelector('button[type="submit"]').disabled = false;
                personalTimeInput.disabled = false;
                personalNameInput.disabled = false;
                personalSoundInput.disabled = false;
                previewPersonalSoundBtn.disabled = false;
            } else {
                personalPeriodSelect.innerHTML = `<option value="">No periods in this schedule</option>`;
                personalPeriodSelect.disabled = true;
                // Disable form
                addBellToPersonalPeriodForm.querySelector('button[type="submit"]').disabled = true;
                personalTimeInput.disabled = true;
                personalNameInput.disabled = true;
                personalSoundInput.disabled = true;
                previewPersonalSoundBtn.disabled = true;
            }
        }
        
        
        // Helper to convert "HH:MM:SS" to total seconds.
        function timeToSeconds(time) {
            try {
                const [h, m, s] = time.split(':').map(Number);
                return (h * 3600) + (m * 60) + (s || 0); 
            } catch (e) {
                return NaN;
            }
        }

        /**
         * Finds a bell within 60 seconds of the given time.
         * @param {string} time - The time to check (HH:MM:SS)
         * @param {Array} bellList - The list of bells to check against
         * @param {object} [excludeBell=null] - A bell object {time, name} to exclude from the check
         * @returns {object|null} The nearby bell object or null
         */
        function findNearbyBell(time, bellList, excludeBell = null) {
            const newTimeInSeconds = timeToSeconds(time);
            if (isNaN(newTimeInSeconds)) return null;

            for (const bell of bellList) {
                // Exclude the bell we're currently editing
                if (excludeBell && bell.time === excludeBell.time && bell.name === excludeBell.name) {
                    continue;
                }
                
                const existingTimeInSeconds = timeToSeconds(bell.time);
                if (isNaN(existingTimeInSeconds)) continue;

                if (Math.abs(newTimeInSeconds - existingTimeInSeconds) <= 60) {
                    return bell; // Found a bell within 60 seconds
                }
            }
            return null;
        }
        
        // Helper to close and reset the nearby bell modal
        function closeNearbyBellModal() {
            nearbyBellModal.classList.add('hidden');
            nearbyBellStatus.classList.add('hidden');
            pendingBell = null; 
        }

        // --- NEW v4.00: Unified function to add the pending bell (shared or custom)
        async function addPendingBell() {
            if (!pendingBell) return;
            
            const { bell, periodId, periodType } = pendingBell;
            
            let scheduleRef;
            let currentSchedule;
            
            try {
                if (periodType === 'custom') {
                    if (!activePersonalScheduleId) throw new Error("No active personal schedule.");
                    scheduleRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', activePersonalScheduleId);
                    currentSchedule = personalSchedule;
                } else {
                    if (!activeBaseScheduleId) throw new Error("No active base schedule.");
                    scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', activeBaseScheduleId);
                    currentSchedule = baseSchedule;
                }

                if (!currentSchedule) throw new Error("Could not find schedule data.");

                const updatedPeriods = currentSchedule.periods.map(p => {
                    if (p.id === periodId) {
                        const existingBells = p.bells || [];
                        if (existingBells.find(b => b.time === bell.time && b.name === bell.name)) {
                            console.warn("Bell already exists in this period.");
                            return p; // Don't add duplicate
                        }
                        const updatedBells = [...existingBells, bell];
                        return { ...p, bells: updatedBells };
                    }
                    return p;
                });
                
                await updateDoc(scheduleRef, { periods: updatedPeriods });
                
                if (periodType === 'custom') {
                    addBellToPersonalPeriodForm.reset();
                    personalSoundInput.value = 'ellisBell.mp3';
                } else {
                    addBellToPeriodForm.reset();
                    sharedSoundInput.value = 'ellisBell.mp3';
                }

            } catch (error) {
                console.error("Error adding pending bell:", error);
            } finally {
                closeNearbyBellModal();
            }
        }
        
        // MODIFIED v4.00: handleAddPersonalBell (now adds to period)
        async function handleAddPersonalBell(e) {
            e.preventDefault();
            const periodId = personalPeriodSelect.value;
            if (!activePersonalScheduleId || !periodId) {
                personalBellStatus.textContent = "Please select a personal schedule and period.";
                personalBellStatus.classList.remove('hidden');
                return;
            }

            const time = personalTimeInput.value;
            const name = personalNameInput.value;
            const sound = personalSoundInput.value;
            
            if (!time || !name) return;
            
            const newBell = { time, name, sound };
            
            const period = personalSchedule.periods.find(p => p.id === periodId);
            const nearbyBell = findNearbyBell(time, period.bells || []);
            
            if (nearbyBell) {
                pendingBell = { bell: newBell, periodId, periodType: 'custom' };
                nearbyBellName.textContent = nearbyBell.name;
                nearbyBellTime.textContent = formatTime12Hour(nearbyBell.time);
                nearbyBellCustomControls.style.display = 'flex';
                nearbyBellModal.classList.remove('hidden');
            } else {
                // No conflict, add directly
                try {
                    const scheduleRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', activePersonalScheduleId);
                    const updatedPeriods = personalSchedule.periods.map(p => {
                        if (p.id === periodId) {
                            const updatedBells = [...(p.bells || []), newBell];
                            return { ...p, bells: updatedBells };
                        }
                        return p;
                    });
                    
                    await updateDoc(scheduleRef, { periods: updatedPeriods });
                    addBellToPersonalPeriodForm.reset();
                    personalSoundInput.value = 'ellisBell.mp3';
                } catch (error) {
                    console.error("Error adding personal bell:", error);
                }
            }
        }

        // --- Firebase Logic ---
        async function initFirebase() {
            if (auth) return; 

            try {
                // This config is public and safe to embed.
                const firebaseConfig = {
                    apiKey: "AIzaSyDfo45UBu-pR8nqMQhVlS_QgyYZ2kzBdvM",
                    authDomain: "ellisbell-c185c.firebaseapp.com",
                    projectId: "ellisbell-c185c",
                    storageBucket: "ellisbell-c185c.firebasestorage.app",
                    appId: "1:441560045695:web:94e51a006663404b8f474a"
                };
                
                appId = "1:441560045695:web:94e51a006663404b8f474a";
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); 
                
                setLogLevel('Debug');
                
                 onAuthStateChanged(auth, async (user) => {
                    document.body.classList.remove('admin-mode');
                    adminToggleBtn.textContent = 'Toggle Admin';

                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        isUserAnonymous = user.isAnonymous; 
                        welcomeOverlay.classList.add('hidden'); 
                        
                        if (user.isAnonymous) {
                            document.body.classList.remove('not-anonymous');
                        } else {
                            document.body.classList.add('not-anonymous');
                        }
                        
                        if (!isAudioReady) {
                            console.log("User is signed in, but audio not ready. Showing audio start button.");
                            let btnText = "Click to Start Audio";
                            if (user.isAnonymous) {
                                btnText = "Click here to start the audio!";
                            } else {
                                const name = user.displayName || user.email;
                                btnText = `Welcome, ${name.split(' ')[0]}! Click to start audio.`;
                            }
                            startAudioBtn.textContent = btnText;
                            startAudioBtn.disabled = false; // Enable the button
                            audioOverlay.classList.remove('hidden');
                        } else {
                            console.log("User signed in, audio ready. Starting clock.");
                            if (clockIntervalId) clearInterval(clockIntervalId);
                            updateClock();
                            clockIntervalId = setInterval(updateClock, 1000);
                        }

                        document.body.classList.add('authenticated');
                        signOutBtn.classList.remove('hidden');
                        if (user.isAnonymous) {
                           userIdElement.textContent = `Anonymous ID: ${user.uid}`;
                           userDisplayNameElement.textContent = "Signed in as: Anonymous";
                        } else {
                           userIdElement.textContent = `User ID: ${user.uid}`;
                           const displayName = user.displayName || user.email;
                           userDisplayNameElement.textContent = `Signed in as: ${displayName}`;
                        }
 
                        let isAdmin = false; 
                        if (user.email && ADMIN_EMAIL_LIST.includes(user.email)) {
                            console.log("Admin email detected:", user.email);
                            try {
                                const adminDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', user.uid);
                                const adminDocSnap = await getDoc(adminDocRef);
                                
                                if (adminDocSnap.exists()) {
                                    console.log("Server admin status confirmed.");
                                    isAdmin = true;
                                } else {
                                    console.warn("Admin email found, but server-side admin document is missing.");
                                }
                            } catch (err) {
                                console.error("Error checking admin status:", err);
                            }
                        } else {
                            console.log("Standard user detected.");
                        }

                        if (isAdmin) {
                            adminToggleBtn.disabled = false;
                            adminToggleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            adminToggleBtn.title = "Toggle administrator controls";
                        } else {
                            adminToggleBtn.disabled = true;
                            adminToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            adminToggleBtn.title = "Admin access required";
                        }
                        
                        if (!user.isAnonymous) {
                            listenForPersonalSchedules(user.uid);
                        } else {
                            allPersonalSchedules = [];
                        }
                        schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
                        await loadSharedSchedules(); 
                        
                        if (!user.isAnonymous) {
                            await loadAllAudioFiles();
                        } else {
                            userAudioFiles = [];
                            await loadAllAudioFiles(); // Load only shared files
                            renderAudioFileManager();
                            updateSoundDropdowns();
                        }
                        
                        if (isAudioReady) {
                            statusElement.textContent = "Connected. Monitoring bells...";
                        } else {
                            statusElement.textContent = "Connected. Click to start audio.";
                        }

                     } else {
                        console.log("User is signed out.");
                        userId = null;
                        isUserAnonymous = true;
                        
                        if (clockIntervalId) {
                            clearInterval(clockIntervalId);
                            clockIntervalId = null;
                        }

                        if (personalSchedulesListenerUnsubscribe) {
                            personalSchedulesListenerUnsubscribe();
                            personalSchedulesListenerUnsubscribe = null;
                        }
                        
                        document.body.classList.remove('authenticated', 'not-anonymous', 'admin-mode');
                        signOutBtn.classList.add('hidden');
                        userIdElement.textContent = "Not signed in.";
                        userDisplayNameElement.textContent = ""; 
                        adminToggleBtn.disabled = true;
                        adminToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        adminToggleBtn.title = "Sign in to see admin options";
                        
                        baseSchedule = null;
                        personalSchedule = null;
                        allSchedules = [];
                        allPersonalSchedules = [];
                        renderScheduleSelector();
                        renderCombinedList();
                        statusElement.textContent = "Please sign in to load schedules.";
                        
                        clockElement.textContent = `Please sign in`;
                        countdownElement.textContent = "--:--";
                        nextBellElement.textContent = `to load the schedule.`;
                       
                        welcomeOverlay.classList.remove('hidden');
                        audioOverlay.classList.add('hidden');
                        startAudioBtn.disabled = true; // Disable on sign-out
                     }
                 });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                statusElement.textContent = "Error connecting to Firebase.";
            }
        }
        
        function listenForPersonalSchedules(userId) {
            if (isUserAnonymous || !userId) {
                allPersonalSchedules = [];
                renderScheduleSelector();
                return;
            }

            if (personalSchedulesListenerUnsubscribe) {
                personalSchedulesListenerUnsubscribe();
            }

            const personalSchedulesRef = collection(db, 'artifacts', appId, 'users', userId, 'personal_schedules');
            
            console.log("Listening for real-time personal schedule updates...");
            
            personalSchedulesListenerUnsubscribe = onSnapshot(personalSchedulesRef, (querySnapshot) => {
                allPersonalSchedules = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data() 
                }));
                allPersonalSchedules.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log("Personal schedules updated from snapshot:", allPersonalSchedules.length);
                
                const currentSelectedValue = scheduleSelector.value;
                const activeScheduleExists = allPersonalSchedules.some(s => `personal-${s.id}` === currentSelectedValue);

                renderScheduleSelector(); 
                
                if (currentSelectedValue.startsWith('personal-') && activeScheduleExists) {
                    scheduleSelector.value = currentSelectedValue;
                } else if (!currentSelectedValue.startsWith('personal-')) {
                    // Do nothing
                } else {
                    console.log("Active personal schedule was deleted. Reverting to default.");
                }

            }, (error) => {
                console.error("Error listening to personal schedules: ", error);
            });
        }

        async function loadSharedSchedules() {
            if (!schedulesCollectionRef) {
                 schedulesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
            }

            try {
                const querySnapshot = await getDocs(schedulesCollectionRef);
                // MODIFIED v4.00: We don't migrate here. Migration happens in onSnapshot.
                // We just store the raw data for the selector.
                allSchedules = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data() 
                }));
                allSchedules.sort((a, b) => (a.name || "Z").localeCompare(b.name || "Z"));
                console.log("Loaded all shared schedules:", allSchedules.length);
                renderScheduleSelector();
            } catch (error) {
                console.error("Error loading all shared schedules: ", error);
                statusElement.textContent = "Error loading schedules.";
            }
        }

        // MODIFIED v4.00: Complete rewrite to handle personal/shared and new state
        function setActiveSchedule(prefixedId) {
            // Unsubscribe from *both* listeners
            if (activeScheduleListenerUnsubscribe) {
                activeScheduleListenerUnsubscribe();
                activeScheduleListenerUnsubscribe = null;
            }
            if (activePersonalScheduleListenerUnsubscribe) {
                activePersonalScheduleListenerUnsubscribe();
                activePersonalScheduleListenerUnsubscribe = null;
            }

            // Reset state
            baseSchedule = null;
            personalSchedule = null;
            activeBaseScheduleId = null;
            activePersonalScheduleId = null;
            
            // Disable manager buttons
            renamePersonalScheduleBtn.disabled = true;
            backupPersonalScheduleBtn.disabled = true;
            restorePersonalScheduleBtn.disabled = true;

            // Disable personal schedule buttons
            createPersonalScheduleBtn.disabled = true;
            createPersonalScheduleBtn.textContent = 'Copy as Personal Schedule';
            deletePersonalScheduleBtn.disabled = true;
            deletePersonalScheduleBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Disable admin forms
            addPeriodForm.querySelector('button[type="submit"]').disabled = true;
            personalPeriodNameInput.disabled = true;
            addPersonalPeriodForm.querySelector('button[type="submit"]').disabled = true;
            personalBellStatus.textContent = "Select a personal schedule to add periods/bells.";

            if (!prefixedId) {
                console.warn("No schedule ID provided.");
                scheduleTitle.textContent = "No Schedule Selected";
                renderCombinedList();
                updatePeriodDropdowns();
                return;
            }

            localStorage.setItem('activeScheduleId', prefixedId);
            const [type, scheduleId] = prefixedId.split('-');

            if (type === 'shared') {
                console.log("Setting active SHARED schedule:", scheduleId);
                activeBaseScheduleId = scheduleId;
                activePersonalScheduleId = null; // Ensure personal is null

                const scheduleData = allSchedules.find(s => s.id === scheduleId);
                if (scheduleData) {
                    scheduleTitle.textContent = scheduleData.name;
                    // Enable copy button
                    createPersonalScheduleBtn.disabled = false;
                    createPersonalScheduleBtn.textContent = 'Copy as Personal Schedule';
                    personalBaseScheduleName.textContent = scheduleData.name;
                    // Enable admin add period
                    if (document.body.classList.contains('admin-mode')) {
                        addPeriodForm.querySelector('button[type="submit"]').disabled = false;
                    }
                }

                scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleId);
                activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const migratedData = migrateScheduleData(docSnap.data());
                        baseSchedule = { id: scheduleId, ...migratedData };
                        
                        if (activePersonalScheduleId === null) {
                            scheduleTitle.textContent = baseSchedule.name;
                        }
                        console.log("Active shared schedule updated.");
                    } else {
                        console.warn("Selected shared schedule does not exist.");
                        baseSchedule = { id: scheduleId, name: "Schedule Not Found", periods: [] };
                        scheduleTitle.textContent = "Schedule Not Found";
                    }
                    renderCombinedList();
                    updatePeriodDropdowns();
                }, (error) => {
                    console.error("Error on shared schedule snapshot:", error);
                });

            } else if (type === 'personal') {
                console.log("Setting active PERSONAL schedule:", scheduleId);
                activePersonalScheduleId = scheduleId;
                
                const personalScheduleData = allPersonalSchedules.find(s => s.id === scheduleId);
                if (!personalScheduleData) {
                    console.error("Could not find personal schedule data.");
                    return;
                }

                activeBaseScheduleId = personalScheduleData.baseScheduleId;
                scheduleTitle.textContent = personalScheduleData.name;
                
                // Enable personal forms
                personalPeriodNameInput.disabled = false;
                addPersonalPeriodForm.querySelector('button[type="submit"]').disabled = false;
                personalBellStatus.textContent = `Adding bells to: ${personalScheduleData.name}`;
                deletePersonalScheduleBtn.disabled = false;
                deletePersonalScheduleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                createPersonalScheduleBtn.disabled = false;
                createPersonalScheduleBtn.textContent = 'Duplicate as Another Personal Schedule';
                
                renamePersonalScheduleBtn.disabled = false;
                backupPersonalScheduleBtn.disabled = false;
                restorePersonalScheduleBtn.disabled = false;
                
                // 1. Listen to the BASE shared schedule
                scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', activeBaseScheduleId);
                activeScheduleListenerUnsubscribe = onSnapshot(scheduleRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const migratedData = migrateScheduleData(docSnap.data());
                        baseSchedule = { id: activeBaseScheduleId, ...migratedData };
                        console.log("Base schedule for personal schedule updated.");
                    } else {
                        console.warn("Base schedule does not exist.");
                        baseSchedule = { id: activeBaseScheduleId, name: "Base Schedule Not Found", periods: [] };
                    }
                    renderCombinedList();
                    updatePeriodDropdowns();
                });
                
                // 2. Listen to the PERSONAL schedule
                const personalScheduleRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', activePersonalScheduleId);
                activePersonalScheduleListenerUnsubscribe = onSnapshot(personalScheduleRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const migratedData = migrateScheduleData(docSnap.data());
                        personalSchedule = { id: activePersonalScheduleId, ...migratedData };
                        console.log("Personal schedule bells updated.");
                    } else {
                        console.warn("Personal schedule removed.");
                        personalSchedule = { id: activePersonalScheduleId, name: "Not Found", periods: [] };
                        // TODO: Handle if the personal schedule is deleted out from under us
                    }
                    renderCombinedList();
                    updatePeriodDropdowns();
                });
            }
        }


        async function handleCreateSchedule(e) {
            e.preventDefault();
            const name = newScheduleNameInput.value.trim();
            if (!name) return;
            
            try {
                // NEW v4.00: Save with empty periods array
                const newDocRef = await addDoc(schedulesCollectionRef, {
                    name: name,
                    periods: [] // v4.00 structure
                });
                
                console.log("Schedule created with ID:", newDocRef.id);
                newScheduleNameInput.value = '';
                await loadSharedSchedules(); 
                
                scheduleSelector.value = `shared-${newDocRef.id}`;
                setActiveSchedule(scheduleSelector.value);
                
            } catch (error) {
                console.error("Error creating schedule:", error);
            }
        }
        
        // DELETED v4.00: findAllNearbySharedBells (complex conflict logic)
        
        // MODIFIED v4.00: Was handleAddSharedBell, now handleAddBellToPeriod
        async function handleAddBellToPeriod(e) {
            e.preventDefault();
            const periodId = sharedPeriodSelect.value;
            
            if (!activeBaseScheduleId || !scheduleRef || !periodId) {
                addSharedStatus.textContent = "Please select a schedule and period first.";
                addSharedStatus.classList.remove('hidden');
                setTimeout(() => addSharedStatus.classList.add('hidden'), 3000);
                return;
            }
            
            const time = sharedTimeInput.value;
            const name = sharedNameInput.value;
            const sound = sharedSoundInput.value;
            
            if (!time || !name) {
                addSharedStatus.textContent = "Please provide a time and name.";
                addSharedStatus.classList.remove('hidden');
                setTimeout(() => addSharedStatus.classList.add('hidden'), 3000);
                return;
            }

            const newBell = { time, name, sound };
            
            if (!baseSchedule) {
                console.warn("Could not find current schedule data.");
                return;
            }
            
            const period = baseSchedule.periods.find(p => p.id === periodId);
            if (!period) {
                 console.warn("Could not find period data.");
                return;
            }

            // Check for *exact* duplicate first
            if (period.bells.find(b => b.time === time && b.name === name)) {
                addSharedStatus.textContent = "This exact bell already exists in this period.";
                addSharedStatus.classList.remove('hidden');
                setTimeout(() => addSharedStatus.classList.add('hidden'), 3000);
                return;
            }
            
            // NEW v4.00: Simplified conflict check (within this period only)
            const nearbyBell = findNearbyBell(time, period.bells);
            if (nearbyBell) {
                pendingBell = { bell: newBell, periodId, periodType: 'shared' };
                nearbyBellName.textContent = nearbyBell.name;
                nearbyBellTime.textContent = formatTime12Hour(nearbyBell.time);
                nearbyBellCustomControls.style.display = 'flex';
                nearbyBellModal.classList.remove('hidden');
                return; // Stop.
            }

            // --- Case A: No Conflict ---
            console.log("Case A: No conflict found. Adding bell directly.");
            
            try {
                const updatedPeriods = baseSchedule.periods.map(p => {
                    if (p.id === periodId) {
                        return { ...p, bells: [...p.bells, newBell] };
                    }
                    return p;
                });
                
                await updateDoc(scheduleRef, { periods: updatedPeriods });
                
                console.log("Shared bell added.");
                addBellToPeriodForm.reset();
                sharedSoundInput.value = 'ellisBell.mp3'; 
                addSharedStatus.textContent = `Bell "${name}" added to ${period.name}.`;
                addSharedStatus.classList.remove('hidden');
                setTimeout(() => addSharedStatus.classList.add('hidden'), 3000);
                
            } catch (error) {
                console.error("Error adding shared bell:", error);
                addSharedStatus.textContent = "Error adding bell.";
                addSharedStatus.classList.remove('hidden');
            }
        }
        
        // DELETED v4.00: addPendingBellToCurrentSchedule (replaced by addPendingBell)
        // DELETED v4.00: closeAllConflictModals
        // DELETED v4.00: handleExternalConflictResolution
        // DELETED v4.00: handleExternalConflictCheckboxChange

        async function handleDeleteSchedule() {
            const scheduleIdToDelete = activeBaseScheduleId;
            if (!scheduleIdToDelete) {
                console.warn("No active shared schedule to delete.");
                return;
            }
            
            const scheduleName = allSchedules.find(s => s.id === scheduleIdToDelete)?.name;
            if (!scheduleName) {
                console.warn("Could not find schedule name to delete.");
                return;
            }
            
            confirmDeleteText.textContent = `Are you sure you want to delete "${scheduleName}"? This cannot be undone.`;
            confirmDeleteModal.classList.remove('hidden');
        }
        
        async function confirmDeleteSchedule() {
            if (!activeBaseScheduleId) return;
            
            const scheduleIdToDelete = activeBaseScheduleId;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', scheduleIdToDelete);

            try {
                await deleteDoc(docRef);
                console.log("Schedule deleted:", scheduleIdToDelete);
                activeBaseScheduleId = null;
                baseSchedule = null;
                await loadSharedSchedules(); 
            } catch (error) {
                console.error("Error deleting schedule:", error);
            }
            
            confirmDeleteModal.classList.add('hidden');
        }

        // --- Event Delegation for Bell List ---
        function handleBellListClick(e) {
            const target = e.target;
            
            // Check for Bell Mute
            if (target.classList.contains('bell-mute-toggle')) {
                const bellId = target.dataset.bellId;
                if (!bellId) return;
                
                if (target.checked) {
                    mutedBellIds.add(bellId);
                } else {
                    mutedBellIds.delete(bellId);
                }
                saveMutedBells();
                updateClock(); 
                return; 
            }
            
            // Check for Period Admin buttons
            if (target.classList.contains('edit-period-btn')) {
                currentEditingPeriod = {
                    id: target.dataset.periodId,
                    name: target.dataset.periodName,
                    type: target.dataset.periodType
                };
                editPeriodNameInput.value = currentEditingPeriod.name;
                editPeriodModal.classList.remove('hidden');
                return;
            }
            
            if (target.classList.contains('delete-period-btn')) {
                periodToDelete = {
                    id: target.dataset.periodId,
                    name: target.dataset.periodName,
                    type: target.dataset.periodType
                };
                confirmDeletePeriodText.textContent = `Are you sure you want to delete the period "${periodToDelete.name}"? This will also delete all bells inside it.`;
                confirmDeletePeriodModal.classList.remove('hidden');
                return;
            }

            // Check for Bell Admin buttons
            const bellElement = target.closest('[data-time]');
            if (!bellElement) return;

            // MODIFIED v4.00: Get bell data from attributes
            const bell = {
                time: bellElement.dataset.time,
                name: bellElement.dataset.name,
                sound: bellElement.dataset.sound, // This is the *display* sound
                type: bellElement.dataset.type,
                originalSound: bellElement.dataset.originalSound,
                periodId: bellElement.dataset.periodId,
                periodType: bellElement.dataset.periodType
            };

            if (target.classList.contains('delete-btn') || target.classList.contains('delete-custom-btn')) {
                handleDeleteBellClick(bell);
            } else if (target.classList.contains('edit-btn') || target.classList.contains('edit-custom-btn')) {
                handleEditBellClick(bell);
            } else if (target.classList.contains('sound-btn')) {
                openChangeSoundModal(bell);
            }
        }

        function handleDeleteBellClick(bell) {
            bellToDelete = bell; // Store the whole bell object
            confirmDeleteBellText.textContent = `Are you sure you want to delete the bell "${bell.name}" at ${formatTime12Hour(bell.time)}?`;
            confirmDeleteBellModal.classList.remove('hidden');
        }
        
        async function confirmDeleteBell() {
            if (!bellToDelete) return;
            
            const { time, name, type, periodId, periodType } = bellToDelete;
            
            const bellId = getBellId(bellToDelete);
            if (mutedBellIds.has(bellId)) {
                mutedBellIds.delete(bellId);
                saveMutedBells();
            }
            
            if (type === 'shared') {
                 const overrideKey = getBellOverrideKey(baseSchedule.id, bellToDelete);
                if (overrideKey && bellSoundOverrides[overrideKey]) {
                    delete bellSoundOverrides[overrideKey];
                    saveSoundOverrides();
                }
            }
            
            try {
                let scheduleRef;
                let currentSchedule;

                if (periodType === 'custom') {
                    if (!activePersonalScheduleId) throw new Error("No active personal schedule.");
                    scheduleRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', activePersonalScheduleId);
                    currentSchedule = personalSchedule;
                } else {
                    if (!activeBaseScheduleId) throw new Error("No active base schedule.");
                    scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', activeBaseScheduleId);
                    currentSchedule = baseSchedule;
                }

                if (!currentSchedule) throw new Error("Could not find schedule data.");

                const updatedPeriods = currentSchedule.periods.map(p => {
                    if (p.id === periodId) {
                        const updatedBells = (p.bells || []).filter(b => !(b.time === time && b.name === name));
                        return { ...p, bells: updatedBells };
                    }
                    return p;
                });

                await updateDoc(scheduleRef, { periods: updatedPeriods });
                console.log("Bell deleted.");
                
            } catch (error) {
                console.error("Error deleting bell:", error);
            }
            
            confirmDeleteBellModal.classList.add('hidden');
            bellToDelete = null;
        }
        
        // --- Edit Bell Logic ---
        function handleEditBellClick(bell) {
            currentEditingBell = { 
                ...bell, 
                originalTime: bell.time, 
                originalName: bell.name
            };
            
            editBellTimeInput.value = bell.time;
            editBellNameInput.value = bell.name;
            
            // MODIFIED v4.01: When editing, we must show the *true* sound, not the display sound
            // If it's a shared bell, it's the originalSound.
            // If it's a custom bell, it's the originalSound (which is just its sound).
            editBellSoundInput.value = bell.originalSound; 
            
            editBellModal.classList.remove('hidden');
        }

        async function handleEditBellSubmit(e) {
            e.preventDefault();
            if (!currentEditingBell) return;

            const newBellData = {
                time: editBellTimeInput.value,
                name: editBellNameInput.value,
                sound: editBellSoundInput.value
            };
            
            const { originalTime, originalName, periodId, periodType, type } = currentEditingBell;

            // v4.01: This logic is now simpler. newBellData.sound is the new *base* sound.
            // Any overrides are handled separately by the 'Change Sound' button.
            
            let scheduleRef;
            let currentSchedule;
            
            if (periodType === 'custom') {
                if (!activePersonalScheduleId) return;
                scheduleRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', activePersonalScheduleId);
                currentSchedule = personalSchedule;
            } else {
                if (!activeBaseScheduleId) return;
                scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', activeBaseScheduleId);
                currentSchedule = baseSchedule;
            }
            
            if (!currentSchedule) {
                console.error("Could not find schedule to update.");
                return;
            }
            
            const period = currentSchedule.periods.find(p => p.id === periodId);
            if (!period) {
                console.error("Could not find period to update.");
                return;
            }

            // Simplified Conflict Check (within period)
            const excludeBell = { time: originalTime, name: originalName };
            const nearbyBell = findNearbyBell(newBellData.time, period.bells, excludeBell);

            if (nearbyBell && !(newBellData.time === excludeBell.time && newBellData.name === excludeBell.name)) {
                // Store pending bell
                pendingBell = { 
                    bell: newBellData, // The new data
                    originalBell: excludeBell, // The bell to replace
                    periodId, 
                    periodType,
                    isEdit: true // Flag that this is an edit
                };
                nearbyBellName.textContent = nearbyBell.name;
                nearbyBellTime.textContent = formatTime12Hour(nearbyBell.time);
                // MODIFIED v4.01: Re-purpose the "Add Anyway" button
                nearbyBellAddAnywayBtn.textContent = "Save Anyway";
                nearbyBellCustomControls.style.display = 'flex';
                nearbyBellModal.classList.remove('hidden');
                
                // STOP execution. User must confirm via modal.
                return; 
            }
            
            // Proceed with the save if no conflict
            await savePendingEdit(newBellData, excludeBell, periodId, periodType, type);
            closeEditBellModal();
        }

        // --- NEW v4.01: Function to save an edit (called directly or from conflict modal)
        async function savePendingEdit(newBellData, originalBell, periodId, periodType, type) {
             try {
                let scheduleRef;
                let currentSchedule;
                
                if (periodType === 'custom') {
                    scheduleRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', activePersonalScheduleId);
                    currentSchedule = personalSchedule;
                } else {
                    scheduleRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', activeBaseScheduleId);
                    currentSchedule = baseSchedule;
                }

                const updatedPeriods = currentSchedule.periods.map(p => {
                    if (p.id === periodId) {
                        const updatedBells = p.bells.map(b => 
                            (b.time === originalBell.time && b.name === originalBell.name) ? newBellData : b
                        );
                        return { ...p, bells: updatedBells };
                    }
                    return p;
                });

                await updateDoc(scheduleRef, { periods: updatedPeriods });
                
                // Clear old mute state
                const oldBellId = getBellId({type, time: originalBell.time, name: originalBell.name});
                if (mutedBellIds.has(oldBellId)) {
                    mutedBellIds.delete(oldBellId);
                    saveMutedBells();
                }
                
                // If this was a shared bell, clear any old sound override
                if (type === 'shared') {
                    const overrideKey = getBellOverrideKey(baseSchedule.id, {type, time: originalBell.time, name: originalBell.name});
                    if (overrideKey && bellSoundOverrides[overrideKey]) {
                        delete bellSoundOverrides[overrideKey];
                        saveSoundOverrides();
                    }
                }

            } catch (error) {
                 console.error("Error updating bell:", error);
            }
        }


        // --- Change Sound Logic (All Users) ---
        function openChangeSoundModal(bell) {
            currentChangingSoundBell = bell;
            changeSoundBellName.textContent = bell.name;
            changeSoundBellTime.textContent = formatTime12Hour(bell.time);
            // MODIFIED v4.01: Show the *current* override, or the base sound
            changeSoundSelect.value = bell.sound; // The *display* sound is correct here
            changeSoundModal.classList.remove('hidden');
        }

        function handleChangeSoundSubmit(e) {
            e.preventDefault();
            if (!currentChangingSoundBell) return;

            const newSound = changeSoundSelect.value;
            const originalSound = currentChangingSoundBell.originalSound;
            const overrideKey = getBellOverrideKey(baseSchedule.id, currentChangingSoundBell);

            if (!overrideKey) {
                console.error("Could not generate override key.");
                return;
            }

            if (newSound === originalSound) {
                delete bellSoundOverrides[overrideKey];
                console.log("Removed sound override.");
            } else {
                bellSoundOverrides[overrideKey] = newSound;
                console.log("Set sound override:", newSound);
            }

            saveSoundOverrides();
            
            // Re-apply overrides to the in-memory baseSchedule
            if(baseSchedule) {
                 const migratedData = { ...baseSchedule }; // Don't re-migrate
                 // We just need to re-render. The findNextBell and renderCombinedList
                 // functions *already* apply overrides.
                 renderCombinedList();
            }
            
            closeChangeSoundModal();
        }
        
        function closeChangeSoundModal() {
            changeSoundModal.classList.add('hidden');
            currentChangingSoundBell = null;
        }

        // DELETED v4.00: All Linked Edit functions
        // (findLinkedSchedules, renderLinkedScheduleList, handleLinkedEdit, updateBellInSchedules)
        
        function closeEditBellModal() {
            editBellModal.classList.add('hidden');
            currentEditingBell = null;
            editBellForm.reset();
        }
        
        // DELETED v4.00: All Multi-Add Modal functions
        // (showMultiAddModal, handleMultiAddSubmit)


       // --- Auth Functions (Popup Flow) ---
       async function signInWithGoogle() {
           try {
                // MODIFIED v4.01: Removed await startAudio()
                if (!auth) await initFirebase();
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
           } catch (error) {
               console.error("Google Sign-In Error:", error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    statusElement.textContent = "Error signing in. Please try again.";
                }
           }
       }

       async function signInAnon() {
            try {
                // MODIFIED v4.01: Removed await startAudio()
                if (!auth) await initFirebase();
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous Sign-In Error:", error);
                statusElement.textContent = "Error signing in. Please try again.";
            }
       }

       async function signOutUser() {
           try {
               await signOut(auth);
           } catch (error) {
               console.error("Sign Out Error:", error);
           }
       }

        // --- Admin Mode ---
        function toggleAdminMode() {
            document.body.classList.toggle('admin-mode');
            if (document.body.classList.contains('admin-mode')) {
                adminToggleBtn.textContent = 'Exit Admin';
            } else {
                adminToggleBtn.textContent = 'Toggle Admin';
            }
            renderAudioFileManager();
            renderCombinedList(); 
            setActiveSchedule(scheduleSelector.value); // Re-check admin button states
        }
        
        // --- Import/Export Logic ---
        function handleExportSchedules() {
            // MODIFIED v4.00: Exports v4 data (with periods)
            if (allSchedules.length === 0) {
                console.warn("No schedules to export.");
                return;
            }
            const schedulesToExport = allSchedules.map(s => {
                // Ensure it's migrated before export
                const migrated = migrateScheduleData(s);
                return {
                    name: migrated.name,
                    periods: migrated.periods // Exporting v4 structure
                };
            });
            const data = {
                appId: appId,
                exportedAt: new Date().toISOString(),
                schedules: schedulesToExport
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `school-bell-schedules-v4-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImportSchedules() {
            importFileInput.click();
        }

        async function handleFileInputChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            importStatus.textContent = "Reading file...";
            importStatus.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.appId !== appId) {
                        throw new Error(`Invalid file: App ID mismatch. Expected '${appId}'.`);
                    }
                    if (!data.schedules || !Array.isArray(data.schedules)) {
                        throw new Error("Invalid file: 'schedules' array not found.");
                    }
                    importStatus.textContent = `Found ${data.schedules.length} schedules. Importing...`;
                    const batch = writeBatch(db);
                    let newCount = 0;
                    let updatedCount = 0;
                    for (const scheduleToImport of data.schedules) {
                        // Import will auto-migrate if 'bells' is present, or just use 'periods'
                        const { name, bells, periods } = scheduleToImport;
                        if (!name) continue;
                        
                        // We save the data as-is. If it's v3, it's v3. If v4, it's v4.
                        // Our app's migration logic will handle it on read.
                        const scheduleData = { name: name };
                        if (periods) {
                            scheduleData.periods = periods;
                        } else if (bells) {
                            scheduleData.bells = bells;
                        } else {
                            scheduleData.periods = []; // Default to v4 empty
                        }

                        const existingSchedule = allSchedules.find(s => s.name === name);
                        if (existingSchedule) {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', existingSchedule.id);
                            batch.set(docRef, scheduleData); // Use set to overwrite completely
                            updatedCount++;
                        } else {
                            const newDocRef = doc(collection(schedulesCollectionRef));
                            batch.set(newDocRef, scheduleData);
                            newCount++;
                        }
                    }
                    await batch.commit();
                    importStatus.textContent = `Import complete! Added: ${newCount}, Updated: ${updatedCount}.`;
                    await loadSharedSchedules();
                } catch (error) {
                    console.error("Import failed:", error);
                    importStatus.textContent = `Error: ${error.message}`;
                } finally {
                    importFileInput.value = ''; 
                }
            };
            reader.readAsText(file);
        }

        // --- Audio File Management (Unchanged) ---
        function handleFileSelected(e) {
            const file = e.target.files[0];
            if (!file) {
                audioFileName.textContent = "No file chosen.";
                audioUploadBtn.disabled = true;
                fileToUpload = null;
                return;
            }
            if (file.size > MAX_FILE_SIZE) {
                audioFileName.textContent = `File is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 1MB.`;
                audioFileName.classList.add('text-red-600');
                audioUploadBtn.disabled = true;
                fileToUpload = null;
                return;
            }
            fileToUpload = file;
            audioFileName.textContent = file.name;
            audioFileName.classList.remove('text-red-600');
            audioUploadBtn.disabled = false;
        }
        async function handleAudioUpload() {
            if (!fileToUpload || isUserAnonymous || !userId) {
                console.error("No file or user not logged in.");
                return;
            }
            audioUploadBtn.disabled = true;
            audioUploadStatus.textContent = `Uploading ${fileToUpload.name}...`;
            audioUploadStatus.classList.remove('hidden');
            try {
                const storageRef = ref(storage, `sounds/users/${userId}/${fileToUpload.name}`);
                const metadata = {
                    customMetadata: {
                        'owner': userId,
                        'ownerEmail': auth.currentUser.email || 'unknown'
                    }
                };
                await uploadBytes(storageRef, fileToUpload, metadata);
                audioUploadStatus.textContent = "Upload successful! Refreshing list...";
                fileToUpload = null;
                audioUploadInput.value = '';
                audioFileName.textContent = "No file chosen.";
                await loadAllAudioFiles(); 
                setTimeout(() => audioUploadStatus.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Audio upload failed:", error);
                audioUploadStatus.textContent = `Upload failed: ${error.message}`;
            } finally {
                audioUploadBtn.disabled = false;
            }
        }
        async function loadAllAudioFiles() {
            if (!isUserAnonymous && userId) {
                myAudioFilesList.innerHTML = '<p class="text-gray-500">Loading my sounds...</p>';
                const userFolderRef = ref(storage, `sounds/users/${userId}`);
                try {
                    const userFilesResult = await listAll(userFolderRef);
                    userAudioFiles = await Promise.all(userFilesResult.items.map(async (itemRef) => {
                        const url = await getDownloadURL(itemRef);
                        return { name: itemRef.name, url: url, path: itemRef.fullPath };
                    }));
                } catch (e) { 
                    console.error("Error loading user files:", e); 
                    userAudioFiles = [];
                }
            } else {
                userAudioFiles = [];
            }
            sharedAudioFilesList.innerHTML = '<p class="text-gray-500">Loading shared sounds...</p>';
            const publicFolderRef = ref(storage, 'sounds/public');
            try {
                const publicFilesResult = await listAll(publicFolderRef);
                sharedAudioFiles = await Promise.all(publicFilesResult.items.map(async (itemRef) => {
                    const url = await getDownloadURL(itemRef);
                    const meta = await getMetadata(itemRef);
                    const owner = meta.customMetadata?.ownerEmail || 'unknown';
                    return { name: itemRef.name, url: url, path: itemRef.fullPath, owner: owner };
                }));
            } catch (e) { 
                console.error("Error loading shared files:", e); 
                sharedAudioFiles = [];
            }
            renderAudioFileManager();
            updateSoundDropdowns();
        }
        function renderAudioFileManager() {
            if (userAudioFiles.length === 0) {
                myAudioFilesList.innerHTML = '<p class="text-gray-500">You have not uploaded any audio files.</p>';
            } else {
                myAudioFilesList.innerHTML = userAudioFiles.map(file => {
                    const isShared = sharedAudioFiles.some(sharedFile => sharedFile.name === file.name);
                    return `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center p-2 rounded-lg hover:bg-gray-100">
                        <span class="text-gray-800 truncate" title="${file.name}">${file.name}</span>
                        <div class="flex-shrink-0 flex items-center space-x-2 mt-2 sm:mt-0">
                            ${isShared ? 
                                '<span class="text-xs font-medium text-green-600 w-20 text-center">(Published)</span>' : 
                                `<button 
                                    class="make-public-btn admin-only text-xs px-2 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 w-20" 
                                    data-path="${file.path}" 
                                    data-name="${file.name}">
                                    Make Public
                                 </button>`
                            }
                            <button class="preview-audio-btn px-2 py-0 text-lg leading-none bg-gray-200 rounded-lg hover:bg-gray-300" data-url="${file.url}" aria-label="Play">&#9654;</button>
                            <button class="delete-audio-btn text-xs px-2 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600" data-path="${file.path}" data-url="${file.url}">Delete</button>
                        </div>
                    </div>
                    `;
                }).join('');
            }
            
            if (sharedAudioFiles.length === 0) {
                sharedAudioFilesList.innerHTML = '<p class="text-gray-500">No shared audio files are available.</p>';
            } else {
                sharedAudioFilesList.innerHTML = sharedAudioFiles.map(file => `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center p-2 rounded-lg hover:bg-gray-100">
                        <div>
                            <span class="text-gray-800 truncate" title="${file.name}">${file.name}</span>
                            <span class="text-xs text-gray-500 ml-2">(by ${file.owner})</span>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2 mt-2 sm:mt-0">
                            <button class="preview-audio-btn px-2 py-0 text-lg leading-none bg-gray-200 rounded-lg hover:bg-gray-300" data-url="${file.url}" aria-label="Play">&#9654;</button>
                            <button class="delete-audio-btn admin-only text-xs px-2 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600" data-path="${file.path}" data-url="${file.url}">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        function updateSoundDropdowns() {
            const selects = [
                { el: personalSoundInput, myGroup: 'personal-my-sounds-optgroup', sharedGroup: 'personal-shared-sounds-optgroup' },
                { el: sharedSoundInput, myGroup: 'shared-my-sounds-optgroup', sharedGroup: 'shared-shared-sounds-optgroup' },
                { el: editBellSoundInput, myGroup: 'edit-my-sounds-optgroup', sharedGroup: 'edit-shared-sounds-optgroup' },
                { el: changeSoundSelect, myGroup: 'change-my-sounds-optgroup', sharedGroup: 'change-shared-sounds-optgroup' },
                { el: quickBellSoundSelect, myGroup: 'quick-my-sounds-optgroup', sharedGroup: 'quick-shared-sounds-optgroup' }
            ];
            const mySoundsHtml = userAudioFiles.map(file => `<option value="${file.url}">${file.name}</option>`).join('');
            const sharedSoundsHtml = sharedAudioFiles.map(file => `<option value="${file.url}">${file.name}</option>`).join('');
            selects.forEach(item => {
                if (!item.el) return;
                const myGroup = item.el.querySelector(`#${item.myGroup}`);
                const sharedGroup = item.el.querySelector(`#${item.sharedGroup}`);
                if (myGroup) {
                    myGroup.innerHTML = mySoundsHtml;
                    myGroup.style.display = mySoundsHtml ? 'block' : 'none';
                }
                if (sharedGroup) {
                    sharedGroup.innerHTML = sharedSoundsHtml;
                    sharedGroup.style.display = sharedSoundsHtml ? 'block' : 'none';
                }
            });
        }
        function findBellsUsingSound(url) {
            let bells = [];
            // Check all shared schedules
            allSchedules.forEach(schedule => {
                const migrated = migrateScheduleData(schedule); // v4
                migrated.periods.forEach(p => {
                    p.bells.forEach(bell => {
                        if (bell.sound === url) {
                            bells.push(`"${bell.name}" in shared schedule "${schedule.name}"`);
                        }
                    });
                });
            });
            
            // Check all personal schedules
            allPersonalSchedules.forEach(schedule => {
                const migrated = migrateScheduleData(schedule); // v4
                migrated.periods.forEach(p => {
                    p.bells.forEach(bell => {
                        if (bell.sound === url) {
                            bells.push(`"${bell.name}" in your schedule "${schedule.name}"`);
                        }
                    });
                });
            });
            
            // Check sound overrides
            const overrideKeys = Object.keys(bellSoundOverrides);
            overrideKeys.forEach(key => {
                if (bellSoundOverrides[key] === url) {
                    bells.push(`a sound override for a shared bell.`);
                }
            });
            
            return [...new Set(bells)]; // Return unique descriptions
        }
        
        async function handleMakePublic() {
            const path = this.dataset.path;
            const name = this.dataset.name;
            if (!path || !name) return;
            
            this.textContent = "Copying...";
            this.disabled = true;
            
            try {
                const oldRef = ref(storage, path);
                const newRef = ref(storage, `sounds/public/${name}`);
                
                const bytes = await getBytes(oldRef);
                
                const oldMeta = await getMetadata(oldRef);
                const ownerEmail = oldMeta.customMetadata?.ownerEmail || auth.currentUser.email || 'unknown';

                const newMeta = {
                    customMetadata: {
                        'owner': auth.currentUser.uid,
                        'ownerEmail': ownerEmail
                    }
                };
                
                await uploadBytes(newRef, bytes, newMeta);
                
                console.log("File made public.");
                await loadAllAudioFiles(); 
                
            } catch (error) {
                console.error("Error making file public:", error);
                this.textContent = "Error";
                setTimeout(() => {
                    this.textContent = "Make Public";
                    this.disabled = false;
                }, 2000);
            }
        }
        
        function handleDeleteAudioClick() {
            const path = this.dataset.path;
            const url = this.dataset.url;
            if (!path) return;
            
            audioToDelete = { path, url };
            
            const bells = findBellsUsingSound(url);
            
            if (bells.length > 0) {
                confirmDeleteAudioText.textContent = `Are you sure you want to delete this file? It is currently being used by:`;
                confirmDeleteAudioList.innerHTML = bells.map(b => `<li class="text-sm text-gray-700">${b}</li>`).join('');
                deleteAudioConfirmBtn.textContent = "Delete Anyway";
            } else {
                confirmDeleteAudioText.textContent = `Are you sure you want to delete this audio file?`;
                confirmDeleteAudioList.innerHTML = `<li class="text-sm text-gray-500">This file is not currently in use by any of your loaded schedules.</li>`;
                deleteAudioConfirmBtn.textContent = "Delete";
            }
            
            confirmDeleteAudioModal.classList.remove('hidden');
        }
        
        async function confirmDeleteAudio() {
            if (!audioToDelete) return;
            const { path, url } = audioToDelete;
            
            try {
                const storageRef = ref(storage, path);
                await deleteObject(storageRef);
                
                console.log("Audio file deleted.");
                
                // Clear from cache
                if (synths[url]) {
                    try {
                        const player = await synths[url];
                        player.dispose();
                    } catch (e) { /* ignore */ }
                    delete synths[url];
                }
                
                // Find and clear any overrides using this
                const overrideKeys = Object.keys(bellSoundOverrides);
                let overridesChanged = false;
                overrideKeys.forEach(key => {
                    if (bellSoundOverrides[key] === url) {
                        delete bellSoundOverrides[key];
                        overridesChanged = true;
                    }
                });
                if (overridesChanged) {
                    saveSoundOverrides();
                    renderCombinedList(); // Re-render to show default sounds
                }
                
                await loadAllAudioFiles();
                
            } catch (error) {
                console.error("Error deleting audio file:", error);
            }
            
            confirmDeleteAudioModal.classList.add('hidden');
            audioToDelete = null;
        }


        // --- Personal Schedule Management (v3.03 / v3.05) ---
        function handleCreatePersonalSchedule() {
            if (!activeBaseScheduleId) {
                console.error("No base schedule selected to copy.");
                return;
            }
            createPersonalScheduleModal.classList.remove('hidden');
        }
        
        async function submitCreatePersonalSchedule(e) {
            e.preventDefault();
            const newName = newPersonalScheduleNameInput.value.trim();
            if (!newName || !activeBaseScheduleId || !baseSchedule) return;
            
            createPersonalScheduleStatus.textContent = "Creating...";
            createPersonalScheduleStatus.classList.remove('hidden');

            try {
                // v4.00: We copy the *migrated* v4 base schedule,
                // including its periods and bells.
                const newPersonalSchedule = {
                    name: newName,
                    baseScheduleId: activeBaseScheduleId,
                    periods: baseSchedule.periods.map(p => ({
                        id: crypto.randomUUID(), // New ID for the personal period
                        name: p.name,
                        bells: p.bells // Copy the bells
                    }))
                };

                const personalSchedulesRef = collection(db, 'artifacts', appId, 'users', userId, 'personal_schedules');
                const newDocRef = await addDoc(personalSchedulesRef, newPersonalSchedule);
                
                console.log("Personal schedule created:", newDocRef.id);
                
                // Don't call loadSharedSchedules, just update personal
                // The listener will pick it up
                
                setTimeout(() => {
                    createPersonalScheduleModal.classList.add('hidden');
                    createPersonalScheduleStatus.classList.add('hidden');
                    newPersonalScheduleNameInput.value = '';
                    
                    // Automatically switch to the new schedule
                    scheduleSelector.value = `personal-${newDocRef.id}`;
                    setActiveSchedule(scheduleSelector.value);
                }, 1000);
                
            } catch (error) {
                console.error("Error creating personal schedule:", error);
                createPersonalScheduleStatus.textContent = "Error. Please try again.";
            }
        }
        
        function handleDeletePersonalSchedule() {
            if (!activePersonalScheduleId) return;
            const scheduleName = allPersonalSchedules.find(s => s.id === activePersonalScheduleId)?.name;
            confirmDeletePersonalText.textContent = `Are you sure you want to delete "${scheduleName}"? This cannot be undone.`;
            confirmDeletePersonalModal.classList.remove('hidden');
        }
        
        async function confirmDeletePersonalSchedule() {
            if (!activePersonalScheduleId) return;
            
            const scheduleIdToDelete = activePersonalScheduleId;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'personal_schedules', scheduleIdToDelete);
            
            try {
                await deleteDoc(docRef);
                console.log("Personal schedule deleted:", scheduleIdToDelete);
                // Listener will update the list
                // We need to switch to a default
                const firstShared = allSchedules[0] ? `shared-${allSchedules[0].id}` : '';
